<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>갓통과 - 실전 모의고사</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }

        .omr-radio input:checked + span {
            background-color: #3730a3;
            color: white;
            border-color: #3730a3;
            font-weight: 800;
        }
        .omr-row:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden"> 

    <!-- 헤더 -->
    <header class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between shrink-0 h-12">
        <div class="flex items-center gap-3">
            <button onclick="safeNavigate('index.html')" class="text-gray-500 hover:text-gray-900">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <h1 class="font-bold text-gray-800 text-base">제1회 실전 모의고사</h1>
        </div>
        <div class="text-xs text-gray-500">
            <span class="hidden sm:inline">총 25문항 / </span><span id="answered-count" class="font-bold text-indigo-600">0</span>개 작성
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="flex-1 p-2 sm:p-4 flex items-center justify-center">
        <div class="bg-white w-full max-w-6xl h-full max-h-[90vh] border border-gray-300 shadow-lg rounded-lg flex flex-col">
            <div class="bg-indigo-900 text-white text-center py-1 text-sm font-bold shrink-0 rounded-t-lg">
                COMPUTERIZED O.M.R ANSWER SHEET (통합과학)
            </div>
            <div class="flex-1 p-2 sm:p-4 overflow-y-auto">
                <div id="omr-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-x-4 gap-y-1 sm:gap-y-3 h-full content-start">
                    <!-- JS 생성 -->
                </div>
            </div>
            <div class="p-3 border-t border-gray-200 bg-gray-50 shrink-0 rounded-b-lg text-center">
                <button onclick="submitAnswers()" class="w-full sm:w-auto bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-2 px-12 rounded shadow transition text-base flex items-center justify-center gap-2 mx-auto">
                    <i data-lucide="check-circle" class="w-4 h-4"></i> 답안 제출 및 성적 산출
                </button>
            </div>
        </div>
    </main>

    <!-- 로딩 오버레이 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-700 mb-3"></div>
            <p class="text-sm font-bold text-gray-800">채점 및 상대평가 분석 중...</p>
            <p class="text-xs text-gray-500 mt-1">전체 응시자 데이터와 비교하고 있습니다.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1",
            measurementId: "G-YVYHR5SJZL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ==========================================
        // [설정] 25점 만점 & 상대평가 기준
        // ==========================================
        const EXAM_ID = "exam_mock_01";
        const EXAM_TITLE = "2028 대비 실전 모의고사 1회";
        const TOTAL_QUESTIONS = 25;
        const SCORE_PER_QUESTION = 1;

        const CORRECT_ANSWERS = [
            1, 3, 2, 4, 5, 1, 2, 3, 4, 5,
            1, 2, 3, 4, 5, 1, 2, 3, 4, 5,
            1, 2, 3, 4, 5
        ]; 
        // ==========================================

        window.safeNavigate = function(url) {
            try { window.location.href = url; } 
            catch (e) { alert("메인 화면으로 이동합니다."); }
        };

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                alert("로그인이 필요합니다.");
                window.safeNavigate('index.html');
            }
        });

        // OMR UI 렌더링
        function renderOMR() {
            const grid = document.getElementById('omr-grid');
            grid.innerHTML = "";
            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                const row = document.createElement('div');
                row.className = "omr-row flex items-center justify-between px-2 py-1 sm:py-2 border-b border-gray-200 border-dashed";
                let optionsHtml = '';
                for (let opt = 1; opt <= 5; opt++) {
                    optionsHtml += `
                        <label class="omr-radio cursor-pointer relative block">
                            <input type="radio" name="q${i}" value="${opt}" class="peer sr-only" onchange="updateCount()">
                            <span class="w-6 h-5 sm:w-7 sm:h-6 flex items-center justify-center rounded-sm border border-gray-300 text-gray-400 bg-white hover:border-indigo-500 peer-checked:bg-indigo-800 peer-checked:text-white peer-checked:border-indigo-800 transition-all text-xs font-bold leading-none">${opt}</span>
                        </label>`;
                }
                row.innerHTML = `<span class="font-bold text-gray-800 w-5 text-sm mr-1 text-right">${i}.</span><div class="flex gap-1.5 sm:gap-2 justify-end">${optionsHtml}</div>`;
                grid.appendChild(row);
            }
        }

        window.updateCount = function() {
            const checked = document.querySelectorAll('input[type="radio"]:checked').length;
            document.getElementById('answered-count').innerText = checked;
        }

        // ==========================================
        // [핵심] 통계 및 등급 산출 함수들
        // ==========================================
        
        // 1. 정규분포 누적확률 계산 (Normal CDF Approximation)
        // Z-score를 넣으면 하위 몇 %인지(0.0 ~ 1.0)를 반환
        function getCumulativeProbability(z) {
            if (z < -6.5) return 0.0;
            if (z > 6.5) return 1.0;
            
            // Taylor series / constants approximation
            let k = 1 / (1 + 0.2316419 * Math.abs(z));
            let poly = k * (0.319381530 + k * (-0.356563782 + k * (1.781477937 + k * (-1.821255978 + 1.330274429 * k))));
            let approx = 1.0 - (1.0 / Math.sqrt(2 * Math.PI)) * Math.exp(-0.5 * z * z) * poly;
            
            return z < 0 ? 1.0 - approx : approx;
        }

        // 2. 등급 계산기 (상위 누적 % 기준)
        function calculateGrade(percentile) {
            // percentile: 내 밑에 몇 %가 있는가 (예: 96이면 상위 4%)
            // rankPercent: 상위 몇 %인가 (100 - percentile)
            const rankPercent = 100 - percentile;
            
            if (rankPercent <= 4) return 1;
            if (rankPercent <= 11) return 2;
            if (rankPercent <= 23) return 3;
            if (rankPercent <= 40) return 4;
            if (rankPercent <= 60) return 5;
            if (rankPercent <= 77) return 6;
            if (rankPercent <= 89) return 7;
            if (rankPercent <= 96) return 8;
            return 9;
        }

        window.submitAnswers = async function() {
            let unAnswered = [];
            for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                if (!document.querySelector(`input[name="q${i}"]:checked`)) unAnswered.push(i);
            }
            if (unAnswered.length > 0) {
                if(!confirm(`${unAnswered.join(', ')}번 문항을 풀지 않았습니다.\n제출하시겠습니까?`)) return;
            } else {
                if(!confirm("최종 제출하시겠습니까?\n전체 응시자 대비 등급이 산출됩니다.")) return;
            }

            const user = auth.currentUser;
            if(!user) return;
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                // A. 채점 (원점수 계산)
                let myAnswers = [];
                let rawScore = 0; // 원점수 (25점 만점)
                let correctList = [];

                for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
                    const selected = document.querySelector(`input[name="q${i}"]:checked`);
                    const val = selected ? parseInt(selected.value) : 0;
                    myAnswers.push(val);
                    const isCorrect = (val === CORRECT_ANSWERS[i-1]);
                    correctList.push(isCorrect);
                    if (isCorrect) rawScore += SCORE_PER_QUESTION;
                }

                // B. 데이터베이스 트랜잭션 (통계 업데이트 및 상대평가)
                const examRef = doc(db, "exams", EXAM_ID);
                const globalResultRef = doc(db, "exams", EXAM_ID, "results", user.uid);
                const myHistoryRef = doc(db, "users", user.uid, "exam_results", EXAM_ID);

                const result = await runTransaction(db, async (transaction) => {
                    const examDoc = await transaction.get(examRef);
                    
                    let count = 0;
                    let sum = 0;
                    let sumSq = 0; // 제곱의 합 (표준편차 계산용)

                    if (examDoc.exists()) {
                        const data = examDoc.data();
                        count = data.participantCount || 0;
                        sum = data.totalScoreSum || 0;
                        sumSq = data.totalScoreSqSum || 0;
                    }

                    // 1. 통계 데이터 갱신 (내 점수 포함)
                    const newCount = count + 1;
                    const newSum = sum + rawScore;
                    const newSumSq = sumSq + (rawScore * rawScore);
                    
                    // 2. 평균과 표준편차 계산
                    const mean = newSum / newCount;
                    // 분산 = E(X^2) - (E(X))^2
                    const variance = (newSumSq / newCount) - (mean * mean);
                    const stdDev = Math.sqrt(Math.max(0, variance)); // 음수 방지

                    // 3. 표준점수 및 백분위 산출
                    let zScore = 0;
                    if (stdDev > 0) {
                        zScore = (rawScore - mean) / stdDev;
                    } else {
                        // 첫 응시자거나 모두 점수가 같을 경우
                        zScore = 0; 
                    }

                    // 탐구영역 표준점수 공식 (평균 50, 표준편차 10)
                    const standardScore = Math.round(50 + (10 * zScore));
                    
                    // 백분위 (Cumulative Probability * 100)
                    // 예: 상위 4% -> percentile 96
                    const probability = getCumulativeProbability(zScore);
                    const percentile = Math.round(probability * 100);

                    // 등급 산출 (상대평가)
                    const grade = calculateGrade(percentile);

                    // 4. DB 저장
                    // 전체 통계 업데이트
                    transaction.set(examRef, { 
                        participantCount: newCount, 
                        totalScoreSum: newSum, 
                        totalScoreSqSum: newSumSq,
                        average: mean,
                        stdDev: stdDev
                    }, { merge: true });

                    // 내 결과 저장 (서버 기록용)
                    transaction.set(globalResultRef, { 
                        uid: user.uid, 
                        score: rawScore,
                        standardScore: standardScore,
                        percentile: percentile,
                        grade: grade,
                        answers: myAnswers, 
                        submittedAt: serverTimestamp() 
                    });

                    // 내 성적표 저장 (대시보드용)
                    transaction.set(myHistoryRef, {
                        examId: EXAM_ID,
                        title: EXAM_TITLE,
                        rawScore: rawScore,       // 원점수
                        standardScore: standardScore, // 표준점수
                        percentile: percentile,   // 백분위
                        grade: grade,             // 등급
                        score: standardScore,     // [중요] 그래프 그릴때 쓸 점수 (표준점수 추천)
                        myAnswers: myAnswers,
                        correctList: correctList,
                        submittedAt: serverTimestamp()
                    });

                    return { rawScore, standardScore, percentile, grade, mean };
                });

                document.getElementById('loading-overlay').classList.add('hidden');
                
                // 결과 알림 (수능형 성적표)
                const msg = `[${EXAM_TITLE} 채점 결과]\n\n` +
                          `등급: ${result.grade}등급\n` +
                          `표준점수: ${result.standardScore}\n` +
                          `백분위: ${result.percentile}\n` +
                          `------------------\n` +
                          `원점수: ${result.rawScore} / 25`;
                          
                alert(msg);
                window.safeNavigate('index.html');

            } catch (e) {
                console.error(e);
                document.getElementById('loading-overlay').classList.add('hidden');
                alert("채점 중 오류가 발생했습니다: " + e.message);
            }
        }

        renderOMR();
        lucide.createIcons();
    </script>
</body>
</html>