<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2028 통합과학 출제 도우미 Pro (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .sidebar-item.active { background-color: #e0e7ff; color: #4338ca; border-right: 3px solid #4338ca; font-weight: bold; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* PDF 캔버스 스타일 */
        #pdf-render-area canvas {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            width: 100%;
            height: auto;
        }

        /* 패널 전환 애니메이션 */
        #pdf-panel { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        #pdf-panel.closed { width: 0; opacity: 0; padding: 0; border: none; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">

    <!-- 1. 사이드바 -->
    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-30 shadow-lg shrink-0">
        <div class="p-6 bg-indigo-700 text-white shadow-md">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="book-open-check"></i> 출제 도우미
            </h1>
            <p class="text-xs text-indigo-200 mt-1">35개 내용 요소 & PDF 연동</p>
        </div>
        
        <div class="p-4 bg-indigo-50 border-b border-indigo-100">
            <label class="block text-xs font-bold text-indigo-800 mb-2 flex items-center gap-1">
                <i data-lucide="file-up" class="w-3 h-3"></i> 교재 PDF 불러오기
            </label>
            <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer"/>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-4" id="sidebar-menu">
            <!-- 메뉴 JS 생성 -->
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <button onclick="resetData()" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-600 rounded-lg text-xs hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-colors flex items-center justify-center gap-2 shadow-sm">
                <i data-lucide="rotate-ccw" class="w-3 h-3"></i> 데이터 초기화
            </button>
        </div>
    </aside>

    <!-- 2. 메인 화면 -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- [왼쪽] 질문 관리 영역 -->
        <section class="flex-1 flex flex-col border-r border-gray-200 bg-white min-w-[400px] transition-all duration-300" id="question-panel">
            <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20 h-16">
                <div>
                    <h2 class="text-lg font-bold text-gray-800" id="header-title">단원 선택 대기</h2>
                    <p class="text-xs text-gray-500 mt-0.5" id="header-desc">질문 리스트를 관리합니다.</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="addQuestion()" id="add-btn" class="hidden bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition-all shadow-sm active:scale-95 flex items-center gap-1.5 text-xs font-bold">
                        <i data-lucide="plus" class="w-3 h-3"></i> 질문 추가
                    </button>
                    <button onclick="togglePDF()" class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-200 transition-all shadow-sm active:scale-95 flex items-center gap-1.5 text-xs font-bold border border-slate-200">
                        <span id="pdf-toggle-icon"><i data-lucide="book-open" class="w-3 h-3"></i></span> 
                        <span id="toggle-text">교재 닫기</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 bg-slate-50" id="question-container">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                    <i data-lucide="layout-list" class="w-12 h-12 mb-3"></i>
                    <p class="text-sm">왼쪽 메뉴에서 단원을 선택하세요.</p>
                </div>
            </div>
        </section>

        <!-- [오른쪽] PDF 뷰어 영역 -->
        <section id="pdf-panel" class="w-[50%] flex flex-col bg-gray-100 min-w-[400px] border-l border-gray-200 relative shadow-inner">
            <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20 h-16 shrink-0">
                <div class="flex items-center gap-2">
                    <span class="bg-red-100 text-red-600 p-1.5 rounded-md"><i data-lucide="file-text" class="w-4 h-4"></i></span>
                    <div>
                        <h2 class="text-sm font-bold text-gray-800">교재 뷰어</h2>
                        <p class="text-[10px] text-gray-500" id="pdf-status">파일이 업로드되지 않았습니다.</p>
                    </div>
                </div>
                <div id="page-controls" class="hidden flex items-center gap-2">
                     <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200" id="page-indicator">Page -</span>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 text-center relative bg-gray-200/50" id="pdf-container">
                <div id="pdf-placeholder" class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 absolute inset-0">
                    <i data-lucide="file-search" class="w-16 h-16 mb-4 text-gray-300"></i>
                    <p class="text-sm">PDF 파일을 불러오면<br>해당 단원의 페이지가 자동으로 펼쳐집니다.</p>
                </div>
                <div id="pdf-render-area" class="w-full max-w-3xl mx-auto"></div>
            </div>
        </section>

    </main>

    <script>
        // --- 1. 데이터 정의 (35개 주제 + PDF 페이지 매핑) ---
        const defaultData = {
            "0. 기초 및 첨단과학": {
                "기본량과 단위": { pdf: {s:32, e:45}, q: ["SI 기본 단위를 쓰고, 힘(N)의 차원을 유도하시오."] },
                "측정과 어림": { pdf: {s:46, e:52}, q: ["유효숫자의 사칙연산 규칙을 설명하시오."] },
                "정보와 신호": { pdf: {s:53, e:59}, q: ["아날로그 신호를 디지털로 변환하는 3단계를 서술하시오."] },
                "인공지능": { pdf: {s:244, e:250}, q: ["머신러닝의 지도학습과 비지도학습의 차이는?"] },
                "로봇": { pdf: {s:244, e:250}, q: ["로봇의 3대 구성 요소와 기능을 설명하시오."] },
                "과학 윤리": { pdf: {s:251, e:257}, q: ["연구 진실성을 위협하는 위조, 변조, 표절을 정의하시오."] },
                "감염병": { pdf: {s:234, e:243}, q: ["세균과 바이러스의 차이점을 비교하시오."] }
            },
            "1. 물질과 규칙성": {
                "원소의 생성": { pdf: {s:60, e:66}, q: ["빅뱅 후 헬륨 원자핵 생성 시기(3분)의 중요성을 서술하시오."] },
                "별의 진화": { pdf: {s:67, e:75}, q: ["태양 질량 별의 진화 과정을 단계별로 설명하시오."] },
                "원소의 주기성": { pdf: {s:76, e:82}, q: ["알칼리 금속의 반응성 경향을 전자 배치로 설명하시오."] },
                "이온 결합": { pdf: {s:83, e:90}, q: ["이온 결합 물질이 고체에서 전기가 통하지 않는 이유는?"] },
                "공유 결합": { pdf: {s:83, e:90}, q: ["공유 결합 물질의 녹는점이 비교적 낮은 이유를 서술하시오."] },
                "지각과 생명체": { pdf: {s:91, e:97}, q: ["규산염 사면체의 결합 구조가 복잡할수록 풍화에 강한 이유는?"] },
                "전기적 성질": { pdf: {s:98, e:104}, q: ["에너지 띠 이론으로 도체와 반도체를 비교하시오."] }
            },
            "2. 시스템과 상호작용": {
                "지구 시스템": { pdf: {s:105, e:112}, q: ["지구 시스템의 에너지원 3가지를 설명하시오."] },
                "판 구조론": { pdf: {s:113, e:119}, q: ["섭입형 경계에서 나타나는 지각 변동의 특징은?"] },
                "중력장 운동": { pdf: {s:120, e:129}, q: ["수평으로 던진 물체의 운동을 분해하여 설명하시오."] },
                "충돌과 안전": { pdf: {s:130, e:136}, q: ["충격량과 운동량 변화량의 관계를 서술하시오."] },
                "세포와 물질": { pdf: {s:137, e:143}, q: ["세포막을 통한 확산과 삼투의 차이점은?"] },
                "물질대사": { pdf: {s:137, e:143}, q: ["효소가 활성화 에너지에 미치는 영향을 그래프로 설명하시오."] },
                "유전자": { pdf: {s:144, e:150}, q: ["생명 중심 원리(전사, 번역) 과정을 서술하시오."] }
            },
            "3. 변화와 다양성": {
                "지질 시대": { pdf: {s:151, e:157}, q: ["표준 화석과 시상 화석의 조건을 비교하시오."] },
                "대멸종": { pdf: {s:151, e:157}, q: ["가장 큰 규모의 대멸종(3차)의 원인은?"] },
                "진화": { pdf: {s:158, e:166}, q: ["자연 선택에 의한 진화 과정을 서술하시오."] },
                "생물 다양성": { pdf: {s:158, e:166}, q: ["생물 다양성의 3가지 층위를 정의하시오."] },
                "산화 환원": { pdf: {s:167, e:174}, q: ["산화와 환원을 전자의 이동으로 정의하시오."] },
                "산과 염기": { pdf: {s:175, e:182}, q: ["산의 공통적인 성질(3가지 이상)을 서술하시오."] },
                "중화 반응": { pdf: {s:175, e:182}, q: ["중화점에서 온도가 가장 높은 이유는?"] },
                "에너지 출입": { pdf: {s:183, e:190}, q: ["발열 반응과 흡열 반응의 에너지 그래프를 비교하시오."] }
            },
            "4. 환경과 에너지": {
                "생태계 구성 요소": { pdf: {s:191, e:197}, q: ["먹이 그물의 복잡성과 생태계 평형의 관계는?"] },
                "생태계 평형": { pdf: {s:198, e:205}, q: ["먹이 그물의 복잡성과 생태계 평형의 관계는?"] },
                "대기와 해양": { pdf: {s:206, e:212}, q: ["엘니뇨 발생 시 동태평양의 기상 변화를 설명하시오."] },
                "지구 온난화": { pdf: {s:206, e:212}, q: ["온실 효과의 원리를 복사 에너지 파장으로 설명하시오."] },
                "핵융합": { pdf: {s:213, e:219}, q: ["핵융합 에너지의 근원인 질량 결손을 설명하시오."] },
                "발전과 송전": { pdf: {s:220, e:226}, q: ["전자기 유도 현상이란 무엇인가?"] },
                "에너지 효율": { pdf: {s:227, e:233}, q: ["열효율이 100%가 될 수 없는 이유를 설명하시오."] }
            }
        };

        let db = JSON.parse(localStorage.getItem('scienceExamDB_Final')) || defaultData;
        let pdfDoc = null;
        let currentCategory = null;
        let currentTopic = null;
        let isPdfVisible = true;

        // --- 2. UI 제어 ---
        function togglePDF() {
            const pdfPanel = document.getElementById('pdf-panel');
            const toggleText = document.getElementById('toggle-text');
            const iconContainer = document.getElementById('pdf-toggle-icon');

            isPdfVisible = !isPdfVisible;

            if (isPdfVisible) {
                pdfPanel.classList.remove('closed');
                toggleText.innerText = "교재 닫기";
                iconContainer.innerHTML = '<i data-lucide="book-open" class="w-3 h-3"></i>';
                if(pdfDoc && currentTopic) setTimeout(renderPDF, 300);
            } else {
                pdfPanel.classList.add('closed');
                toggleText.innerText = "교재 보기";
                iconContainer.innerHTML = '<i data-lucide="book" class="w-3 h-3"></i>';
            }
            lucide.createIcons();
        }

        // --- 3. PDF 로직 ---
        const pdfUpload = document.getElementById('pdf-upload');
        const pdfStatus = document.getElementById('pdf-status');
        const renderArea = document.getElementById('pdf-render-area');

        pdfUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') return alert('PDF 파일만 가능합니다.');

            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                pdfStatus.innerText = `로드 완료 (${pdfDoc.numPages}쪽)`;
                pdfStatus.classList.replace('text-gray-500', 'text-green-600');
                if (currentCategory && currentTopic) renderPDF();
            };
            reader.readAsArrayBuffer(file);
        });

        async function renderPDF() {
            if (!isPdfVisible) return;
            renderArea.innerHTML = '';
            document.querySelector('#pdf-container .opacity-60')?.remove(); 

            if (!pdfDoc) {
                renderArea.innerHTML = '<p class="text-gray-400 mt-10">PDF 파일을 먼저 불러와주세요.</p>';
                return;
            }

            const pageInfo = db[currentCategory][currentTopic].pdf;
            const startPage = pageInfo.s;
            const endPage = pageInfo.e;

            document.getElementById('page-indicator').innerText = `p.${startPage} ~ p.${endPage}`;
            document.getElementById('page-controls').classList.remove('hidden');

            for (let i = startPage; i <= endPage; i++) {
                if (i > pdfDoc.numPages) break;
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                renderArea.appendChild(canvas);

                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
            }
        }

        // --- 4. 질문 관리 ---
        function initSidebar() {
            const nav = document.getElementById('sidebar-menu');
            nav.innerHTML = '';
            Object.keys(db).forEach(category => {
                const details = document.createElement('details');
                details.open = true;
                const summary = document.createElement('summary');
                summary.className = "px-4 py-2 text-xs font-bold text-gray-500 cursor-pointer list-none flex justify-between bg-gray-50 rounded mb-1";
                summary.innerHTML = `${category} <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180"></i>`;
                
                const ul = document.createElement('ul');
                ul.className = "pl-2 border-l-2 border-indigo-100 ml-2 mb-2";
                Object.keys(db[category]).forEach(topic => {
                    const li = document.createElement('li');
                    li.className = "nav-item px-3 py-2 rounded text-sm text-gray-600 hover:bg-indigo-50 cursor-pointer";
                    li.innerText = topic;
                    li.onclick = () => selectTopic(category, topic, li);
                    ul.appendChild(li);
                });
                details.appendChild(summary);
                details.appendChild(ul);
                nav.appendChild(details);
            });
            lucide.createIcons();
        }

        function selectTopic(cat, topic, el) {
            currentCategory = cat;
            currentTopic = topic;
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-bold'));
            el.classList.add('bg-indigo-100', 'text-indigo-700', 'font-bold');
            
            document.getElementById('header-title').innerText = topic;
            document.getElementById('header-desc').innerText = `${cat} 핵심 질문`;
            document.getElementById('add-btn').classList.remove('hidden');
            
            renderQuestions();
            if (pdfDoc && isPdfVisible) renderPDF();
        }

        function renderQuestions() {
            const container = document.getElementById('question-container');
            container.innerHTML = '';
            db[currentCategory][currentTopic].q.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-lg shadow-sm mb-3 group border border-gray-200";
                card.innerHTML = `
                    <div class="flex gap-3">
                        <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold flex items-center justify-center mt-0.5">${idx+1}</span>
                        <div class="flex-1">
                            <p class="text-gray-800" id="view-${idx}">${q}</p>
                            <textarea id="edit-${idx}" class="hidden w-full p-2 border rounded text-sm">${q}</textarea>
                            <div class="hidden mt-2 flex justify-end gap-2" id="btns-${idx}">
                                <button onclick="renderQuestions()" class="px-2 py-1 text-xs bg-gray-100 rounded">취소</button>
                                <button onclick="saveEdit(${idx})" class="px-2 py-1 text-xs bg-indigo-600 text-white rounded">저장</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="toggleEdit(${idx})" class="text-gray-400 hover:text-blue-500"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="deleteQuestion(${idx})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        // CRUD
        function addQuestion() {
            const newQ = prompt("새 질문:");
            if(newQ) { db[currentCategory][currentTopic].q.push(newQ); saveDB(); renderQuestions(); }
        }
        function toggleEdit(idx) {
            document.getElementById(`view-${idx}`).classList.add('hidden');
            document.getElementById(`edit-${idx}`).classList.remove('hidden');
            document.getElementById(`btns-${idx}`).classList.remove('hidden');
        }
        function saveEdit(idx) {
            db[currentCategory][currentTopic].q[idx] = document.getElementById(`edit-${idx}`).value;
            saveDB(); renderQuestions();
        }
        function deleteQuestion(idx) {
            if(confirm("삭제?")) { db[currentCategory][currentTopic].q.splice(idx, 1); saveDB(); renderQuestions(); }
        }
        function saveDB() { localStorage.setItem('scienceExamDB_Final', JSON.stringify(db)); }
        function resetData() { 
            if(confirm("초기화?")) { localStorage.removeItem('scienceExamDB_Final'); location.reload(); } 
        }

        initSidebar();
    </script>
</body>
</html>