<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°“í†µê³¼ - ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ ì„¼í„°</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- [í•µì‹¬] PDF ì¡°ì‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .app-layout {
            max-width: 480px; margin: 0 auto; min-height: 100vh;
            background-color: #F9FAFB; position: relative;
            display: flex; flex-direction: column;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chart-container { position: relative; width: 100%; height: 250px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* New/Badge Styles */
        .badge-pulse { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring { 0% { transform: scale(.33); } 80%, 100% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="app-layout shadow-2xl overflow-hidden">
        
        <!-- [1] ê¸€ë¡œë²Œ ë¡œë”© í™”ë©´ -->
        <div id="global-loading" class="absolute inset-0 z-[100] bg-white flex flex-col items-center justify-center">
            <div class="spinner mb-4"></div>
            <p id="loading-text" class="text-sm text-gray-500 font-medium">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
        </div>

        <!-- [2] ì¸ì¦ ì»¨í…Œì´ë„ˆ (ê¸°ì¡´ ìœ ì§€) -->
        <div id="auth-container" class="hidden flex-1 flex flex-col bg-white fade-in z-50 absolute inset-0 overflow-y-auto no-scrollbar">
            <header class="bg-indigo-600 text-white rounded-b-[2rem] px-6 pt-8 pb-10 shadow-xl relative overflow-hidden shrink-0">
                <div class="absolute top-0 right-0 opacity-10 transform translate-x-1/4 -translate-y-1/4">
                     <i data-lucide="atom" class="w-48 h-48"></i>
                </div>
                <div class="relative z-10">
                    <div class="mb-2">
                        <span class="bg-indigo-500/50 border border-indigo-400/30 text-indigo-100 text-[10px] font-bold px-2 py-1 rounded-full backdrop-blur-sm">Premium Service</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <h1 class="text-2xl font-extrabold tracking-tight">ê°“í†µê³¼</h1>
                        <h2 class="text-lg font-bold text-indigo-200">ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ ì„¼í„°</h2>
                    </div>
                    <p class="text-indigo-100/80 text-xs mt-2 font-medium">ë¡œê·¸ì¸ í›„ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•´ë³´ì„¸ìš”.</p>
                </div>
            </header>

            <div class="flex-1 px-6 py-6 flex flex-col justify-center">
                <div id="login-view" class="fade-in w-full">
                    <form id="login-form" class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ì´ë©”ì¼</label>
                            <input type="email" id="login-email" class="w-full pl-4 pr-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none bg-gray-50 text-sm" placeholder="example@email.com" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="login-pw" class="w-full pl-4 pr-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none bg-gray-50 text-sm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 flex justify-center items-center gap-2 text-base">
                            ë¡œê·¸ì¸í•˜ê¸° <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <button onclick="toggleAuthMode('signup')" class="w-full py-3 border border-indigo-100 text-indigo-600 font-bold rounded-xl hover:bg-indigo-50 transition-colors text-sm">ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…</button>
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-100 text-center">
                        <button onclick="location.href='../index.html'" class="text-xs text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1 mx-auto py-2 px-4 rounded-full hover:bg-gray-100 transition">
                            <i data-lucide="arrow-left" class="w-3 h-3"></i> ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>

                <div id="signup-view" class="hidden fade-in w-full">
                    <form id="signup-form" class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ì´ë¦„</label>
                            <input type="text" id="signup-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-sm" placeholder="í™ê¸¸ë™" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ì´ë©”ì¼</label>
                            <input type="email" id="signup-email" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-sm" placeholder="example@email.com" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="signup-pw" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-sm" placeholder="6ì ì´ìƒ" minlength="6" required>
                        </div>
                        <button type="submit" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg mt-4 text-base">ê°€ì… ì™„ë£Œ</button>
                    </form>
                    <div class="text-center mt-4">
                        <button onclick="toggleAuthMode('login')" class="text-xs font-bold text-indigo-600 ml-1 hover:underline">ë¡œê·¸ì¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- [3] ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ -->
        <div id="app-content" class="hidden flex-1 flex flex-col min-h-screen pb-20 fade-in">
            <!-- ìƒë‹¨ í—¤ë” -->
            <div class="bg-white sticky top-0 z-30 border-b border-gray-100 shadow-sm">
                <div class="px-6 py-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-black text-gray-900 tracking-tight">ì‹¤ì „ ëª¨ì˜ê³ ì‚¬</h2>
                        <p class="text-[10px] text-gray-400 font-medium">ìˆ˜ëŠ¥ ì‹¤ì „ ê°ê° ì™„ë²½ ëŒ€ë¹„</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="user-badge" class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2.5 py-1 rounded-full border border-gray-200">GUEST</span>
                        <button onclick="logout()" class="text-[10px] text-gray-400 underline hover:text-gray-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
                <!-- íƒ­ ë©”ë‰´ -->
                <div class="flex px-6 space-x-6 overflow-x-auto no-scrollbar">
                    <button onclick="switchTab('all')" id="tab-all" class="pb-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 whitespace-nowrap transition-colors">ì ‘ìˆ˜/êµ¬ë§¤</button>
                    <button onclick="switchTab('my')" id="tab-my" class="pb-3 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 whitespace-nowrap transition-colors">ë‚´ ì‹œí—˜ì§€</button>
                    <button onclick="switchTab('report')" id="tab-report" class="pb-3 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 whitespace-nowrap transition-colors">ì„±ì  ë¦¬í¬íŠ¸</button>
                </div>
            </div>

            <div id="exam-content" class="p-6 space-y-4 flex-1 overflow-y-auto"></div>

            <nav class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center z-40 text-xs font-medium text-gray-400 shadow-[0_-4px_10px_rgba(0,0,0,0.02)]">
                <button onclick="location.href='../index.html'" class="nav-btn flex flex-col items-center gap-1 hover:text-gray-600 transition-colors">
                    <i data-lucide="home" class="w-6 h-6"></i><span>í™ˆ</span>
                </button>
                <button class="nav-btn flex flex-col items-center gap-1 text-indigo-600 transition-colors">
                    <i data-lucide="file-text" class="w-6 h-6"></i><span>ì‹œí—˜ì‘ì‹œ</span>
                </button>
                <button onclick="location.href='../Q-Bank/index.html'" class="nav-btn flex flex-col items-center gap-1 hover:text-gray-600 transition-colors">
                    <i data-lucide="brain-circuit" class="w-6 h-6"></i><span>ë¬¸ì œì€í–‰</span>
                </button>
                <button onclick="switchTab('report')" class="nav-btn flex flex-col items-center gap-1 hover:text-gray-600 transition-colors">
                    <i data-lucide="bar-chart-2" class="w-6 h-6"></i><span>ì„±ì ë¶„ì„</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- ê²°ì œ ëª¨ë‹¬ (ê¸°ì¡´ ìœ ì§€) -->
    <div id="paymentModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closePaymentModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white rounded-t-3xl p-6 transition-transform duration-300 transform translate-y-full shadow-2xl">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-8"></div>
            <h3 class="text-xl font-bold text-gray-900">ëª¨ì˜ê³ ì‚¬ êµ¬ë§¤í•˜ê¸°</h3>
            <p class="text-sm text-gray-500 mt-1 mb-6">ì…ê¸ˆ í™•ì¸ í›„ í•´ë‹¹ íšŒì°¨ì˜ ë‹¤ìš´ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            <div class="bg-gray-50 p-5 rounded-2xl mb-6 border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-gray-600 text-sm">ìƒí’ˆëª…</span>
                    <span class="font-bold text-gray-900" id="modalExamTitle">ëª¨ì˜ê³ ì‚¬</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm">ê²°ì œ ê¸ˆì•¡</span>
                    <span class="font-black text-xl text-indigo-600">5,000ì›</span>
                </div>
            </div>
            <div class="flex items-center space-x-3 p-4 border border-indigo-100 bg-indigo-50/50 rounded-xl mb-8">
                <div class="bg-white p-2 rounded-full shadow-sm"><i data-lucide="credit-card" class="w-5 h-5 text-indigo-600"></i></div>
                <div class="flex-1">
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">ì…ê¸ˆ ê³„ì¢Œ</p>
                    <p class="font-bold text-gray-800 text-lg">3333-01-0000000</p>
                </div>
                <button onclick="copyToClipboard('3333-01-0000000')" class="text-xs bg-white border border-indigo-100 px-3 py-1.5 rounded-lg font-bold text-indigo-600 hover:bg-indigo-50">ë³µì‚¬</button>
            </div>
            <button onclick="requestPurchase()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-black transition-transform active:scale-[0.98]">ì…ê¸ˆ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤ (ìŠ¹ì¸ ìš”ì²­)</button>
        </div>
    </div>

    <!-- ì„±ì  ì…ë ¥ ëª¨ë‹¬ (ê¸°ì¡´ ìœ ì§€) -->
    <div id="scoreModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeScoreModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-[360px] bg-white rounded-3xl p-8 shadow-2xl text-center">
            <h3 class="text-xl font-bold text-gray-900 mb-2">ì„±ì  ì…ë ¥</h3>
            <div class="relative inline-block mb-8">
                <input type="number" id="scoreInput" class="w-32 text-center text-5xl font-black border-b-4 border-indigo-100 focus:border-indigo-600 outline-none pb-2 text-indigo-600 placeholder-indigo-100 transition-colors" placeholder="0">
                <span class="absolute bottom-4 -right-6 text-gray-400 font-bold text-lg">ì </span>
            </div>
            <button onclick="submitScore()" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-transform active:scale-[0.98]">ì œì¶œí•˜ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserData = null;
        let masterExams = []; 
        let myExamData = {};  
        let latestRound = 0; 
        window.selectedExamId = null; 

        const SECURE_FILE_MAP = {
            'exam_01': 'k8s_x9d2_exam01.pdf',
            'exam_02': 'a7d_m4a1_exam02.pdf',
            'exam_03': 'z9p_q2w3_exam03.pdf',
        };

        function getSecureFileName(docId) { return SECURE_FILE_MAP[docId] || `${docId}.pdf`; }

        const loadingEl = document.getElementById('global-loading');
        const loadingText = document.getElementById('loading-text');

        onAuthStateChanged(auth, async (user) => {
            const authContainer = document.getElementById('auth-container');
            const appContent = document.getElementById('app-content');
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(userDoc.exists()) {
                        currentUserData = userDoc.data();
                        const emailId = user.email.split('@')[0];
                        document.getElementById('user-badge').innerText = emailId + "ë‹˜";
                    }
                    await loadData();
                } catch (e) {
                    console.error("ì´ˆê¸° ë¡œë”© ì¤‘ ì˜¤ë¥˜:", e);
                    // ì˜¤ë¥˜ê°€ ë‚˜ë„ íŠ•ê¸°ì§€ ì•Šê³  ë¹ˆ í™”ë©´ì´ë¼ë„ ë³´ì—¬ì¤Œ
                    document.getElementById('user-badge').innerText = "íšŒì›ë‹˜";
                }
            } else {
                currentUser = null;
                currentUserData = null;
                appContent.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
            loadingEl.classList.add('hidden');
            lucide.createIcons();
        });

        window.requestPurchase = async () => {
            if(!window.selectedExamId || !currentUser) return;
            const depositor = prompt("ì…ê¸ˆìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (í™•ì¸ìš©):", currentUserData ? currentUserData.name : "");
            if (!depositor) return; 

            loadingEl.classList.remove('hidden');
            loadingText.innerText = "ìŠ¹ì¸ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...";
            try {
                await setDoc(doc(db, "users", currentUser.uid, "my_exams", window.selectedExamId), {
                    status: 'pending', 
                    requestedAt: new Date().toISOString(),
                    depositor: depositor,
                    title: document.getElementById('modalExamTitle').innerText,
                    score: null
                }, { merge: true });

                const botToken = "8418122948:AAGLh95SYa2Dj0HPQvFOe3zlHAAHj18b9ow";
                const chatId = "7703628247";
                const msg = `ğŸ”” [ëª¨ì˜ê³ ì‚¬ êµ¬ë§¤ ìš”ì²­]\n\nì‹œí—˜: ${window.selectedExamId}\ní•™ìƒ: ${currentUserData ? currentUserData.name : "ì•Œìˆ˜ì—†ìŒ"} (${currentUser.email})\nì…ê¸ˆì: ${depositor}\n\nê´€ë¦¬ì ì½˜ì†”ì—ì„œ ìŠ¹ì¸í•´ì£¼ì„¸ìš”!`;
                await fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(msg)}`).catch(()=>console.log('í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨'));

                alert("ì…ê¸ˆ í™•ì¸ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„ ìƒë‹˜ í™•ì¸ í›„ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤!");
                closePaymentModal();
            } catch(e) { console.error(e); alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } finally { loadingEl.classList.add('hidden'); }
        };

        window.downloadExamPaper = async (docId, examTitle) => {
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            loadingEl.classList.remove('hidden');
            loadingText.innerText = "ë³´ì•ˆ ë¬¸ì„œ ìƒì„± ì¤‘...";
            try {
                const secureFileName = getSecureFileName(docId);
                const pdfUrl = `./exams/${secureFileName}`; 
                const pdfRes = await fetch(pdfUrl);
                if (!pdfRes.ok) throw new Error("PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const existingPdfBytes = await pdfRes.arrayBuffer();

                let customFont = null;
                let useFallback = false;
                const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;
                const pdfDoc = await PDFDocument.load(existingPdfBytes);

                try {
                    const fontUrl = `./fonts/watermark.ttf`; 
                    const fontRes = await fetch(fontUrl);
                    if (!fontRes.ok) throw new Error("í°íŠ¸ íŒŒì¼ ì—†ìŒ");
                    const fontBytes = await fontRes.arrayBuffer();
                    pdfDoc.registerFontkit(fontkit);
                    customFont = await pdfDoc.embedFont(fontBytes);
                } catch (fontErr) {
                    useFallback = true;
                    customFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                }

                const pages = pdfDoc.getPages();
                const { width, height } = pages[0].getSize();
                let watermarkText = currentUserData ? `${currentUserData.name} / ${currentUserData.email}` : currentUser.email;
                
                pages.forEach(page => {
                    page.drawText(watermarkText, {
                        x: width / 2 - 100, y: height / 2, size: 24, font: customFont,
                        color: rgb(0.8, 0.2, 0.2), opacity: 0.2, rotate: degrees(45),
                    });
                    page.drawText(`Licensed to: ${currentUser.uid}`, {
                        x: 20, y: 20, size: 9, font: customFont, color: rgb(0.5, 0.5, 0.5),
                    });
                });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${examTitle}_Secure.pdf`;
                link.click();
            } catch (e) { alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:\n" + e.message); } finally { loadingEl.classList.add('hidden'); }
        };

        window.toggleAuthMode = (mode) => {
            document.getElementById('login-view').classList.toggle('hidden', mode !== 'login');
            document.getElementById('signup-view').classList.toggle('hidden', mode !== 'signup');
        };

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pw = document.getElementById('login-pw').value;
            loadingEl.classList.remove('hidden');
            try { await signInWithEmailAndPassword(auth, email, pw); } 
            catch { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); loadingEl.classList.add('hidden'); }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pw = document.getElementById('signup-pw').value;
            loadingEl.classList.remove('hidden');
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pw);
                await setDoc(doc(db, "users", cred.user.uid), {
                    name: name, email: email, joinedAt: new Date().toISOString()
                });
                alert("ê°€ì… ì™„ë£Œ!");
            } catch (err) { alert("ê°€ì… ì‹¤íŒ¨: " + err.message); loadingEl.classList.add('hidden'); }
        });

        window.logout = () => { if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) signOut(auth); };

        async function loadData() {
            try {
                // 1. ì „ì²´ ì‹œí—˜ ëª©ë¡ (ê¸°ë³¸ ë°ì´í„°ë¼ ì‹¤íŒ¨í•  ì¼ ì ìŒ)
                const q = query(collection(db, "public_exams"), orderBy("id", "asc"));
                const snapshot = await getDocs(q);
                masterExams = [];
                snapshot.forEach(doc => masterExams.push(doc.data()));

                // 2. í˜„ì¬ ì‹œí–‰ íšŒì°¨ ì„¤ì • (ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’)
                try {
                    const settingsDoc = await getDoc(doc(db, "settings", "global"));
                    if(settingsDoc.exists()) {
                        latestRound = settingsDoc.data().latestRound || 0;
                    } else {
                        latestRound = 1;
                    }
                } catch(err) {
                    console.log("Settings fetch error, defaulting to 1");
                    latestRound = 1; 
                }

                // 3. ë‚´ ì‹œí—˜ ì •ë³´ (ì—¬ê¸°ê°€ í•µì‹¬! ì‚­ì œë˜ë©´ ë¹ˆ ê°’ìœ¼ë¡œ ì²˜ë¦¬)
                onSnapshot(collection(db, "users", currentUser.uid, "my_exams"), (snapshot) => {
                    myExamData = {}; // ì´ˆê¸°í™”
                    
                    if (!snapshot.empty) {
                        snapshot.forEach(doc => {
                            // ë¬¸ì„œê°€ ì¡´ì¬í•  ë•Œë§Œ ë°ì´í„° ì €ì¥
                            if (doc.exists()) {
                                myExamData[doc.id] = doc.data();
                            }
                        });
                    }
                    // ë°ì´í„°ê°€ ë¹„ì—ˆì–´ë„ ì •ìƒì ìœ¼ë¡œ í™”ë©´ ê°±ì‹  (ë¹ˆ ìƒíƒœë¡œ)
                    refreshCurrentTab();
                }, (error) => {
                    console.error("ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜ (ë¬´ì‹œí•¨):", error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ê±°ë‚˜ ë¹ˆ ìƒíƒœë¡œ ê°±ì‹ í•˜ì—¬ íŠ•ê¹€ ë°©ì§€
                    myExamData = {}; 
                    refreshCurrentTab();
                });
            } catch(e) { 
                console.error("LoadData Critical Error:", e);
                // ì¹˜ëª…ì  ì˜¤ë¥˜ë¼ë„ ë¡œê·¸ì¸ ìœ ì§€
            }
        }

        window.switchTab = (tab) => { window.currentTab = tab; refreshCurrentTab(); };
        window.currentTab = 'all';

        function refreshCurrentTab() {
            ['all', 'my', 'report'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(!el) return;
                el.className = t === window.currentTab 
                    ? "pb-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 whitespace-nowrap transition-colors"
                    : "pb-3 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 whitespace-nowrap transition-colors";
            });

            const contentDiv = document.getElementById('exam-content');
            if (window.currentTab === 'report') renderReport(contentDiv);
            else renderExamList(contentDiv, window.currentTab);
            lucide.createIcons();
        }

        function renderExamList(container, filterType) {
            let html = '';
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (Optional Chaining)
            const processedExams = masterExams.map(exam => {
                const docId = `exam_${String(exam.id).padStart(2,'0')}`;
                // myExamDataê°€ ì—†ê±°ë‚˜ í•´ë‹¹ docId í‚¤ê°€ ì—†ìœ¼ë©´ undefined ë°˜í™˜ -> ì•ˆì „
                const rec = myExamData ? myExamData[docId] : null;
                return { ...exam, status: rec ? rec.status : 'locked', score: rec?.score, docId };
            });

            if (filterType === 'my') {
                const myList = processedExams.filter(e => e.status !== 'locked').sort((a,b) => b.id - a.id);
                if (myList.length === 0) return container.innerHTML = `<div class="text-center py-20 text-gray-400">ë³´ìœ í•œ ì‹œí—˜ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                myList.forEach(exam => { html += createCard(exam, false); });
                container.innerHTML = html;
                return;
            }

            if (filterType === 'all') {
                const applicationRoundId = latestRound + 1;
                const nextExam = processedExams.find(e => e.id === applicationRoundId);

                if (nextExam) {
                    html += `
                        <div class="mb-8">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="relative flex h-3 w-3">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                                </span>
                                <h3 class="text-sm font-bold text-indigo-900">ì‹ ì²­ ì ‘ìˆ˜ ì¤‘</h3>
                            </div>
                            ${createCard(nextExam, true)}
                        </div>
                    `;
                }

                const pastExams = processedExams.filter(e => e.id <= latestRound).sort((a,b) => b.id - a.id);
                if (pastExams.length > 0) {
                    html += `<div class="mb-4"><h3 class="text-sm font-bold text-gray-800 mb-3">ì§€ë‚œ ëª¨ì˜ê³ ì‚¬ êµ¬ë§¤</h3>`;
                    pastExams.forEach(exam => {
                        html += createCard(exam, false);
                    });
                    html += `</div>`;
                }

                const futureExams = processedExams.filter(e => e.id > applicationRoundId).sort((a,b) => a.id - b.id).slice(0, 2);
                if (futureExams.length > 0) {
                     html += `
                        <div class="mt-8 pt-6 border-t border-gray-100">
                            <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-wider">ê³µê°œ ì˜ˆì •</h3>
                            <div class="space-y-3">
                     `;
                     futureExams.forEach(exam => {
                         html += `
                            <div class="bg-gray-50 rounded-xl p-4 flex justify-between items-center opacity-70">
                                <div>
                                    <span class="text-[10px] font-bold text-gray-400 block mb-0.5">${exam.subTitle || 'Coming Soon'}</span>
                                    <h4 class="text-sm font-bold text-gray-500">${exam.title}</h4>
                                </div>
                                <span class="text-xs font-medium text-gray-400 bg-white px-2 py-1 rounded border border-gray-100">ì˜¤í”ˆ ì˜ˆì •</span>
                            </div>
                         `;
                     });
                     html += `</div></div>`;
                }
                
                container.innerHTML = html;
            }
        }

        function createCard(exam, isFeatured) {
            const dateStr = new Date(exam.date).toLocaleDateString();
            let btn;
            
            if (exam.status === 'graded') {
                btn = `<div class="flex gap-2"><div class="flex-1 bg-emerald-50 text-emerald-700 py-3 rounded-xl text-center font-bold border border-emerald-100">${exam.score}ì </div><button onclick="switchTab('report')" class="w-14 bg-gray-50 border border-gray-200 rounded-xl flex items-center justify-center"><i data-lucide="bar-chart-2" class="w-5 h-5 text-gray-500"></i></button></div>`;
            } else if (exam.status === 'purchased') {
                btn = `<div class="flex gap-2"><button onclick="downloadExamPaper('${exam.docId}', '${exam.title}')" class="flex-1 bg-white border border-gray-200 text-gray-600 py-3 rounded-xl font-bold text-sm hover:bg-gray-50 flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> ì‹œí—˜ì§€</button><button onclick="location.href='omr.html?id=${exam.docId}&title=${encodeURIComponent(exam.title)}'" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-indigo-700 transition-colors">ì •ë‹µ ì œì¶œ</button></div>`;
            } else if (exam.status === 'pending') {
                btn = `<button disabled class="w-full py-3 bg-yellow-50 text-yellow-600 rounded-xl text-sm font-bold border border-yellow-100 flex items-center justify-center gap-2 cursor-wait"><div class="animate-spin rounded-full h-3 w-3 border-2 border-yellow-600 border-t-transparent"></div>ì„ ìƒë‹˜ í™•ì¸ ì¤‘... (ìŠ¹ì¸ ëŒ€ê¸°)</button>`;
            } else {
                const btnColor = isFeatured ? 'bg-indigo-600 hover:bg-indigo-700 text-white shadow-indigo-200 shadow-lg' : 'bg-gray-900 hover:bg-black text-white shadow';
                const btnText = isFeatured ? 'ì§€ê¸ˆ ë°”ë¡œ ì‹ ì²­í•˜ê¸°' : 'êµ¬ë§¤í•˜ê¸°';
                btn = `<button onclick="openPaymentModal('${exam.docId}', '${exam.title}', ${exam.price})" class="w-full py-3.5 rounded-xl text-sm font-bold flex justify-center items-center gap-2 active:scale-[0.98] transition-transform ${btnColor}"><i data-lucide="lock" class="w-3 h-3 opacity-70"></i> ${exam.price.toLocaleString()}ì› ${btnText}</button>`;
            }

            const style = isFeatured ? 'bg-white border-2 border-indigo-500 shadow-xl relative overflow-hidden' : 'bg-white border border-gray-100 shadow-sm';
            const bgDeco = isFeatured ? `<div class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>` : '';
            
            return `<div class="${style} rounded-2xl p-5 mb-4 relative">
                ${bgDeco}
                <div class="relative z-10 mb-4">
                    <span class="text-[10px] font-bold ${isFeatured ? 'text-indigo-600' : 'text-gray-400'} block mb-1 uppercase tracking-wide">${exam.subTitle}</span>
                    <h4 class="text-lg font-black text-gray-900 leading-tight">${exam.title}</h4>
                    ${isFeatured ? '<p class="text-xs text-indigo-500 mt-2 font-medium">ë§ˆê° ì„ë°• | ì„ ì°©ìˆœ í˜œíƒ ì ìš© ì¤‘</p>' : `<span class="text-xs text-gray-400 block mt-1">${dateStr} ì‹œí–‰</span>`}
                </div>
                <div class="relative z-10">${btn}</div>
            </div>`;
        }

        function renderReport(container) {
            // ë°ì´í„°ê°€ ì—†ì–´ë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (ë¹ˆ ë°°ì—´ ë°˜í™˜)
            const list = masterExams.map(e => {
                const rec = myExamData ? myExamData[`exam_${String(e.id).padStart(2,'0')}`] : null;
                return (rec && rec.status === 'graded') ? { ...e, score: rec.score } : null;
            }).filter(Boolean);
            
            if (list.length === 0) return container.innerHTML = `<div class="text-center py-20 text-gray-400">ì±„ì  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            
            const avg = Math.floor(list.reduce((a,b)=>a+b.score,0)/list.length);
            container.innerHTML = `
                <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm mb-4">
                    <h3 class="text-sm font-bold text-gray-900 mb-6">ëˆ„ì  ì„±ì  ë³€í™”</h3>
                    <div class="chart-container"><canvas id="scoreChart"></canvas></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100"><p class="text-[10px] text-indigo-400 font-bold uppercase mb-1">Total</p><p class="text-2xl font-black text-indigo-700">${list.length}<span class="text-sm font-medium ml-1">íšŒ</span></p></div>
                    <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100"><p class="text-[10px] text-emerald-500 font-bold uppercase mb-1">Avg</p><p class="text-2xl font-black text-emerald-700">${avg}<span class="text-sm font-medium ml-1">ì </span></p></div>
                </div>`;

            setTimeout(() => {
                new Chart(document.getElementById('scoreChart'), {
                    type: 'line',
                    data: { labels: list.map(e => `${e.id}íšŒ`), datasets: [{ label: 'ë‚´ ì ìˆ˜', data: list.map(e => e.score), borderColor: '#4F46E5', backgroundColor: 'rgba(79, 70, 229, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100 }, x: { display: false } }, plugins: { legend: { display: false } } }
                });
            }, 0);
        }

        window.openPaymentModal = (id, title) => { window.selectedExamId = id; document.getElementById('modalExamTitle').innerText = title; document.getElementById('paymentModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('paymentModal').children[1].classList.remove('translate-y-full'),10); };
        window.closePaymentModal = () => { document.getElementById('paymentModal').children[1].classList.add('translate-y-full'); setTimeout(()=>document.getElementById('paymentModal').classList.add('hidden'),300); };
        window.openScoreModal = (id) => { window.selectedExamId = id; document.getElementById('scoreInput').value = ''; document.getElementById('scoreModal').classList.remove('hidden'); };
        window.closeScoreModal = () => document.getElementById('scoreModal').classList.add('hidden');
        window.submitScore = async () => {
            const score = Number(document.getElementById('scoreInput').value);
            if(!window.selectedExamId || !currentUser) return;
            try { await setDoc(doc(db, "users", currentUser.uid, "my_exams", window.selectedExamId), { status: 'graded', score, gradedAt: new Date().toISOString() }, { merge: true }); alert("ì±„ì  ì™„ë£Œ!"); closeScoreModal(); switchTab('report'); } catch { alert("ì €ì¥ ì‹¤íŒ¨"); }
        };
        window.copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.')).catch(() => alert('ë³µì‚¬ ì‹¤íŒ¨')); };

        lucide.createIcons();
    </script>
</body>
</html>