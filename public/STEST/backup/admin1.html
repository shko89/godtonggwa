<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°“í†µê³¼ ê´€ë¦¬ì ëª¨ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div id="login-container" class="w-full max-w-md bg-gray-800 rounded-3xl p-8 border border-gray-700 shadow-2xl fade-in hidden">
        <div class="text-center mb-8">
            <div class="bg-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-2xl font-bold">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <p class="text-gray-400 text-sm mt-2">ë°ì´í„°ë² ì´ìŠ¤ì— ë“±ë¡ëœ ì •ë³´ë¡œ ì ‘ì†í•˜ì„¸ìš”.</p>
        </div>
        
        <form id="admin-login-form" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">ì´ë©”ì¼</label>
                <input type="email" id="admin-email" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 focus:border-indigo-500 outline-none text-white text-sm" placeholder="admin@example.com" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="admin-pw" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 focus:border-indigo-500 outline-none text-white text-sm" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            </div>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 transition-colors flex justify-center items-center gap-2">
                <span id="btn-text">ë¡œê·¸ì¸</span>
                <div id="btn-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
        </form>

        <div class="mt-6 text-center">
            <button onclick="location.href='exam.html'" class="text-gray-500 hover:text-white text-xs underline">
                ëª¨ì˜ê³ ì‚¬ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <div id="access-denied-container" class="w-full max-w-md bg-gray-800 rounded-3xl p-8 border border-red-900/50 shadow-2xl fade-in hidden text-center">
        <div class="bg-red-900/20 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <i data-lucide="lock" class="w-8 h-8 text-red-500"></i>
        </div>
        <h2 class="text-xl font-bold text-white mb-2">ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h2>
        <p class="text-gray-400 text-sm mb-6 leading-relaxed">
            í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì • <span id="denied-email" class="text-white font-bold"></span> ì€<br>
            ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <div class="bg-gray-700/50 p-3 rounded-lg text-xs text-gray-400 mb-6 text-left">
            <p>ğŸ’¡ <strong>íŒ:</strong> ë‹¤ë¥¸ íƒ­ì—ì„œ í•™ìƒ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì¤‘ì´ë¼ë©´, ì—¬ê¸°ì„œ ë¡œê·¸ì•„ì›ƒí•˜ë©´ í•™ìƒ ì°½ë„ ê°™ì´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.</p>
        </div>
        
        <div class="space-y-3">
            <button onclick="location.href='exam.html'" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3.5 rounded-xl transition-colors">
                ëª¨ì˜ê³ ì‚¬ í˜ì´ì§€ë¡œ ì´ë™ (í•™ìƒ ëª¨ë“œ)
            </button>
            <button onclick="forceLogout()" class="w-full bg-red-900/80 hover:bg-red-800 text-white font-bold py-3.5 rounded-xl transition-colors shadow-lg">
                ë¡œê·¸ì•„ì›ƒ í›„ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
        </div>
    </div>

    <div id="admin-container" class="w-full max-w-6xl bg-gray-800 rounded-3xl p-8 border border-gray-700 shadow-2xl fade-in hidden space-y-8 my-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="settings" class="w-6 h-6 text-white"></i></div>
                <div>
                    <h1 class="text-2xl font-bold">í†µí•© ê´€ë¦¬ì ëª¨ë“œ</h1>
                    <p class="text-xs text-indigo-300 font-medium" id="admin-badge">Admin Access</p>
                </div>
            </div>
            <button onclick="logout()" class="text-xs text-gray-400 hover:text-white underline">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="flex space-x-1 bg-gray-900 p-1 rounded-xl overflow-x-auto no-scrollbar">
            <button onclick="switchAdminTab('round')" id="btn-tab-round" class="flex-1 py-2 rounded-lg text-sm font-bold bg-gray-700 text-white shadow transition-all whitespace-nowrap px-4">íšŒì°¨ ê´€ë¦¬</button>
            <button onclick="switchAdminTab('exam')" id="btn-tab-exam" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all whitespace-nowrap px-4">ëª¨ì˜ê³ ì‚¬ ê´€ë¦¬</button>
            <button onclick="switchAdminTab('question')" id="btn-tab-question" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all whitespace-nowrap px-4">ë¬¸í•­ ì€í–‰</button>
            <button onclick="switchAdminTab('user')" id="btn-tab-user" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all whitespace-nowrap px-4">ì‚¬ìš©ì ê´€ë¦¬</button>
            <button onclick="switchAdminTab('v2')" id="btn-tab-v2" class="flex-1 py-2 rounded-lg text-sm font-bold text-amber-400 hover:text-amber-300 transition-all whitespace-nowrap px-4 border border-amber-500/30">V2 í€´ì¦ˆDB</button>
        </div>

        <div id="section-round" class="admin-section">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700 relative overflow-hidden">
                <h2 class="text-sm font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="calendar-clock" class="w-4 h-4 text-indigo-400"></i> íšŒì°¨ ì§„í–‰ ê´€ë¦¬</h2>
                <div class="flex items-center justify-center gap-1 mb-4">
                    <span id="current-round-display" class="text-5xl font-black text-indigo-400">-</span>
                    <span class="text-lg text-gray-500 font-bold mt-3">íšŒ</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="updateRound(-1)" class="bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold text-sm transition-colors border border-gray-600">
                        -1 íšŒì°¨
                    </button>
                    <button onclick="updateRound(1)" class="bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm transition-colors shadow-lg">
                        +1 íšŒì°¨
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-4 text-center">
                    í˜„ì¬ íšŒì°¨ê¹Œì§€ 'ì§€ë‚œ ì‹œí—˜'ìœ¼ë¡œ, ë‹¤ìŒ íšŒì°¨ëŠ” 'ì ‘ìˆ˜ ì¤‘'ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <div id="section-exam" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="database" class="w-4 h-4 text-emerald-400"></i> ëª¨ì˜ê³ ì‚¬ ëª©ë¡ (exams)</h2>
                    <div class="flex gap-2">
                        <button onclick="openExamEditModal()" class="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg font-bold transition-colors flex items-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> ìƒˆ ì‹œí—˜ ìƒì„±
                        </button>
                        <button onclick="loadExamList()" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-lg border border-gray-600 transition-colors">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
                
                <div id="exam-list-container" class="space-y-3 max-h-[500px] overflow-y-auto hide-scrollbar mb-4">
                    <p class="text-center text-gray-500 text-sm py-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <div class="pt-4 border-t border-gray-800">
                    <button onclick="batchUpdateYear()" class="w-full py-3 bg-emerald-900/30 hover:bg-emerald-900/50 border border-emerald-800 text-emerald-400 rounded-xl text-xs font-bold transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> ëª¨ë“  ë°ì´í„°ì˜ '2024'ë¥¼ '2026'ìœ¼ë¡œ ì¼ê´„ ë³€ê²½
                    </button>
                </div>
            </div>
        </div>

        <div id="section-question" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700 space-y-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4 text-purple-400"></i> ë¬¸í•­ ì€í–‰ ê´€ë¦¬</h2>
                        <span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full" id="total-questions-count">0ê°œ</span>
                    </div>
                    <button onclick="openQuestionModal()" class="text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded-lg font-bold transition-colors flex items-center gap-1">
                        <i data-lucide="plus" class="w-3 h-3"></i> ìƒˆ ë¬¸í•­ ì¶”ê°€
                    </button>
                </div>

                <div id="questions-list-container" class="space-y-3 max-h-[500px] overflow-y-auto hide-scrollbar">
                    <p class="text-center text-gray-500 text-xs py-4">ë¬¸í•­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>

        <div id="section-user" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700 space-y-6">
                
                <div>
                    <h2 class="text-sm font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="search" class="w-4 h-4 text-blue-400"></i> ì‚¬ìš©ì ê²€ìƒ‰</h2>
                    <div class="flex gap-2">
                        <input type="text" id="search-user-input" class="flex-1 px-4 py-2 rounded-lg bg-gray-800 border border-gray-600 focus:border-blue-500 outline-none text-white text-sm" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„">
                        <button onclick="searchUser()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold">ê²€ìƒ‰</button>
                    </div>
                </div>

                <div id="user-manage-panel" class="hidden border-t border-gray-700 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-xs text-gray-400">ì‚¬ìš©ì ì´ë¦„</p>
                            <p id="manage-user-name" class="text-lg font-bold text-white">í™ê¸¸ë™</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">ê³„ì • (ì´ë©”ì¼)</p>
                            <span id="manage-user-email" class="text-xs text-gray-300">-</span>
                            <br/>
                            <span id="manage-user-joined" class="text-xs text-gray-500">-</span>
                        </div>
                    </div>

                    <div class="mb-6 bg-gray-800 p-4 rounded-xl border border-gray-600">
                        <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">ë©¤ë²„ì‹­ ê¶Œí•œ ì¼ê´„ ë³€ê²½</h3>
                        <div class="flex items-center justify-between">
                            <span id="manage-user-status" class="inline-block px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300">Free</span>
                            <div class="flex gap-2">
                                <button onclick="updateUserPaidStatus(false)" class="text-xs border border-gray-500 text-gray-300 px-3 py-1.5 rounded-lg hover:bg-gray-700 transition-colors">ë¬´ë£Œë¡œ ì „í™˜</button>
                                <button onclick="updateUserPaidStatus(true)" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-500 transition-colors">ìœ ë£Œë¡œ ì „í™˜</button>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase flex items-center gap-2">
                        <i data-lucide="check-circle-2" class="w-3 h-3"></i> íšŒì°¨ë³„ ê¶Œí•œ ê´€ë¦¬
                    </h3>
                    <div id="user-exam-list" class="space-y-2 max-h-[350px] overflow-y-auto hide-scrollbar mb-6">
                        <p class="text-center text-gray-500 text-xs py-4">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <div class="pt-6 border-t border-gray-700">
                        <h3 class="text-xs font-bold text-red-400 mb-2 uppercase flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-3 h-3"></i> ìœ„í—˜ êµ¬ì—­ (ë°ì´í„° ì‚­ì œ)
                        </h3>
                        <div class="bg-red-900/10 p-3 rounded-xl border border-red-900/30">
                            <div class="flex gap-2">
                                <input type="text" id="reset-exam-id" class="flex-1 px-4 py-2 rounded-lg bg-gray-800 border border-gray-600 focus:border-red-500 outline-none text-white text-sm" placeholder="ì‚­ì œí•  ì‹œí—˜ ID (ì˜ˆ: exam_01)">
                                <button onclick="resetUserExamData()" class="bg-red-900/50 hover:bg-red-900 border border-red-800 text-red-200 px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-colors">
                                    ì‚­ì œ
                                </button>
                            </div>
                            <p class="text-[10px] text-gray-500 mt-2">* í•´ë‹¹ íšŒì°¨ì˜ êµ¬ë§¤ ê¸°ë¡(my_exams)ê³¼ ì„±ì í‘œ(exam_results)ê°€ ëª¨ë‘ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <div id="section-v2" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-amber-500/30">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5 text-amber-500"></i> V2 í€´ì¦ˆ DB ê´€ë¦¬
                        </h2>
                        <p class="text-xs text-amber-500/80 mt-1">artifacts/.../quiz_problems ì»¬ë ‰ì…˜ ì§ì ‘ ì œì–´</p>
                    </div>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="v2-filter-unit" onchange="loadV2List()" class="bg-gray-800 text-white text-xs border border-gray-600 rounded-lg px-3 py-2 outline-none focus:border-amber-500">
                            <option value="all">ì „ì²´ ë‹¨ì› ë³´ê¸°</option>
                            <option value="unit_01">1ë‹¨ì› (ê³¼í•™ì˜ ê¸°ì´ˆ)</option>
                            <option value="unit_02">2ë‹¨ì› (ë¬¼ì§ˆê³¼ ê·œì¹™ì„±)</option>
                            <option value="unit_03">3ë‹¨ì› (ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©)</option>
                            <option value="unit_04">4ë‹¨ì› (ë³€í™”ì™€ ë‹¤ì–‘ì„±)</option>
                            <option value="unit_05">5ë‹¨ì› (í™˜ê²½ê³¼ ì—ë„ˆì§€)</option>
                            <option value="unit_06">6ë‹¨ì› (ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ)</option>
                        </select>
                        
                        <button onclick="loadV2List()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 p-2 rounded-lg border border-gray-600 transition-colors" title="ìƒˆë¡œê³ ì¹¨">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>

                        <button onclick="openV2Modal()" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors shadow-lg flex items-center gap-1 whitespace-nowrap">
                            <i data-lucide="plus" class="w-3 h-3"></i> ë¬¸í•­ ì¶”ê°€
                        </button>
                    </div>
                </div>

                <div id="v2-list-container" class="space-y-2 max-h-[600px] overflow-y-auto hide-scrollbar">
                    <p class="text-center text-gray-500 text-sm py-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>

    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden p-4">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl p-6 border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">ì‹œí—˜ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="edit-doc-id">
            <div class="space-y-3">
                <div id="edit-id-container">
                    <label class="text-xs text-gray-400 block mb-1">ì‹œí—˜ ID (í•„ìˆ˜)</label>
                    <input id="edit-id-input" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none" placeholder="ì˜ˆ: exam_01">
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì œëª© (Title)</label>
                    <input id="edit-title" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ë¶€ì œëª© (SubTitle)</label>
                    <input id="edit-subtitle" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ê°€ê²© (Price)</label>
                    <input type="number" id="edit-price" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì‹œí–‰ ë‚ ì§œ (Date)</label>
                    <input type="date" id="edit-date" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700">
                <button onclick="openExamQuestionsModal()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2 mb-4">
                    <i data-lucide="list-checks" class="w-4 h-4"></i> ë¬¸í•­ êµ¬ì„± ë° ë°°ì  ê´€ë¦¬
                </button>
                <div class="flex gap-2">
                    <button onclick="closeEditModal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded-lg text-sm hover:bg-gray-600">ì·¨ì†Œ</button>
                    <button onclick="saveExamData()" class="flex-1 py-2 bg-emerald-600 text-white rounded-lg text-sm font-bold hover:bg-emerald-500">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <div id="exam-questions-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[80] hidden p-4 overflow-y-auto">
        <div class="bg-gray-800 w-full max-w-5xl rounded-2xl p-6 border border-gray-600 shadow-2xl my-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-emerald-400"></i> ë¬¸í•­ êµ¬ì„± (25ë¬¸í•­)</h3>
                    <p class="text-sm text-gray-400 mt-1">Questions ì»¬ë ‰ì…˜ì˜ ë¬¸í•­ IDë¥¼ ì—°ê²°í•˜ì—¬ ì‹œí—˜ì„ êµ¬ì„±í•©ë‹ˆë‹¤.</p>
                </div>
                <button onclick="closeExamQuestionsModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="mb-4 bg-gray-700/50 p-3 rounded-lg flex items-center gap-2 text-xs text-gray-300">
                <i data-lucide="info" class="w-4 h-4 text-blue-400"></i>
                <span>ë¬¸í•­ IDë¥¼ ì…ë ¥í•˜ê³  ì—”í„°/í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ë°°ì ê³¼ ì •ë‹µì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (ìˆ˜ë™ ë³€ê²½ ê°€ëŠ¥)</span>
            </div>

            <div id="mapping-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-3 max-h-[60vh] overflow-y-auto p-1 custom-scrollbar">
                </div>

            <div class="flex justify-end mt-6 pt-4 border-t border-gray-700">
                <button onclick="closeExamQuestionsModal()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-500 shadow-lg">í™•ì¸ (ì„ì‹œ ì €ì¥)</button>
            </div>
        </div>
    </div>

    <div id="question-edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden p-4 overflow-y-auto">
        <div class="bg-gray-800 w-full max-w-lg rounded-2xl p-6 border border-gray-600 shadow-2xl my-auto">
            <h3 class="text-lg font-bold text-white mb-4">ë¬¸í•­ ì •ë³´ (Questions)</h3>
            <input type="hidden" id="q-doc-id"> 
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ë¬¸í•­ ID (ì˜ˆ: q_2026_phys_01)</label>
                    <input id="q-id" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none" placeholder="ìë™ ìƒì„± ê°€ëŠ¥">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ëŒ€ë‹¨ì› (Domain)</label>
                        <select id="q-domain" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ë¬¼ë¦¬í•™">ë¬¼ë¦¬í•™</option>
                            <option value="í™”í•™">í™”í•™</option>
                            <option value="ìƒëª…ê³¼í•™">ìƒëª…ê³¼í•™</option>
                            <option value="ì§€êµ¬ê³¼í•™">ì§€êµ¬ê³¼í•™</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ì¤‘ë‹¨ì› (Chapter)</label>
                        <select id="q-chapter" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ê³¼í•™ì˜ ê¸°ì´ˆ">ê³¼í•™ì˜ ê¸°ì´ˆ</option>
                            <option value="ë¬¼ì§ˆê³¼ ê·œì¹™ì„±">ë¬¼ì§ˆê³¼ ê·œì¹™ì„±</option>
                            <option value="ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©">ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©</option>
                            <option value="ë³€í™”ì™€ ë‹¤ì–‘ì„±">ë³€í™”ì™€ ë‹¤ì–‘ì„±</option>
                            <option value="í™˜ê²½ê³¼ ì—ë„ˆì§€">í™˜ê²½ê³¼ ì—ë„ˆì§€</option>
                            <option value="ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ">ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì†Œë‹¨ì›/ìœ í˜• (Topic)</label>
                    <select id="q-topic" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                        <option value="">ì¤‘ë‹¨ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ë‚œì´ë„ / ë°°ì </label>
                        <select id="q-difficulty" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="1.5">1.5ì  (í•˜)</option>
                            <option value="2.0">2.0ì  (ì¤‘)</option>
                            <option value="2.5">2.5ì  (ìƒ)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ì •ë‹µ (Correct Answer)</label>
                        <input type="number" id="q-answer" min="1" max="5" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none" placeholder="1~5">
                    </div>
                </div>
                
                <div class="bg-gray-700/30 p-3 rounded-lg border border-gray-600">
                    <p class="text-xs font-bold text-gray-400 mb-2">ëˆ„ì  í†µê³„ (ìë™ ê³„ì‚°)</p>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div>
                            <span class="block text-gray-500">ì´ ì‘ì‹œ</span>
                            <span class="font-bold text-white" id="stat-total">0</span>
                        </div>
                        <div>
                            <span class="block text-gray-500">ì •ë‹µ ìˆ˜</span>
                            <span class="font-bold text-white" id="stat-correct">0</span>
                        </div>
                        <div>
                            <span class="block text-gray-500">ì •ë‹µë¥ </span>
                            <span class="font-bold text-indigo-400" id="stat-accuracy">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="closeQuestionModal()" class="flex-1 py-3 bg-gray-700 text-gray-300 rounded-xl text-sm font-bold hover:bg-gray-600">ì·¨ì†Œ</button>
                <button onclick="saveQuestionData()" class="flex-1 py-3 bg-purple-600 text-white rounded-xl text-sm font-bold hover:bg-purple-500">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="v2-edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[90] hidden p-4 overflow-y-auto">
        <div class="bg-gray-800 w-full max-w-lg rounded-2xl p-6 border border-amber-600/50 shadow-2xl my-auto">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="edit-3" class="w-5 h-5 text-amber-500"></i> V2 í€´ì¦ˆ ì •ë³´
            </h3>
            <input type="hidden" id="v2-doc-id">
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ë‹¨ì› (Unit)</label>
                        <select id="v2-unit" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-amber-500 outline-none">
                            <option value="unit_01">1ë‹¨ì› (ê³¼í•™ì˜ ê¸°ì´ˆ)</option>
                            <option value="unit_02">2ë‹¨ì› (ë¬¼ì§ˆê³¼ ê·œì¹™ì„±)</option>
                            <option value="unit_03">3ë‹¨ì› (ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©)</option>
                            <option value="unit_04">4ë‹¨ì› (ë³€í™”ì™€ ë‹¤ì–‘ì„±)</option>
                            <option value="unit_05">5ë‹¨ì› (í™˜ê²½ê³¼ ì—ë„ˆì§€)</option>
                            <option value="unit_06">6ë‹¨ì› (ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ë¬¸ì œ ìœ í˜• (Type)</label>
                        <select id="v2-type" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-amber-500 outline-none">
                            <option value="OX">OX í€´ì¦ˆ</option>
                            <option value="Multi">4ì§€ ì„ ë‹¤ (ì¤€ë¹„ì¤‘)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-400 block mb-1">ë¬¸ì œ ë‚´ìš© (Question)</label>
                    <textarea id="v2-q" rows="3" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-amber-500 outline-none" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì •ë‹µ (Answer)</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="v2-answer" value="O" class="accent-amber-500 w-4 h-4">
                            <span class="text-sm">O (ê·¸ë ‡ë‹¤)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="v2-answer" value="X" class="accent-amber-500 w-4 h-4">
                            <span class="text-sm">X (ì•„ë‹ˆë‹¤)</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-400 block mb-1">í•´ì„¤ (Explanation)</label>
                    <textarea id="v2-exp" rows="3" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-amber-500 outline-none" placeholder="í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="document.getElementById('v2-edit-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-700 text-gray-300 rounded-xl text-sm font-bold hover:bg-gray-600">ì·¨ì†Œ</button>
                <button onclick="saveV2Data()" class="flex-1 py-3 bg-amber-600 text-white rounded-xl text-sm font-bold hover:bg-amber-500 shadow-lg shadow-amber-900/20">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, updateDoc, onSnapshot, collection, query, where, getDocs, orderBy, writeBatch, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // [ì„¤ì •] V2 ì•± ID
        const V2_APP_ID = "godtonggwa_v1";

        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentRound = 0;
        let unsubscribe = null;
        let searchedUserUid = null; 
        let currentEditingExamId = null;
        let tempExamQuestions = Array(25).fill(null);

        const TOPIC_MAP = {
            "ê³¼í•™ì˜ ê¸°ì´ˆ": ["ê¸°ë³¸ëŸ‰ê³¼ ë‹¨ìœ„", "ì¸¡ì •ê³¼ ì–´ë¦¼", "ì •ë³´ì™€ ì‹ í˜¸"],
            "ë¬¼ì§ˆê³¼ ê·œì¹™ì„±": ["ì›ì†Œ í˜•ì„±", "ë³„ì˜ ì§„í™”", "ì›ì†Œì˜ ì£¼ê¸°ì„±", "í™”í•™ ê²°í•©", "ì§€ê°ê³¼ ìƒëª…ì²´ êµ¬ì„± ë¬¼ì§ˆì˜ ê·œì¹™ì„±"],
            "ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©": ["ì§€êµ¬ì‹œìŠ¤í…œì˜ êµ¬ì„±ê³¼ ìƒí˜¸ì‘ìš©", "íŒêµ¬ì¡°ë¡ ê³¼ ì§€ê° ë³€ë™", "ì¤‘ë ¥ì¥ ë‚´ì˜ ìš´ë™", "ì¶©ê²©ëŸ‰ê³¼ ìš´ë™ëŸ‰", "ìƒëª… ì‹œìŠ¤í…œì˜ ê¸°ë³¸ ë‹¨ìœ„", "ë¬¼ì§ˆëŒ€ì‚¬", "ìœ ì „ìì™€ ë‹¨ë°±ì§ˆ", "ë¬¼ì§ˆì˜ ì „ê¸°ì  ì„±ì§ˆ"],
            "ë³€í™”ì™€ ë‹¤ì–‘ì„±": ["ì§€ì§ˆì‹œëŒ€ì˜ ìƒë¬¼ê³¼ í™”ì„", "ì§€ì§ˆì‹œëŒ€ í™˜ê²½ ë³€í™”ì™€ ëŒ€ë©¸ì¢…", "ìì—°ì„ íƒ", "ìƒë¬¼ë‹¤ì–‘ì„±", "ì‚°í™”ì™€ í™˜ì›", "ì¤‘í™” ë°˜ì‘", "ë¬¼ì§ˆ ë³€í™”ì—ì„œ ì—ë„ˆì§€ ì¶œì…"],
            "í™˜ê²½ê³¼ ì—ë„ˆì§€": ["ìƒíƒœê³„ êµ¬ì„± ìš”ì†Œ", "ìƒíƒœê³„ í‰í˜•", "ëŒ€ê¸°ì™€ í•´ì–‘ì˜ ìƒí˜¸ì‘ìš©", "ì˜¨ì‹¤ê¸°ì²´ì™€ ì§€êµ¬ì˜¨ë‚œí™”", "í•µìœµí•©", "ë°œì „", "ì—ë„ˆì§€ ì „í™˜ê³¼ íš¨ìœ¨"],
            "ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ": ["ê°ì—¼ë³‘ê³¼ ë³‘ì›ì²´", "ì¸ê³µì§€ëŠ¥ê³¼ ê³¼í•™ íƒêµ¬", "ë¡œë´‡", "ê³¼í•™ê¸°ìˆ ê³¼ ìœ¤ë¦¬"]
        };

        // 1. ì¸ì¦ ìƒíƒœ ê°ì§€ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ + V2 íƒ­ ê¶Œí•œ í™•ì¸)
        onAuthStateChanged(auth, async (user) => {
            const loginContainer = document.getElementById('login-container');
            const adminContainer = document.getElementById('admin-container');
            const deniedContainer = document.getElementById('access-denied-container');
            
            if (user) {
                try {
                    const adminDoc = await getDoc(doc(db, "settings", "admin"));
                    // ê´€ë¦¬ì í™•ì¸
                    if (adminDoc.exists() && adminDoc.data().adminEmail === user.email) {
                        loginContainer.classList.add('hidden');
                        deniedContainer.classList.add('hidden');
                        adminContainer.classList.remove('hidden');
                        document.getElementById('admin-badge').innerText = user.email;
                        
                        if (!unsubscribe) initAdminListener();
                        
                        // [Fix] ì´ˆê¸° ë¡œë”© ì‹œ ëª¨ì˜ê³ ì‚¬ ë¦¬ìŠ¤íŠ¸ ìë™ ë¡œë“œ
                        window.loadExamList();
                        
                    } else {
                        // ê¶Œí•œ ì—†ìŒ
                        loginContainer.classList.add('hidden');
                        adminContainer.classList.add('hidden');
                        deniedContainer.classList.remove('hidden');
                        document.getElementById('denied-email').innerText = user.email;
                        if (unsubscribe) { unsubscribe(); unsubscribe = null; }
                    }
                } catch (error) {
                    console.error("DB Check Error:", error);
                    alert("DB ì—°ê²° ì˜¤ë¥˜: " + error.message);
                    await signOut(auth);
                }
            } else {
                loginContainer.classList.remove('hidden');
                adminContainer.classList.add('hidden');
                deniedContainer.classList.add('hidden');
                if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            }
        });

        // 2. íƒ­ ì „í™˜ ë¡œì§ (V2 íƒ­ ì¶”ê°€)
        window.switchAdminTab = (tabName) => {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            
            ['round', 'exam', 'user', 'question', 'v2'].forEach(t => {
                const btn = document.getElementById(`btn-tab-${t}`);
                if (!btn) return;
                
                if (t === tabName) {
                    if (t === 'v2') {
                        btn.classList.remove('text-amber-400');
                        btn.classList.add('bg-amber-600', 'text-white', 'border-amber-600');
                        window.loadV2List(); // íƒ­ ì „í™˜ ì‹œ ë°ì´í„° ë¡œë“œ
                    } else {
                        btn.classList.remove('text-gray-400', 'font-medium', 'bg-transparent');
                        btn.classList.add('text-white', 'font-bold', 'bg-gray-700', 'shadow');
                    }
                    
                    if(t === 'exam') window.loadExamList();
                    if(t === 'question') window.loadQuestionsList();
                } else {
                    if (t === 'v2') {
                        btn.classList.add('text-amber-400');
                        btn.classList.remove('bg-amber-600', 'text-white', 'border-amber-600');
                    } else {
                        btn.classList.add('text-gray-400', 'font-medium', 'bg-transparent');
                        btn.classList.remove('text-white', 'font-bold', 'bg-gray-700', 'shadow');
                    }
                }
            });
        };

        // --- V2 ê´€ë¦¬ ë¡œì§ (ì‹ ê·œ êµ¬í˜„) ---
        window.loadV2List = async () => {
            const container = document.getElementById('v2-list-container');
            const unitFilter = document.getElementById('v2-filter-unit').value;
            
            container.innerHTML = '<div class="text-center py-8"><div class="w-8 h-8 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div><p class="text-gray-500 text-xs">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p></div>';

            try {
                // V2 Collection Path
                const collectionRef = collection(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems');
                
                // Firestore ì¸ë±ì‹± ì—†ì´ ê°„í¸í•˜ê²Œ í•„í„°ë§í•˜ê¸° ìœ„í•´ ì „ì²´ ë¡œë“œ í›„ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ (ë°ì´í„° ì–‘ì´ ë§ì§€ ì•Šë‹¤ê³  ê°€ì •)
                // ë§Œì•½ ë°ì´í„°ê°€ ë§ì•„ì§€ë©´ ì¸ë±ìŠ¤ ìƒì„± í›„ where ì ˆ ì‚¬ìš© ê¶Œì¥
                const snapshot = await getDocs(collectionRef);
                
                let docs = [];
                snapshot.forEach(d => docs.push({ id: d.id, ...d.data() }));

                // ì •ë ¬ (ë‹¨ì›ìˆœ -> ìƒì„±ìˆœ)
                docs.sort((a, b) => {
                    if (a.unitId !== b.unitId) return a.unitId.localeCompare(b.unitId);
                    return (a.q || "").localeCompare(b.q || ""); 
                });

                // í•„í„°ë§
                if (unitFilter !== 'all') {
                    docs = docs.filter(d => d.unitId === unitFilter);
                }

                if (docs.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-10">
                        <i data-lucide="file-x" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="text-sm">í•´ë‹¹ ì¡°ê±´ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>`;
                    lucide.createIcons();
                    return;
                }

                let html = '';
                docs.forEach(item => {
                    const unitName = item.unitId ? item.unitId.replace('unit_0', '') + 'ë‹¨ì›' : 'ë¯¸ë¶„ë¥˜';
                    const answerBadge = item.a === 'O' 
                        ? '<span class="text-blue-400 font-bold bg-blue-900/30 px-2 py-0.5 rounded text-xs">O</span>' 
                        : '<span class="text-red-400 font-bold bg-red-900/30 px-2 py-0.5 rounded text-xs">X</span>';

                    html += `
                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-amber-500/50 transition-colors flex flex-col md:flex-row gap-3 items-start md:items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded border border-gray-600">${unitName}</span>
                                    <span class="text-[10px] bg-gray-700 text-gray-400 px-1.5 py-0.5 rounded">${item.type || 'OX'}</span>
                                </div>
                                <h4 class="text-sm text-white font-medium break-keep mb-1">${item.q}</h4>
                                <p class="text-xs text-gray-500 truncate">${item.exp || 'í•´ì„¤ ì—†ìŒ'}</p>
                            </div>
                            
                            <div class="flex items-center gap-4 pl-0 md:pl-4 w-full md:w-auto justify-between md:justify-end border-t md:border-t-0 border-gray-700 pt-3 md:pt-0">
                                <div class="text-sm">ì •ë‹µ: ${answerBadge}</div>
                                <div class="flex gap-2">
                                    <button onclick="openV2Modal('${item.id}')" class="p-2 bg-gray-700 hover:bg-amber-600 hover:text-white rounded-lg text-gray-300 transition-colors" title="ìˆ˜ì •">
                                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="deleteV2Data('${item.id}')" class="p-2 bg-gray-700 hover:bg-red-600 hover:text-white rounded-lg text-gray-300 transition-colors" title="ì‚­ì œ">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                lucide.createIcons();

            } catch (error) {
                console.error("V2 Load Error:", error);
                container.innerHTML = `<p class="text-center text-red-400 text-sm">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}</p>`;
            }
        };

        window.openV2Modal = async (docId = null) => {
            const modal = document.getElementById('v2-edit-modal');
            const docIdInput = document.getElementById('v2-doc-id');
            const unitSelect = document.getElementById('v2-unit');
            const typeSelect = document.getElementById('v2-type');
            const qInput = document.getElementById('v2-q');
            const expInput = document.getElementById('v2-exp');
            const radios = document.getElementsByName('v2-answer');

            // ì´ˆê¸°í™”
            docIdInput.value = '';
            unitSelect.value = 'unit_01';
            typeSelect.value = 'OX';
            qInput.value = '';
            expInput.value = '';
            radios.forEach(r => r.checked = false);

            if (docId) {
                // ìˆ˜ì • ëª¨ë“œ: ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                try {
                    const docRef = doc(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems', docId);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        docIdInput.value = docId;
                        unitSelect.value = data.unitId || 'unit_01';
                        typeSelect.value = data.type || 'OX';
                        qInput.value = data.q || '';
                        expInput.value = data.exp || '';
                        // ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
                        radios.forEach(r => {
                            if (r.value === data.a) r.checked = true;
                        });
                    }
                } catch (e) {
                    alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message);
                    return;
                }
            }

            modal.classList.remove('hidden');
        };

        window.saveV2Data = async () => {
            const docId = document.getElementById('v2-doc-id').value;
            const unitId = document.getElementById('v2-unit').value;
            const type = document.getElementById('v2-type').value;
            const q = document.getElementById('v2-q').value.trim();
            const exp = document.getElementById('v2-exp').value.trim();
            
            let a = null;
            document.getElementsByName('v2-answer').forEach(r => {
                if (r.checked) a = r.value;
            });

            if (!q) return alert("ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!a) return alert("ì •ë‹µ(O/X)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            const dataPayload = {
                unitId, type, q, a, exp,
                updatedAt: new Date().toISOString()
            };

            const collectionRef = collection(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems');

            try {
                if (docId) {
                    // ìˆ˜ì •
                    await updateDoc(doc(collectionRef, docId), dataPayload);
                } else {
                    // ìƒì„±
                    dataPayload.createdAt = new Date().toISOString();
                    await addDoc(collectionRef, dataPayload);
                }
                
                document.getElementById('v2-edit-modal').classList.add('hidden');
                window.loadV2List(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                // alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); // UXìƒ ì•Œë¦¼ ì—†ì´ ë°”ë¡œ ë°˜ì˜ë˜ëŠ”ê²Œ ë” ê¹”ë”í•¨
            } catch (e) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            }
        };

        window.deleteV2Data = async (docId) => {
            if (!confirm("ì •ë§ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems', docId));
                window.loadV2List();
            } catch (e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        };


        // --- ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ ---
        function initAdminListener() {
            unsubscribe = onSnapshot(doc(db, "settings", "global"), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentRound = docSnapshot.data().latestRound || 0;
                    document.getElementById('current-round-display').innerText = currentRound;
                } else {
                    document.getElementById('current-round-display').innerText = "0";
                    currentRound = 0;
                    setDoc(doc(db, "settings", "global"), { latestRound: 0 }, { merge: true });
                }
            });
        }

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const email = document.getElementById('admin-email').value; 
            const pw = document.getElementById('admin-pw').value;
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            
            btnText.textContent = "í™•ì¸ ì¤‘..."; 
            btnSpinner.classList.remove('hidden');

            try { 
                await signInWithEmailAndPassword(auth, email, pw); 
            } catch (error) { 
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message); 
                btnText.textContent = "ë¡œê·¸ì¸"; 
                btnSpinner.classList.add('hidden');
            }
        });

        window.logout = () => { if (unsubscribe) unsubscribe(); signOut(auth); };
        window.forceLogout = () => signOut(auth);
        
        window.updateRound = async (delta) => { 
            if (!auth.currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”"); 
            const newValue = currentRound + delta; 
            if(newValue < 0 || newValue > 24) return alert("ë²”ìœ„ ì´ˆê³¼"); 
            if(confirm("ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
                try { 
                    document.getElementById('current-round-display').innerText = newValue; 
                    currentRound = newValue; 
                    await setDoc(doc(db, "settings", "global"), { latestRound: newValue }, { merge: true }); 
                } catch(e) { alert("ì˜¤ë¥˜: "+e.message); } 
            } 
        };

        // [ë³µì›] loadExamList í•¨ìˆ˜
        window.loadExamList = async () => {
            const container = document.getElementById('exam-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">ë¡œë”© ì¤‘...</p>';
            try {
                const q = query(collection(db, "public_exams"), orderBy("id", "asc"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { container.innerHTML = '<p class="text-center text-gray-500 text-xs">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const qCount = data.questions ? data.questions.length : 0;
                    html += `<div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center group hover:border-gray-600 transition-colors">
                            <div class="flex-1 min-w-0 mr-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-gray-700 text-gray-300 text-[10px] px-1.5 py-0.5 rounded font-mono">${doc.id}</span>
                                    <span class="text-xs text-emerald-400 font-bold">#${data.id}</span>
                                </div>
                                <h4 class="text-sm font-bold text-white truncate">${data.title}</h4>
                                <div class="flex gap-2 text-xs text-gray-500">
                                    <span>${data.subTitle || '-'}</span>
                                    <span>â€¢ ë¬¸í•­: ${qCount}ê°œ</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openExamEditModal('${doc.id}')" class="p-2 bg-gray-700 hover:bg-emerald-600 rounded-lg text-gray-300 hover:text-white transition-colors" title="ìˆ˜ì •"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            </div></div>`;
                });
                container.innerHTML = html;
                lucide.createIcons();
            } catch (e) { console.error("Load Exam Error:", e); container.innerHTML = `<p class="text-center text-red-400 text-xs">ë¡œë”© ì‹¤íŒ¨: ${e.message}</p>`; }
        };

        // [ë³µì›] loadQuestionsList í•¨ìˆ˜ (ë¬¸í•­ ì€í–‰ íƒ­ìš©)
        window.loadQuestionsList = async () => {
            const container = document.getElementById('questions-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">ë¡œë”© ì¤‘...</p>';
            try {
                const q = query(collection(db, "questions"), limit(50)); 
                const snapshot = await getDocs(q);
                document.getElementById('total-questions-count').innerText = `${snapshot.size}ê°œ (ìµœê·¼)`;

                if (snapshot.empty) { container.innerHTML = '<p class="text-center text-gray-500 text-xs">ë“±ë¡ëœ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
                let html = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const tax = d.taxonomy || {};
                    const stats = d.stats || { totalAttempts: 0, correctCount: 0, accuracy: 0 };
                    const accPercent = stats.totalAttempts > 0 
                        ? Math.round((stats.correctCount / stats.totalAttempts) * 100) 
                        : 0;

                    html += `
                        <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center group hover:border-gray-600 transition-colors">
                            <div class="flex-1 min-w-0 mr-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-purple-900/50 text-purple-300 text-[10px] px-1.5 py-0.5 rounded font-mono border border-purple-800">${doc.id}</span>
                                    <span class="text-xs text-gray-400 font-bold">${tax.domain || 'ë¯¸ë¶„ë¥˜'}</span>
                                    <span class="text-xs text-gray-500">&gt; ${tax.chapter || '-'}</span>
                                </div>
                                <div class="text-xs text-gray-400 flex gap-3 items-center">
                                    <span>ì •ë‹µ: <strong class="text-white">${d.correctAnswer || '?'}</strong></span>
                                    <span>ë°°ì : <strong class="text-white">${d.difficulty || '-'}</strong>ì </span>
                                    <span class="text-gray-500 text-[10px]">ì •ë‹µë¥ : ${accPercent}% (${stats.totalAttempts}íšŒ)</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openQuestionModal('${doc.id}')" class="p-2 bg-gray-700 hover:bg-purple-600 rounded-lg text-gray-300 hover:text-white transition-colors">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteQuestionData('${doc.id}')" class="p-2 bg-red-900/50 hover:bg-red-900 border border-red-800 rounded-lg text-red-300 hover:text-white transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                lucide.createIcons();
            } catch (e) { container.innerHTML = `<p class="text-center text-red-400 text-xs">ë¡œë”© ì‹¤íŒ¨: ${e.message}</p>`; }
        };

        function safeSetValue(id, val) { const el = document.getElementById(id); if(el) el.value = val; }

        window.openExamEditModal = async (docId = null) => {
            const modal = document.getElementById('edit-modal');
            const idContainer = document.getElementById('edit-id-container');
            
            safeSetValue('edit-doc-id', docId || '');
            safeSetValue('edit-id-input', '');
            safeSetValue('edit-title', '');
            safeSetValue('edit-subtitle', '');
            safeSetValue('edit-price', 5000);
            safeSetValue('edit-date', '');
            tempExamQuestions = Array(25).fill(null);

            if (docId) {
                if(idContainer) idContainer.classList.add('hidden');
                try {
                    const docSnap = await getDoc(doc(db, "public_exams", docId));
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        safeSetValue('edit-title', d.title || '');
                        safeSetValue('edit-subtitle', d.subTitle || '');
                        safeSetValue('edit-price', d.price || 5000);
                        if(d.date) safeSetValue('edit-date', d.date.split('T')[0]);
                        
                        const detailSnap = await getDoc(doc(db, "exams", docId));
                        if(detailSnap.exists()) {
                            const detail = detailSnap.data();
                            if(detail.questions) tempExamQuestions = detail.questions;
                            else if(detail.score_map && detail.answer_key) {
                                tempExamQuestions = detail.score_map.map((score, i) => ({
                                    no: i+1, score: score, correctAnswer: detail.answer_key[i], qId: ''
                                }));
                            }
                        }
                    }
                } catch(e) { alert("ë¡œë“œ ì‹¤íŒ¨: " + e.message); return; }
            } else {
                if(idContainer) idContainer.classList.remove('hidden');
            }
            modal.classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.openExamQuestionsModal = () => {
            const modal = document.getElementById('exam-questions-modal');
            const container = document.getElementById('mapping-form');
            container.innerHTML = '';
            for(let i=0; i<25; i++) {
                const data = tempExamQuestions[i] || { qId: '', score: 2.0, correctAnswer: '' };
                container.innerHTML += `
                    <div class="bg-gray-700/50 p-3 rounded-xl border border-gray-600">
                        <div class="flex justify-between items-center mb-2"><span class="text-sm font-bold text-emerald-300">Q${i+1}</span></div>
                        <div class="space-y-2">
                            <div><input type="text" class="map-qid w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:border-emerald-500 outline-none" placeholder="ë¬¸í•­ ID" value="${data.qId || ''}" onchange="fetchQuestionInfo(this, ${i})"></div>
                            <div class="flex gap-2">
                                <input type="number" step="0.1" class="map-score w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-center text-white" placeholder="ë°°ì " value="${data.score || ''}">
                                <input type="number" class="map-ans w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-center text-white" placeholder="ì •ë‹µ" value="${data.correctAnswer || ''}">
                            </div>
                        </div>
                    </div>`;
            }
            modal.classList.remove('hidden');
        };

        window.closeExamQuestionsModal = () => {
            const qIds = document.querySelectorAll('.map-qid');
            const scores = document.querySelectorAll('.map-score');
            const answers = document.querySelectorAll('.map-ans');
            for(let i=0; i<25; i++) {
                tempExamQuestions[i] = {
                    no: i+1, qId: qIds[i].value.trim(), score: Number(scores[i].value) || 0, correctAnswer: Number(answers[i].value) || 0
                };
            }
            document.getElementById('exam-questions-modal').classList.add('hidden');
        };

        window.fetchQuestionInfo = async (inputEl, index) => {
            const qId = inputEl.value.trim(); if(!qId) return;
            try {
                const docSnap = await getDoc(doc(db, "questions", qId));
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    const scores = document.querySelectorAll('.map-score');
                    const answers = document.querySelectorAll('.map-ans');
                    if(data.difficulty) scores[index].value = data.difficulty;
                    if(data.correctAnswer) answers[index].value = data.correctAnswer;
                } else { inputEl.style.borderColor = 'red'; }
            } catch(e) { console.error(e); }
        };

        window.saveExamData = async () => {
            let docId = document.getElementById('edit-doc-id').value;
            if(!docId) docId = document.getElementById('edit-id-input').value.trim();
            if(!docId) return alert("ì‹œí—˜ ID í•„ìˆ˜");
            
            const title = document.getElementById('edit-title').value;
            const subTitle = document.getElementById('edit-subtitle').value;
            const price = Number(document.getElementById('edit-price').value);
            const dateVal = document.getElementById('edit-date').value;
            
            if (!confirm("ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try { 
                const dateISO = dateVal ? new Date(dateVal).toISOString() : null;
                const numId = Number(docId.replace(/[^0-9]/g, '')) || 0;
                await setDoc(doc(db, "public_exams", docId), { id: numId, title, subTitle, price, date: dateISO }, { merge: true });
                
                const scoreArr = tempExamQuestions.map(q => q ? q.score : 0);
                const ansArr = tempExamQuestions.map(q => q ? q.correctAnswer : 0);
                
                await setDoc(doc(db, "exams", docId), { 
                    title, questions: tempExamQuestions, score_map: scoreArr, answer_key: ansArr, updatedAt: new Date().toISOString() 
                }, { merge: true });
                
                alert("ì €ì¥ ì™„ë£Œ"); closeEditModal(); window.loadExamList(); 
            } catch (e) { alert("ì‹¤íŒ¨: " + e.message); }
        };

        window.batchUpdateYear = async () => {
            if (!confirm("ì¼ê´„ ë³€ê²½?")) return;
            try { 
                const q = query(collection(db, "public_exams")); 
                const snapshot = await getDocs(q); 
                const updates = []; 
                let count = 0; 
                snapshot.forEach(docSnapshot => { 
                    const data = docSnapshot.data(); 
                    let needsUpdate = false; 
                    let newTitle = data.title; 
                    let newSubTitle = data.subTitle || ""; 
                    if (newTitle.includes("2024")) { newTitle = newTitle.replace(/2024/g, "2026"); needsUpdate = true; } 
                    if (newSubTitle.includes("2024")) { newSubTitle = newSubTitle.replace(/2024/g, "2026"); needsUpdate = true; } 
                    if (needsUpdate) { updates.push(updateDoc(doc(db, "public_exams", docSnapshot.id), { title: newTitle, subTitle: newSubTitle })); count++; } 
                }); 
                await Promise.all(updates); 
                alert(`${count}ê°œ ìˆ˜ì • ì™„ë£Œ`); 
                window.loadExamList(); 
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        };

        // [ë³µì›] ì‚¬ìš©ì ê´€ë¦¬ ë¡œì§
        window.searchUser = async () => {
            const inputVal = document.getElementById('search-user-input').value.trim();
            if (!inputVal) return alert("ê²€ìƒ‰ì–´ ì…ë ¥");
            try {
                const usersRef = collection(db, "users");
                let q;
                if (inputVal.includes('@')) q = query(usersRef, where("email", "==", inputVal));
                else q = query(usersRef, where("name", "==", inputVal));
                
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { document.getElementById('user-manage-panel').classList.add('hidden'); return alert("ì‚¬ìš©ì ì—†ìŒ"); }
                
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                searchedUserUid = userDoc.id;
                document.getElementById('manage-user-name').innerText = userData.name || "ì´ë¦„ ì—†ìŒ";
                document.getElementById('manage-user-email').innerText = userData.email || "-";
                document.getElementById('manage-user-joined').innerText = userData.joinedAt ? new Date(userData.joinedAt).toLocaleDateString() : "-";
                document.getElementById('user-manage-panel').classList.remove('hidden');
                
                const statusEl = document.getElementById('manage-user-status');
                if (userData.isPaid) { statusEl.innerText = "Premium"; statusEl.className = "inline-block px-2 py-1 rounded text-xs font-bold bg-indigo-600 text-white"; } 
                else { statusEl.innerText = "Free"; statusEl.className = "inline-block px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300"; }
                
                window.loadUserExamList(searchedUserUid);
            } catch (e) { alert("ê²€ìƒ‰ ì˜¤ë¥˜: " + e.message); }
        };

        window.loadUserExamList = async (uid) => {
            const listContainer = document.getElementById('user-exam-list'); 
            listContainer.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">ì¡°íšŒ ì¤‘...</p>';
            try { 
                const examsQ = query(collection(db, "public_exams"), orderBy("id", "asc")); 
                const examsSnapshot = await getDocs(examsQ); 
                const myExamsRef = collection(db, "users", uid, "my_exams"); 
                const myExamsSnapshot = await getDocs(myExamsRef); 
                const myExamsMap = {}; 
                myExamsSnapshot.forEach(doc => myExamsMap[doc.id] = doc.data()); 
                let html = ''; 
                examsSnapshot.forEach(doc => { 
                    const exam = doc.data(); 
                    const examIdStr = `exam_${String(exam.id).padStart(2,'0')}`; 
                    const userRecord = myExamsMap[examIdStr]; 
                    const hasPermission = !!userRecord; 
                    let statusBadge = '<span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">ë¯¸êµ¬ë§¤</span>'; 
                    let actionBtn = `<button onclick="toggleUserExam('${uid}', '${examIdStr}', '${exam.title}', true)" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-lg text-white font-bold transition-colors">ì§€ê¸‰</button>`; 
                    if (hasPermission) { 
                        const statusText = userRecord.status === 'graded' ? 'ì±„ì ì™„ë£Œ' : (userRecord.status === 'purchased' ? 'êµ¬ë§¤ì™„ë£Œ' : userRecord.status); 
                        const badgeColor = userRecord.status === 'graded' ? 'bg-emerald-900 text-emerald-300' : 'bg-blue-900 text-blue-300'; 
                        statusBadge = `<span class="text-xs px-2 py-1 rounded ${badgeColor}">${statusText}</span>`; 
                        actionBtn = `<button onclick="toggleUserExam('${uid}', '${examIdStr}', '${exam.title}', false)" class="text-xs bg-red-900/50 hover:bg-red-900 border border-red-800 px-3 py-1.5 rounded-lg text-red-200 transition-colors">íšŒìˆ˜</button>`; 
                    } 
                    html += `<div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex items-center justify-between"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="text-xs text-gray-400 font-mono">#${exam.id}íšŒ</span>${statusBadge}</div><p class="text-sm font-bold text-white truncate">${exam.title}</p></div><div class="ml-4">${actionBtn}</div></div>`; 
                }); 
                listContainer.innerHTML = html; 
            } catch (e) { listContainer.innerHTML = `<p class="text-center text-red-400 text-xs">ë¡œë”© ì‹¤íŒ¨</p>`; }
        };

        window.toggleUserExam = async (uid, examDocId, examTitle, grant) => {
            if (grant) { 
                if(!confirm("ê¶Œí•œ ë¶€ì—¬?")) return; 
                try { await setDoc(doc(db, "users", uid, "my_exams", examDocId), { status: 'purchased', title: examTitle, grantedAt: new Date().toISOString(), adminGranted: true }, { merge: true }); window.loadUserExamList(uid); } catch(e) { alert("ì‹¤íŒ¨: " + e.message); } 
            } else { 
                if(!confirm("ê¶Œí•œ íšŒìˆ˜?")) return; 
                try { await deleteDoc(doc(db, "users", uid, "my_exams", examDocId)); window.loadUserExamList(uid); } catch(e) { alert("ì‹¤íŒ¨: " + e.message); } 
            }
        };

        window.resetUserExamData = async () => {
            const targetExamId = document.getElementById('reset-exam-id').value.trim();
            if (!searchedUserUid) return alert("ì‚¬ìš©ì ê²€ìƒ‰ í•„ìš”");
            if (!targetExamId) return alert("ì‹œí—˜ ID ì…ë ¥ í•„ìš”");
            if (!confirm("ì •ë§ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const batch = writeBatch(db);
                batch.delete(doc(db, "users", searchedUserUid, "my_exams", targetExamId));
                batch.delete(doc(db, "users", searchedUserUid, "exam_results", targetExamId));
                await batch.commit();
                alert("ì‚­ì œ ì™„ë£Œ");
                document.getElementById('reset-exam-id').value = '';
                window.loadUserExamList(searchedUserUid);
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        };

        window.updateUserPaidStatus = async (isPaid) => {
            if (!searchedUserUid) return alert("ì‚¬ìš©ì ê²€ìƒ‰ í•„ìš”");
            if (isPaid) { 
                if (!confirm("ìœ ë£Œ ì „í™˜?")) return; 
                try { 
                    const batch = writeBatch(db); 
                    batch.update(doc(db, "users", searchedUserUid), { isPaid: true }); 
                    const exams = await getDocs(collection(db, "public_exams")); 
                    exams.forEach(ed => { 
                        const eid = `exam_${String(ed.data().id).padStart(2,'0')}`; 
                        batch.set(doc(db, "users", searchedUserUid, "my_exams", eid), { status: 'purchased', title: ed.data().title, grantedAt: new Date().toISOString() }, { merge: true }); 
                    }); 
                    await batch.commit(); alert("ì™„ë£Œ"); window.searchUser(); 
                } catch (e) { alert("ì‹¤íŒ¨: " + e.message); } 
            } else { 
                if (confirm("ë¬´ë£Œ ì „í™˜?")) { 
                    let resetData = confirm("ë°ì´í„° ì´ˆê¸°í™”?"); 
                    try { 
                        const batch = writeBatch(db); 
                        batch.update(doc(db, "users", searchedUserUid), { isPaid: false }); 
                        if (resetData) { 
                            const myExams = await getDocs(collection(db, "users", searchedUserUid, "my_exams")); 
                            myExams.forEach(d => batch.delete(d.ref)); 
                            const results = await getDocs(collection(db, "users", searchedUserUid, "exam_results")); 
                            results.forEach(d => batch.delete(d.ref)); 
                        } 
                        await batch.commit(); alert("ì™„ë£Œ"); window.searchUser(); 
                    } catch (e) { alert("ì‹¤íŒ¨: " + e.message); } 
                } 
            }
        };

        // [ë³µì›] ë¬¸í•­ì€í–‰ ê´€ë ¨ í•¨ìˆ˜
        window.updateTopicOptions = function(selectedChapter, selectedTopic = null) {
            const topicSelect = document.getElementById('q-topic');
            topicSelect.innerHTML = '<option value="">ì†Œë‹¨ì› ì„ íƒ</option>';
            if (selectedChapter && TOPIC_MAP[selectedChapter]) {
                TOPIC_MAP[selectedChapter].forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.text = topic;
                    if (selectedTopic === topic) option.selected = true;
                    topicSelect.appendChild(option);
                });
            }
        };
        document.getElementById('q-chapter').addEventListener('change', (e) => {
            window.updateTopicOptions(e.target.value);
        });

        window.openQuestionModal = async (docId = null) => {
            const modal = document.getElementById('question-edit-modal');
            safeSetValue('q-doc-id', docId || '');
            safeSetValue('q-id', docId || `q_${new Date().getFullYear()}_${Math.random().toString(36).substr(2, 5)}`);
            safeSetValue('q-domain', '');
            safeSetValue('q-chapter', '');
            window.updateTopicOptions('');
            safeSetValue('q-difficulty', '2.0'); 
            safeSetValue('q-answer', '');
            
            if (docId) {
                try {
                    const docSnap = await getDoc(doc(db, "questions", docId));
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        const tax = d.taxonomy || {};
                        safeSetValue('q-id', docId);
                        safeSetValue('q-domain', tax.domain || '');
                        const chapter = tax.chapter || '';
                        safeSetValue('q-chapter', chapter);
                        window.updateTopicOptions(chapter, tax.topic);
                        safeSetValue('q-difficulty', d.difficulty || 2.0);
                        safeSetValue('q-answer', d.correctAnswer || '');
                    }
                } catch(e) { console.error(e); }
            }
            modal.classList.remove('hidden');
        };
        
        window.closeQuestionModal = () => document.getElementById('question-edit-modal').classList.add('hidden');
        
        window.saveQuestionData = async () => {
            const newDocId = document.getElementById('q-id').value.trim();
            if (!newDocId) return alert("ID í•„ìˆ˜");
            try {
                const data = {
                    id: newDocId,
                    correctAnswer: Number(document.getElementById('q-answer').value),
                    difficulty: Number(document.getElementById('q-difficulty').value),
                    taxonomy: {
                        subject: "í†µí•©ê³¼í•™",
                        domain: document.getElementById('q-domain').value,
                        chapter: document.getElementById('q-chapter').value,
                        topic: document.getElementById('q-topic').value
                    },
                    updatedAt: new Date().toISOString()
                };
                await setDoc(doc(db, "questions", newDocId), data, { merge: true });
                alert("ì €ì¥ ì™„ë£Œ"); window.closeQuestionModal(); window.loadQuestionsList();
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
        };
        
        window.deleteQuestionData = async (docId) => {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try { await deleteDoc(doc(db, "questions", docId)); alert("ì‚­ì œë¨"); window.loadQuestionsList(); } 
            catch(e) { alert("ì‹¤íŒ¨: " + e.message); }
        };
        
        lucide.createIcons();
    </script>
</body>
</html>