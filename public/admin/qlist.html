<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2028 통합과학 Pro (통합 관리 도구)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .sidebar-item.active { background-color: #e0e7ff; color: #4338ca; border-right: 3px solid #4338ca; font-weight: bold; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* 로그인 오버레이 */
        .overlay-screen { position: fixed; inset: 0; background: #111827; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { width: 100%; max-width: 400px; padding: 2.5rem; border-radius: 1.5rem; background: #1f2937; border: 1px solid #374151; text-align: center; color: white; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 매트릭스 테이블 커스텀 스타일 */
        .matrix-table-container { height: calc(100vh - 120px); overflow-x: auto; }
        th.sticky-col-1, td.sticky-col-1 { position: sticky; left: 0; z-index: 20; border-right: 1px solid #e2e8f0; background-color: white; }
        th.sticky-col-2, td.sticky-col-2 { position: sticky; left: 80px; z-index: 20; border-right: 2px solid #cbd5e1; background-color: white; }
        thead th.sticky-col-1, thead th.sticky-col-2 { z-index: 40; background-color: #f1f5f9; }
        .circle-badge {
            width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: white; margin: 1px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: default;
        }
        .bg-comm { background-color: #94A3B8; } .bg-hypo { background-color: #FBBF24; }
        .bg-design { background-color: #F87171; } .bg-exec { background-color: #34D399; }
        .bg-anal { background-color: #60A5FA; } .bg-conc { background-color: #A78BFA; }

        /* PDF 패널 스타일 */
        #pdf-render-area canvas { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; border-radius: 8px; width: 100%; height: auto; }
        #pdf-panel { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        #pdf-panel.closed { width: 0 !important; opacity: 0; padding: 0; border: none; }
        .menu-tab.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">

    <!-- [1. 로그인 화면] -->
    <div id="login-container" class="overlay-screen">
        <div class="login-card fade-in">
            <div class="bg-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">관리자 로그인</h1>
            <p class="text-gray-400 text-sm mb-8">갓통과 시스템 통합 관리 도구</p>
            <form id="admin-login-form" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">이메일</label>
                    <input type="email" id="admin-email" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 outline-none text-white text-sm focus:border-indigo-500 transition-all" placeholder="admin@example.com" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">비밀번호</label>
                    <input type="password" id="admin-pw" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 outline-none text-white text-sm focus:border-indigo-500 transition-all" placeholder="비밀번호" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 transition-all active:scale-95 flex justify-center items-center gap-2">
                    <span id="btn-text">로그인</span>
                    <div id="btn-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- [2. 로딩 화면] -->
    <div id="loading-overlay" class="overlay-screen hidden">
        <div class="flex flex-col items-center gap-3 text-white text-center">
            <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="font-bold">시스템 데이터를 동기화 중입니다...</p>
        </div>
    </div>

    <!-- [3. 사이드바] -->
    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-30 shadow-lg shrink-0">
        <div class="p-6 bg-indigo-700 text-white shadow-md">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="layout-dashboard"></i> 통합 관리 Pro
            </h1>
            <p class="text-[10px] text-indigo-200 mt-1 uppercase font-bold tracking-widest">2028 Unified Science System</p>
        </div>

        <!-- 메뉴 전환 탭 -->
        <div class="p-3 flex gap-1 bg-indigo-50 border-b border-indigo-100">
            <button onclick="switchMenu('qlist')" id="tab-qlist" class="menu-tab active flex-1 py-2 text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-1.5 border border-indigo-200 shadow-sm">
                <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> 출제 도우미
            </button>
            <button onclick="switchMenu('matrix')" id="tab-matrix" class="menu-tab flex-1 py-2 text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-1.5 border border-indigo-200 shadow-sm">
                <i data-lucide="bar-chart-3" class="w-3.5 h-3.5"></i> 분석 매트릭스
            </button>
        </div>
        
        <!-- 출제 도우미 전용 사이드바 (qlist) -->
        <div id="sidebar-qlist-content" class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-100">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-indigo-800 flex items-center gap-1">
                        <i data-lucide="file-up" class="w-3 h-3"></i> 교재 PDF 로드
                    </label>
                    <button onclick="clearStoredPDF()" id="clear-pdf-btn" class="hidden text-[10px] text-red-500 hover:underline">저장 삭제</button>
                </div>
                <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-[10px] text-slate-500 file:mr-2 file:py-1.5 file:px-2 file:rounded-md file:border-0 file:text-[10px] file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer shadow-sm"/>
                <p id="pdf-status-msg" class="text-[9px] text-indigo-500 mt-1 hidden font-bold">✅ 브라우저 내에 저장됨</p>
            </div>
            <nav class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide" id="sidebar-menu"></nav>
        </div>

        <!-- 분석 매트릭스 전용 사이드바 (matrix) -->
        <div id="sidebar-matrix-content" class="hidden flex-1 flex flex-col p-4 space-y-4 overflow-y-auto">
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <h3 class="text-xs font-bold text-slate-500 mb-3 flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> 매트릭스 안내</h3>
                <p class="text-[11px] text-slate-400 leading-relaxed">회차별 문항 분포를 한눈에 확인합니다. 행동 영역별 색상 배지를 통해 균형 있는 출제를 도와줍니다.</p>
                <button onclick="renderMatrix()" class="w-full mt-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold border border-indigo-200 hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> 데이터 새로고침
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex flex-col gap-2">
            <div class="text-[10px] text-gray-400 mb-1 truncate px-1 flex items-center gap-1">
                <i data-lucide="user" class="w-3 h-3"></i> <span id="display-email">연결됨</span>
            </div>
            <button onclick="handleLogout()" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-600 rounded-lg text-xs hover:bg-gray-100 transition-colors flex items-center justify-center gap-2 shadow-sm">
                로그아웃
            </button>
        </div>
    </aside>

    <!-- [4. 메인 어플리케이션 영역] -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- 섹션 1: 출제 도우미 (qlist) -->
        <section id="menu-qlist-container" class="flex-1 flex overflow-hidden">
            <section class="flex-1 flex flex-col border-r border-gray-200 bg-white min-w-[400px]">
                <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20 h-16">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800" id="header-title">단원 선택 대기</h2>
                        <p class="text-xs text-gray-500 mt-0.5" id="header-desc">질문 리스트를 관리합니다.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="addQuestion()" id="add-btn" class="hidden bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition-all shadow-sm active:scale-95 flex items-center gap-1.5 text-xs font-bold">
                            <i data-lucide="plus" class="w-3 h-3"></i> 질문 추가
                        </button>
                        <button onclick="togglePDF()" class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-200 transition-all shadow-sm active:scale-95 flex items-center gap-1.5 text-xs font-bold border border-slate-200">
                            <span id="pdf-toggle-icon"><i data-lucide="book-open" class="w-3 h-3"></i></span> 
                            <span id="toggle-text">교재 닫기</span>
                        </button>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-6 bg-slate-50 scrollbar-hide" id="question-container">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                        <i data-lucide="layout-list" class="w-12 h-12 mb-3"></i>
                        <p class="text-sm text-center leading-relaxed">왼쪽 메뉴에서 단원을 선택하세요.<br>클라우드와 실시간 동기화됩니다.</p>
                    </div>
                </div>
            </section>

            <section id="pdf-panel" class="w-[50%] flex flex-col bg-gray-100 min-w-[400px] border-l border-gray-200 relative shadow-inner">
                <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20 h-16 shrink-0">
                    <div class="flex items-center gap-2">
                        <span class="bg-red-100 text-red-600 p-1.5 rounded-md"><i data-lucide="file-text" class="w-4 h-4"></i></span>
                        <div>
                            <h2 class="text-sm font-bold text-gray-800">교재 뷰어</h2>
                            <p class="text-[10px] text-gray-500" id="pdf-status-detail">파일 업로드 대기</p>
                        </div>
                    </div>
                    <div id="page-controls" class="hidden flex items-center gap-2">
                         <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200" id="page-indicator">Page -</span>
                    </div>
                </header>
                <div class="flex-1 overflow-y-auto p-6 text-center relative bg-gray-200/50 scrollbar-hide" id="pdf-container">
                    <div id="pdf-render-area" class="w-full max-w-3xl mx-auto"></div>
                </div>
            </section>
        </section>

        <!-- 섹션 2: 분석 매트릭스 (matrix) -->
        <section id="menu-matrix-container" class="hidden flex-1 flex flex-col bg-white overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm h-16 shrink-0 text-gray-800">
                <div class="flex items-center gap-2">
                    <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-md"><i data-lucide="grid-3x3" class="w-4 h-4"></i></span>
                    <h2 class="text-lg font-bold">모의고사 분석 매트릭스</h2>
                </div>
                <div class="flex items-center gap-4 text-[11px] font-medium text-gray-500">
                    <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-comm"></div>의사소통</div>
                    <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-hypo"></div>가설설정</div>
                    <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-design"></div>탐구설계</div>
                    <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-exec"></div>수행/수집</div>
                    <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-anal"></div>변환/해석</div>
                    <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 rounded-full bg-conc"></div>결론도출</div>
                </div>
            </header>
            <div class="flex-1 matrix-table-container scrollbar-hide">
                <table class="w-full text-xs text-left border-collapse min-w-max">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr id="matrix-header-row">
                            <th class="px-2 py-3 sticky-col-1 w-[80px] text-center bg-slate-100 border-b">대단원</th>
                            <th class="px-4 py-3 sticky-col-2 w-[180px] bg-slate-100 shadow-md text-left border-b">내용 요소</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body" class="divide-y divide-gray-100"></tbody>
                    <tfoot id="matrix-footer" class="text-xs text-gray-600"></tfoot>
                </table>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db_fs = getFirestore(app);
        const APP_ID = "godtonggwa_v1";

        // --- 순서 및 구조 정의 (중요: 이 순서가 사이드바와 매트릭스의 절대 기준이 됩니다) ---
        const CURRICULUM_STRUCTURE = {
            "0. 기초 및 첨단과학": ["기본량과 단위", "측정과 어림", "정보와 신호", "인공지능", "로봇", "과학 윤리", "감염병"],
            "1. 물질과 규칙성": ["원소의 생성", "별의 진화", "원소의 주기성", "이온 결합", "공유 결합", "지각과 생명체", "전기적 성질"],
            "2. 시스템과 상호작용": ["지구 시스템", "판 구조론", "중력장 운동", "충돌과 안전", "세포와 물질", "물질대사", "유전자"],
            "3. 변화와 다양성": ["지질 시대", "대멸종", "진화", "생물 다양성", "산화 환원", "산과 염기", "중화 반응", "에너지 출입"],
            "4. 환경과 에너지": ["생태계 구성 요소", "생태계 평형", "대기와 해양", "지구 온난화", "핵융합", "발전과 송전", "에너지 효율"]
        };

        const UNIT_KEYS = Object.keys(CURRICULUM_STRUCTURE);

        // --- 전역 데이터 및 상태 ---
        let scienceDB = null;
        let pdfDoc = null;
        let currentCategory = null;
        let currentTopic = null;
        let isPdfVisible = true;
        let unsubscribeQList = null;

        // 원본 qlist.html 순서가 보장된 기초 데이터 매핑
        const initialScienceData = {
            "0. 기초 및 첨단과학": {
                "기본량과 단위": { pdf: {s:32, e:45}, q: ["SI 기본 단위를 쓰고, 힘(N)의 차원을 유도하시오."] },
                "측정과 어림": { pdf: {s:46, e:52}, q: ["유효숫자의 사칙연산 규칙을 설명하시오."] },
                "정보와 신호": { pdf: {s:53, e:59}, q: ["아날로그 신호를 디지털로 변환하는 3단계를 서술하시오."] },
                "인공지능": { pdf: {s:244, e:250}, q: ["머신러닝의 지도학습과 비지도학습의 차이는?"] },
                "로봇": { pdf: {s:244, e:250}, q: ["로봇의 3대 구성 요소와 기능을 설명하시오."] },
                "과학 윤리": { pdf: {s:251, e:257}, q: ["연구 진실성을 위협하는 위조, 변조, 표절을 정의하시오."] },
                "감염병": { pdf: {s:234, e:243}, q: ["세균과 바이러스의 차이점을 비교하시오."] }
            },
            "1. 물질과 규칙성": {
                "원소의 생성": { pdf: {s:60, e:66}, q: ["빅뱅 후 헬륨 원자핵 생성 시기(3분)의 중요성을 서술하시오."] },
                "별의 진화": { pdf: {s:67, e:75}, q: ["태양 질량 별의 진화 과정을 단계별로 설명하시오."] },
                "원소의 주기성": { pdf: {s:76, e:82}, q: ["알칼리 금속의 반응성 경향을 전자 배치로 설명하시오."] },
                "이온 결합": { pdf: {s:83, e:90}, q: ["이온 결합 물질이 고체에서 전기가 통하지 않는 이유는?"] },
                "공유 결합": { pdf: {s:83, e:90}, q: ["공유 결합 물질의 녹는점이 비교적 낮은 이유를 서술하시오."] },
                "지각과 생명체": { pdf: {s:91, e:97}, q: ["규산염 사면체의 결합 구조가 복잡할수록 풍화에 강한 이유는?"] },
                "전기적 성질": { pdf: {s:98, e:104}, q: ["에너지 띠 이론으로 도체와 반도체를 비교하시오."] }
            },
            "2. 시스템과 상호작용": {
                "지구 시스템": { pdf: {s:105, e:112}, q: ["지구 시스템의 에너지원 3가지를 설명하시오."] },
                "판 구조론": { pdf: {s:113, e:119}, q: ["섭입형 경계에서 나타나는 지각 변동의 특징은?"] },
                "중력장 운동": { pdf: {s:120, e:129}, q: ["수평으로 던진 물체의 운동을 분해하여 설명하시오."] },
                "충돌과 안전": { pdf: {s:130, e:136}, q: ["충격량과 운동량 변화량의 관계를 서술하시오."] },
                "세포와 물질": { pdf: {s:137, e:143}, q: ["세포막을 통한 확산과 삼투의 차이점은?"] },
                "물질대사": { pdf: {s:137, e:143}, q: ["효소가 활성화 에너지에 미치는 영향을 그래프로 설명하시오."] },
                "유전자": { pdf: {s:144, e:150}, q: ["생명 중심 원리(전사, 번역) 과정을 서술하시오."] }
            },
            "3. 변화와 다양성": {
                "지질 시대": { pdf: {s:151, e:157}, q: ["표준 화석과 시상 화석의 조건을 비교하시오."] },
                "대멸종": { pdf: {s:151, e:157}, q: ["가장 큰 규모의 대멸종(3차)의 원인은?"] },
                "진화": { pdf: {s:158, e:166}, q: ["자연 선택에 의한 진화 과정을 서술하시오."] },
                "생물 다양성": { pdf: {s:158, e:166}, q: ["생물 다양성의 3가지 층위를 정의하시오."] },
                "산화 환원": { pdf: {s:167, e:174}, q: ["산화와 환원을 전자의 이동으로 정의하시오."] },
                "산과 염기": { pdf: {s:175, e:182}, q: ["산의 공통적인 성질(3가지 이상)을 서술하시오."] },
                "중화 반응": { pdf: {s:175, e:182}, q: ["중화점에서 온도가 가장 높은 이유는?"] },
                "에너지 출입": { pdf: {s:183, e:190}, q: ["발열 반응과 흡열 반응의 에너지 그래프를 비교하시오."] }
            },
            "4. 환경과 에너지": {
                "생태계 구성 요소": { pdf: {s:191, e:197}, q: ["먹이 사슬과 생태계 구성 요소를 설명하시오."] },
                "생태계 평형": { pdf: {s:198, e:205}, q: ["먹이 그물의 복잡성과 생태계 평형의 관계는?"] },
                "대기와 해양": { pdf: {s:206, e:212}, q: ["엘니뇨 발생 시 동태평양의 기상 변화를 설명하시오."] },
                "지구 온난화": { pdf: {s:206, e:212}, q: ["온실 효과의 원리를 복사 에너지 파장으로 설명하시오."] },
                "핵융합": { pdf: {s:213, e:219}, q: ["핵융합 에너지의 근원인 질량 결손을 설명하시오."] },
                "발전과 송전": { pdf: {s:220, e:226}, q: ["전자기 유도 현상이란 무엇인가?"] },
                "에너지 효율": { pdf: {s:227, e:233}, q: ["열효율이 100%가 될 수 없는 이유를 설명하시오."] }
            }
        };

        const domainColors = { "의사소통": "bg-comm", "가설설정": "bg-hypo", "탐구설계": "bg-design", "탐구수행 및 자료수집": "bg-exec", "자료변환 및 해석": "bg-anal", "결론도출": "bg-conc" };

        // --- 2. 메뉴 전환 ---
        window.switchMenu = (menu) => {
            document.querySelectorAll('.menu-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${menu}`).classList.add('active');
            document.getElementById('menu-qlist-container').classList.add('hidden');
            document.getElementById('menu-matrix-container').classList.add('hidden');
            document.getElementById('sidebar-qlist-content').classList.add('hidden');
            document.getElementById('sidebar-matrix-content').classList.add('hidden');
            document.getElementById(`menu-${menu}-container`).classList.remove('hidden');
            document.getElementById(`sidebar-${menu}-content`).classList.remove('hidden');
            if (menu === 'matrix') renderMatrix();
            lucide.createIcons();
        };

        // --- 3. 인증 및 데이터 연동 ---
        onAuthStateChanged(auth, async (user) => {
            const loginSection = document.getElementById('login-container');
            const loading = document.getElementById('loading-overlay');
            if (user) {
                try {
                    const adminDoc = await getDoc(doc(db_fs, "settings", "admin"));
                    if (adminDoc.exists() && adminDoc.data().adminEmail === user.email) {
                        loginSection.classList.add('hidden');
                        loading.classList.remove('hidden');
                        document.getElementById('display-email').innerText = user.email;
                        startQListSync();
                        loadLocalPDF();
                    } else {
                        alert("관리자 권한이 없습니다.");
                        await signOut(auth);
                    }
                } catch (e) {
                    console.error("Auth Fail:", e);
                    await signOut(auth);
                }
            } else {
                loginSection.classList.remove('hidden');
                loading.classList.add('hidden');
                if (unsubscribeQList) { unsubscribeQList(); unsubscribeQList = null; }
            }
            lucide.createIcons();
        });

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const pw = document.getElementById('admin-pw').value;
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            btnText.innerText = "인증 중...";
            btnSpinner.classList.remove('hidden');
            try { await signInWithEmailAndPassword(auth, email, pw); }
            catch (error) { 
                alert("로그인 실패: 정보를 확인하세요.");
                btnText.innerText = "로그인"; btnSpinner.classList.add('hidden');
            }
        });

        const startQListSync = () => {
            const docRef = doc(db_fs, 'artifacts', APP_ID, 'public', 'data', 'questions', 'mainDB');
            unsubscribeQList = onSnapshot(docRef, (snap) => {
                if (snap.exists()) scienceDB = snap.data().content;
                else { scienceDB = initialScienceData; setDoc(docRef, { content: initialScienceData }); }
                initSidebar();
                document.getElementById('loading-overlay').classList.add('hidden');
                if (currentCategory && currentTopic) renderQuestions();
            });
        };

        // --- 4. PDF 로컬 저장 (IndexedDB) ---
        const IDB_NAME = "ScientificPDFStore";
        const IDB_STORE = "files";
        const IDB_KEY = "last_pdf";
        const openIDB = () => new Promise((res, rej) => {
            const req = indexedDB.open(IDB_NAME, 1);
            req.onupgradeneeded = (e) => e.target.result.createObjectStore(IDB_STORE);
            req.onsuccess = (e) => res(e.target.result);
            req.onerror = (e) => rej(e.target.error);
        });

        const loadLocalPDF = async () => {
            try {
                const idb = await openIDB();
                const tx = idb.transaction(IDB_STORE, "readonly");
                const file = await new Promise(res => {
                    const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
                    req.onsuccess = () => res(req.result);
                });
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function() {
                        const typedarray = new Uint8Array(this.result);
                        pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                        document.getElementById('pdf-status-msg').classList.remove('hidden');
                        document.getElementById('clear-pdf-btn').classList.remove('hidden');
                        document.getElementById('pdf-status-detail').innerText = `로드 완료 (${pdfDoc.numPages}쪽)`;
                        if (currentCategory && currentTopic) renderPDF();
                    };
                    reader.readAsArrayBuffer(file);
                }
            } catch (e) { console.warn("Stored PDF load fail", e); }
        };

        window.clearStoredPDF = async () => {
            if(!confirm("저장된 PDF를 삭제하시겠습니까?")) return;
            const idb = await openIDB();
            const tx = idb.transaction(IDB_STORE, "readwrite");
            tx.objectStore(IDB_STORE).delete(IDB_KEY);
            tx.oncomplete = () => location.reload();
        };

        // --- 5. 출제 도우미 로직 (qlist) ---
        async function saveScienceCloud() {
            if (!auth.currentUser) return;
            const docRef = doc(db_fs, 'artifacts', APP_ID, 'public', 'data', 'questions', 'mainDB');
            await setDoc(docRef, { content: scienceDB }, { merge: true });
        }

        // [순서 완벽 보정] CURRICULUM_STRUCTURE를 사용하여 절대적인 순서로 렌더링
        function initSidebar() {
            const nav = document.getElementById('sidebar-menu');
            nav.innerHTML = '';
            
            UNIT_KEYS.forEach(category => {
                if(!scienceDB[category]) return;
                
                const details = document.createElement('details'); 
                details.open = true;
                const summary = document.createElement('summary');
                summary.className = "px-4 py-2 text-xs font-bold text-gray-500 cursor-pointer list-none flex justify-between bg-gray-50 rounded mb-1";
                summary.innerHTML = `${category} <i data-lucide="chevron-down" class="w-4 h-4"></i>`;
                
                const ul = document.createElement('ul');
                ul.className = "pl-2 border-l-2 border-indigo-100 ml-2 mb-2";
                
                // 해당 단원의 주제들도 구조에 정의된 순서대로 루프
                CURRICULUM_STRUCTURE[category].forEach(topic => {
                    // 클라우드 데이터에 해당 주제가 있는지 확인
                    if (!scienceDB[category][topic]) return;

                    const li = document.createElement('li');
                    li.className = "sidebar-item px-3 py-2 rounded text-sm text-gray-600 hover:bg-indigo-50 cursor-pointer transition-colors";
                    if(currentTopic === topic) li.classList.add('active');
                    li.innerText = topic;
                    li.onclick = () => {
                        currentCategory = category; currentTopic = topic;
                        document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
                        li.classList.add('active');
                        document.getElementById('header-title').innerText = topic;
                        document.getElementById('header-desc').innerText = `${category} 핵심 질문`;
                        document.getElementById('add-btn').classList.remove('hidden');
                        renderQuestions();
                        if (pdfDoc && isPdfVisible) renderPDF();
                    };
                    ul.appendChild(li);
                });
                details.appendChild(summary); 
                details.appendChild(ul);
                nav.appendChild(details);
            });
            lucide.createIcons();
        }

        function renderQuestions() {
            const container = document.getElementById('question-container');
            container.innerHTML = '';
            scienceDB[currentCategory][currentTopic].q.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-lg shadow-sm mb-3 group border border-gray-200 hover:border-indigo-200 transition-all";
                card.innerHTML = `
                    <div class="flex gap-3">
                        <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold flex items-center justify-center mt-0.5 shrink-0">${idx+1}</span>
                        <div class="flex-1">
                            <p class="text-gray-800 leading-relaxed" id="view-${idx}">${q}</p>
                            <textarea id="edit-${idx}" class="hidden w-full p-2 border rounded-lg text-sm bg-indigo-50/30 h-20 outline-none focus:ring-1 focus:ring-indigo-300 transition-all">${q}</textarea>
                            <div class="hidden mt-2 flex justify-end gap-2" id="btns-${idx}">
                                <button onclick="renderQuestions()" class="px-3 py-1 text-xs bg-gray-100 rounded">취소</button>
                                <button onclick="saveEdit(${idx})" class="px-3 py-1 text-xs bg-indigo-600 text-white rounded shadow-sm hover:bg-indigo-700">저장</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="toggleEdit(${idx})" class="text-gray-400 hover:text-blue-500"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="deleteQuestion(${idx})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        window.addQuestion = () => {
            const q = prompt("질문을 입력하세요:");
            if(q) { scienceDB[currentCategory][currentTopic].q.push(q); saveScienceCloud(); renderQuestions(); }
        };
        window.toggleEdit = (idx) => {
            document.getElementById(`view-${idx}`).classList.add('hidden');
            document.getElementById(`edit-${idx}`).classList.remove('hidden');
            document.getElementById(`btns-${idx}`).classList.remove('hidden');
        };
        window.saveEdit = (idx) => {
            scienceDB[currentCategory][currentTopic].q[idx] = document.getElementById(`edit-${idx}`).value;
            saveScienceCloud(); renderQuestions();
        };
        window.deleteQuestion = (idx) => {
            if(confirm("삭제하시겠습니까?")) { scienceDB[currentCategory][currentTopic].q.splice(idx, 1); saveScienceCloud(); renderQuestions(); }
        };

        window.togglePDF = () => {
            const panel = document.getElementById('pdf-panel');
            const icon = document.getElementById('pdf-toggle-icon');
            const text = document.getElementById('toggle-text');
            isPdfVisible = !isPdfVisible;
            if (isPdfVisible) {
                panel.classList.remove('closed');
                icon.innerHTML = '<i data-lucide="book-open" class="w-3 h-3"></i>';
                text.innerText = "교재 닫기";
                if(pdfDoc && currentTopic) setTimeout(renderPDF, 300);
            } else {
                panel.classList.add('closed');
                icon.innerHTML = '<i data-lucide="book" class="w-3 h-3"></i>';
                text.innerText = "교재 보기";
            }
            lucide.createIcons();
        };

        document.getElementById('pdf-upload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const idb = await openIDB();
            const tx = idb.transaction(IDB_STORE, "readwrite");
            tx.objectStore(IDB_STORE).put(file, IDB_KEY);
            tx.oncomplete = () => loadLocalPDF();
        });

        async function renderPDF() {
            const area = document.getElementById('pdf-render-area');
            area.innerHTML = '';
            if(!pdfDoc) return;
            const info = scienceDB[currentCategory][currentTopic].pdf;
            document.getElementById('page-indicator').innerText = `p.${info.s} ~ p.${info.e}`;
            document.getElementById('page-controls').classList.remove('hidden');
            for (let i = info.s; i <= info.e; i++) {
                if (i > pdfDoc.numPages) break;
                const canvas = document.createElement('canvas');
                area.appendChild(canvas);
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
            }
        }

        // --- 6. 분석 매트릭스 로직 ---
        window.renderMatrix = async () => {
            const tbody = document.getElementById('matrix-body');
            const theadRow = document.getElementById('matrix-header-row');
            const tfoot = document.getElementById('matrix-footer');
            try {
                const q = query(collection(db_fs, 'artifacts', APP_ID, 'public', 'data', 'exam_archive'));
                const snap = await getDocs(q);
                let dbData = {}; let roundsSet = new Set();
                snap.forEach(doc => {
                    const item = doc.data();
                    const round = item.exam_round || "미분류";
                    roundsSet.add(round);
                    if (!dbData[round]) dbData[round] = {};
                    if (!dbData[round][item.topic]) dbData[round][item.topic] = [];
                    dbData[round][item.topic].push({ qNum: item.q_num, domain: item.domain || "미분류" });
                });
                const sortedRounds = Array.from(roundsSet).sort();
                theadRow.innerHTML = `
                    <th class="px-2 py-3 sticky-col-1 w-[80px] text-center bg-slate-100 border-b">대단원</th>
                    <th class="px-4 py-3 sticky-col-2 w-[180px] bg-slate-100 shadow-md text-left border-b">내용 요소</th>
                `;
                sortedRounds.forEach(r => theadRow.innerHTML += `<th class="px-2 py-3 text-center min-w-[70px] bg-white border-b font-bold text-indigo-900 border-r border-gray-100">${r}</th>`);
                theadRow.innerHTML += `<th class="px-2 py-3 text-center min-w-[80px] bg-indigo-50 border-b text-indigo-700">누적</th>`;
                tbody.innerHTML = '';
                const stats = Array.from({length: sortedRounds.length}, () => Array(UNIT_KEYS.length).fill(0));

                UNIT_KEYS.forEach((unit, uIdx) => {
                    const topics = CURRICULUM_STRUCTURE[unit];
                    topics.forEach((topic, tIdx) => {
                        const tr = document.createElement('tr'); tr.className = "hover:bg-gray-50 transition-colors group";
                        if (tIdx === 0) {
                            const tdUnit = document.createElement('td'); tdUnit.className = "px-2 py-3 font-bold text-[10px] text-gray-500 bg-white sticky-col-1 align-top pt-4 border-b border-r border-gray-200";
                            tdUnit.rowSpan = topics.length; tdUnit.innerText = unit; tr.appendChild(tdUnit);
                        }
                        const tdTopic = document.createElement('td'); tdTopic.className = "px-4 py-2 text-xs font-medium text-gray-700 bg-white sticky-col-2 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] border-b border-r border-gray-300 truncate";
                        tdTopic.innerText = topic; tr.appendChild(tdTopic);
                        let topicTotal = 0;
                        sortedRounds.forEach((round, rIdx) => {
                            const qs = (dbData[round] && dbData[round][topic]) ? dbData[round][topic] : [];
                            topicTotal += qs.length;
                            stats[rIdx][uIdx] += qs.length;
                            const td = document.createElement('td'); td.className = "px-1 py-1 text-center border-r border-gray-100 border-b align-middle";
                            if (qs.length > 0) {
                                let html = '<div class="flex justify-center gap-1 flex-wrap">';
                                qs.forEach(q => html += `<div class="circle-badge ${domainColors[q.domain] || "bg-gray-400"}" title="${q.domain}">${q.qNum}</div>`);
                                td.innerHTML = html + '</div>';
                            } else td.innerHTML = `<span class="text-gray-200">-</span>`;
                            tr.appendChild(td);
                        });
                        const tdTotal = document.createElement('td'); tdTotal.className = "px-2 py-2 text-center text-xs font-bold bg-indigo-50/20 border-b border-indigo-100";
                        tdTotal.innerText = topicTotal; tr.appendChild(tdTotal);
                        tbody.appendChild(tr);
                    });
                });
                tfoot.innerHTML = '';
                const trFoot = document.createElement('tr');
                trFoot.innerHTML = `<td colspan="2" class="sticky-col-1 px-4 py-3 text-right text-xs font-bold text-gray-600 bg-slate-100 border-t-2 border-gray-300 z-30">단원별 분포</td>`;
                sortedRounds.forEach((_, rIdx) => {
                    const counts = stats[rIdx]; const total = counts.reduce((a,b)=>a+b,0);
                    trFoot.innerHTML += `<td class="px-1 py-2 text-center border-r border-gray-300 border-t-2 bg-slate-100">
                        <div class="text-[8px] font-mono text-gray-500 mb-1">${counts.join('/')}</div>
                        <div class="text-[10px] font-bold ${total === 25 ? "text-gray-700" : "text-red-600"}">계: ${total}</div>
                    </td>`;
                });
                trFoot.innerHTML += `<td class="bg-indigo-100 border-t-2 border-indigo-200"></td>`;
                tfoot.appendChild(trFoot);
                lucide.createIcons();
            } catch (e) { console.error("Matrix Load Error:", e); }
        };

        window.handleLogout = () => { if(confirm("로그아웃 하시겠습니까?")) signOut(auth); };

        lucide.createIcons();
    </script>
</body>
</html>