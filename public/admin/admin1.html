<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°“í†µê³¼ ê´€ë¦¬ì ëª¨ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- ë¡œê·¸ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="login-container" class="w-full max-w-md bg-gray-800 rounded-3xl p-8 border border-gray-700 shadow-2xl fade-in hidden">
        <div class="text-center mb-8">
            <div class="bg-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-2xl font-bold">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <p class="text-gray-400 text-sm mt-2">ë°ì´í„°ë² ì´ìŠ¤ì— ë“±ë¡ëœ ì •ë³´ë¡œ ì ‘ì†í•˜ì„¸ìš”.</p>
        </div>
        
        <form id="admin-login-form" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">ì´ë©”ì¼</label>
                <input type="email" id="admin-email" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 focus:border-indigo-500 outline-none text-white text-sm" placeholder="admin@example.com" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="admin-pw" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 focus:border-indigo-500 outline-none text-white text-sm" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            </div>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 transition-colors flex justify-center items-center gap-2">
                <span id="btn-text">ë¡œê·¸ì¸</span>
                <div id="btn-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
        </form>

        <div class="mt-6 text-center">
            <button onclick="location.href='exam.html'" class="text-gray-500 hover:text-white text-xs underline">
                ëª¨ì˜ê³ ì‚¬ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <!-- ê¶Œí•œ ì—†ìŒ ì»¨í…Œì´ë„ˆ -->
    <div id="access-denied-container" class="w-full max-w-md bg-gray-800 rounded-3xl p-8 border border-red-900/50 shadow-2xl fade-in hidden text-center">
        <div class="bg-red-900/20 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <i data-lucide="lock" class="w-8 h-8 text-red-500"></i>
        </div>
        <h2 class="text-xl font-bold text-white mb-2">ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h2>
        <p class="text-gray-400 text-sm mb-6 leading-relaxed">
            í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì • <span id="denied-email" class="text-white font-bold"></span> ì€<br>
            ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <div class="bg-gray-700/50 p-3 rounded-lg text-xs text-gray-400 mb-6 text-left">
            <p>ğŸ’¡ <strong>íŒ:</strong> ë‹¤ë¥¸ íƒ­ì—ì„œ í•™ìƒ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì¤‘ì´ë¼ë©´, ì—¬ê¸°ì„œ ë¡œê·¸ì•„ì›ƒí•˜ë©´ í•™ìƒ ì°½ë„ ê°™ì´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.</p>
        </div>
        
        <div class="space-y-3">
            <button onclick="location.href='exam.html'" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3.5 rounded-xl transition-colors">
                ëª¨ì˜ê³ ì‚¬ í˜ì´ì§€ë¡œ ì´ë™ (í•™ìƒ ëª¨ë“œ)
            </button>
            <button onclick="forceLogout()" class="w-full bg-red-900/80 hover:bg-red-800 text-white font-bold py-3.5 rounded-xl transition-colors shadow-lg">
                ë¡œê·¸ì•„ì›ƒ í›„ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
        </div>
    </div>

    <!-- ë©”ì¸ ê´€ë¦¬ì ì»¨í…Œì´ë„ˆ -->
    <div id="admin-container" class="w-full max-w-6xl bg-gray-800 rounded-3xl p-8 border border-gray-700 shadow-2xl fade-in hidden space-y-8 my-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="settings" class="w-6 h-6 text-white"></i></div>
                <div>
                    <h1 class="text-2xl font-bold">í†µí•© ê´€ë¦¬ì ëª¨ë“œ</h1>
                    <p class="text-xs text-indigo-300 font-medium" id="admin-badge">Admin Access</p>
                </div>
            </div>
            <button onclick="logout()" class="text-xs text-gray-400 hover:text-white underline">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="flex space-x-1 bg-gray-900 p-1 rounded-xl overflow-x-auto no-scrollbar">
            <button onclick="switchAdminTab('round')" id="btn-tab-round" class="flex-1 py-2 rounded-lg text-sm font-bold bg-gray-700 text-white shadow transition-all whitespace-nowrap px-4">íšŒì°¨ ê´€ë¦¬</button>
            <button onclick="switchAdminTab('exam')" id="btn-tab-exam" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all whitespace-nowrap px-4">ëª¨ì˜ê³ ì‚¬ ê´€ë¦¬</button>
            <button onclick="switchAdminTab('question')" id="btn-tab-question" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all whitespace-nowrap px-4">ë¬¸í•­ ì€í–‰</button>
            <button onclick="switchAdminTab('user')" id="btn-tab-user" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all whitespace-nowrap px-4">ì‚¬ìš©ì ê´€ë¦¬</button>
            <button onclick="switchAdminTab('v2')" id="btn-tab-v2" class="flex-1 py-2 rounded-lg text-sm font-bold text-amber-400 hover:text-amber-300 transition-all whitespace-nowrap px-4 border border-amber-500/30">V2 í€´ì¦ˆDB</button>
        </div>

        <!-- 1. íšŒì°¨ ê´€ë¦¬ ì„¹ì…˜ -->
        <div id="section-round" class="admin-section">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700 relative overflow-hidden">
                <h2 class="text-sm font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="calendar-clock" class="w-4 h-4 text-indigo-400"></i> íšŒì°¨ ì§„í–‰ ê´€ë¦¬</h2>
                <div class="flex items-center justify-center gap-1 mb-4">
                    <span id="current-round-display" class="text-5xl font-black text-indigo-400">-</span>
                    <span class="text-lg text-gray-500 font-bold mt-3">íšŒ</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="updateRound(-1)" class="bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold text-sm transition-colors border border-gray-600">
                        -1 íšŒì°¨
                    </button>
                    <button onclick="updateRound(1)" class="bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm transition-colors shadow-lg">
                        +1 íšŒì°¨
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-4 text-center">
                    í˜„ì¬ íšŒì°¨ê¹Œì§€ 'ì§€ë‚œ ì‹œí—˜'ìœ¼ë¡œ, ë‹¤ìŒ íšŒì°¨ëŠ” 'ì ‘ìˆ˜ ì¤‘'ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <!-- 2. ëª¨ì˜ê³ ì‚¬ ê´€ë¦¬ ì„¹ì…˜ -->
        <div id="section-exam" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="database" class="w-4 h-4 text-emerald-400"></i> ëª¨ì˜ê³ ì‚¬ ëª©ë¡ (exams)</h2>
                    <div class="flex gap-2">
                        <button onclick="openExamEditModal()" class="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg font-bold transition-colors flex items-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> ìƒˆ ì‹œí—˜ ìƒì„±
                        </button>
                        <button onclick="loadExamList()" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-lg border border-gray-600 transition-colors">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
                
                <div id="exam-list-container" class="space-y-3 max-h-[500px] overflow-y-auto hide-scrollbar mb-4">
                    <p class="text-center text-gray-500 text-sm py-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <div class="pt-4 border-t border-gray-800">
                    <button onclick="batchUpdateYear()" class="w-full py-3 bg-emerald-900/30 hover:bg-emerald-900/50 border border-emerald-800 text-emerald-400 rounded-xl text-xs font-bold transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> ëª¨ë“  ë°ì´í„°ì˜ '2024'ë¥¼ '2026'ìœ¼ë¡œ ì¼ê´„ ë³€ê²½
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. ë¬¸í•­ ì€í–‰ ê´€ë¦¬ ì„¹ì…˜ -->
        <div id="section-question" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700 space-y-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4 text-purple-400"></i> ë¬¸í•­ ì€í–‰ ê´€ë¦¬</h2>
                        <span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full" id="total-questions-count">0ê°œ</span>
                    </div>
                    <button onclick="openQuestionModal()" class="text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded-lg font-bold transition-colors flex items-center gap-1">
                        <i data-lucide="plus" class="w-3 h-3"></i> ìƒˆ ë¬¸í•­ ì¶”ê°€
                    </button>
                </div>

                <div id="questions-list-container" class="space-y-3 max-h-[500px] overflow-y-auto hide-scrollbar">
                    <p class="text-center text-gray-500 text-xs py-4">ë¬¸í•­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- 4. ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
        <div id="section-user" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700 space-y-6">
                
                <div>
                    <h2 class="text-sm font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="search" class="w-4 h-4 text-blue-400"></i> ì‚¬ìš©ì ê²€ìƒ‰</h2>
                    <div class="flex gap-2">
                        <input type="text" id="search-user-input" class="flex-1 px-4 py-2 rounded-lg bg-gray-800 border border-gray-600 focus:border-blue-500 outline-none text-white text-sm" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„">
                        <button onclick="searchUser()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold">ê²€ìƒ‰</button>
                    </div>
                </div>

                <div id="user-manage-panel" class="hidden border-t border-gray-700 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-xs text-gray-400">ì‚¬ìš©ì ì´ë¦„</p>
                            <p id="manage-user-name" class="text-lg font-bold text-white">í™ê¸¸ë™</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">ê³„ì • (ì´ë©”ì¼)</p>
                            <span id="manage-user-email" class="text-xs text-gray-300">-</span>
                            <br/>
                            <span id="manage-user-joined" class="text-xs text-gray-500">-</span>
                        </div>
                    </div>

                    <div class="mb-6 bg-gray-800 p-4 rounded-xl border border-gray-600">
                        <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">ë©¤ë²„ì‹­ ê¶Œí•œ ì¼ê´„ ë³€ê²½</h3>
                        <div class="flex items-center justify-between">
                            <span id="manage-user-status" class="inline-block px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300">Free</span>
                            <div class="flex gap-2">
                                <button onclick="updateUserPaidStatus(false)" class="text-xs border border-gray-500 text-gray-300 px-3 py-1.5 rounded-lg hover:bg-gray-700 transition-colors">ë¬´ë£Œë¡œ ì „í™˜</button>
                                <button onclick="updateUserPaidStatus(true)" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-50 transition-colors">ìœ ë£Œë¡œ ì „í™˜</button>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase flex items-center gap-2">
                        <i data-lucide="check-circle-2" class="w-3 h-3"></i> íšŒì°¨ë³„ ê¶Œí•œ ê´€ë¦¬
                    </h3>
                    <div id="user-exam-list" class="space-y-2 max-h-[350px] overflow-y-auto hide-scrollbar mb-6">
                        <p class="text-center text-gray-500 text-xs py-4">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <div class="pt-6 border-t border-gray-700">
                        <h3 class="text-xs font-bold text-red-400 mb-2 uppercase flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-3 h-3"></i> ìœ„í—˜ êµ¬ì—­ (ë°ì´í„° ì‚­ì œ)
                        </h3>
                        <div class="bg-red-900/10 p-3 rounded-xl border border-red-900/30">
                            <div class="flex gap-2">
                                <input type="text" id="reset-exam-id" class="flex-1 px-4 py-2 rounded-lg bg-gray-800 border border-gray-600 focus:border-red-500 outline-none text-white text-sm" placeholder="ì‚­ì œí•  ì‹œí—˜ ID (ì˜ˆ: exam_01)">
                                <button onclick="resetUserExamData()" class="bg-red-900/50 hover:bg-red-900 border border-red-800 text-red-200 px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-colors">
                                    ì‚­ì œ
                                </button>
                            </div>
                            <p class="text-[10px] text-gray-500 mt-2">* í•´ë‹¹ íšŒì°¨ì˜ êµ¬ë§¤ ê¸°ë¡(my_exams)ê³¼ ì„±ì í‘œ(exam_results)ê°€ ëª¨ë‘ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <!-- 5. V2 ë¬¸ì œ ê´€ë¦¬ ì„¹ì…˜ -->
        <div id="section-v2" class="admin-section hidden">
            <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-6 border border-amber-500/30">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5 text-amber-500"></i> V2 ë¬¸ì œ ê´€ë¦¬
                        </h2>
                        <p class="text-xs text-amber-200/60 mt-1">ì´ <span id="v2-total-count" class="font-bold text-white">0</span>ê°œì˜ ë¬¸ì œê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <button onclick="openV2EditModal()" class="bg-amber-600 hover:bg-amber-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 shadow-lg">
                        <i data-lucide="plus" class="w-3 h-3"></i> ë¬¸ì œ ì¶”ê°€
                    </button>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-2" id="v2-filters">
                </div>

                <div id="v2-list-container" class="space-y-3 max-h-[600px] overflow-y-auto hide-scrollbar bg-black/20 p-2 rounded-xl border border-white/5">
                    <p class="text-center text-gray-500 text-xs py-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ìƒë‹¨ í•„í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- ëª¨ë‹¬: V2 ë¬¸ì œ í¸ì§‘ -->
    <div id="v2-edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[90] hidden p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl p-6 border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">V2 ë¬¸ì œ í¸ì§‘</h3>
            <input type="hidden" id="v2-doc-id">
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ë‹¨ì›</label>
                    <select id="v2-unit-id" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-amber-500 outline-none">
                        <option value="unit_01">1. ê³¼í•™ì˜ ê¸°ì´ˆ</option>
                        <option value="unit_02">2. ì›ì†Œì˜ í˜•ì„±</option>
                        <option value="unit_03">3. ë¬¼ì§ˆì˜ êµ¬ì¡°</option>
                        <option value="unit_04">4. ì§€êµ¬ ì‹œìŠ¤í…œ</option>
                        <option value="unit_05">5. ì—­í•™ì  ì‹œìŠ¤í…œ</option>
                        <option value="unit_06">6. ìƒëª… ì‹œìŠ¤í…œ</option>
                        <option value="unit_07">7. ì§€ì§ˆê³¼ ìƒë¬¼</option>
                        <option value="unit_08">8. í™”í•™ ë³€í™”</option>
                        <option value="unit_09">9. ìƒíƒœê³„ì™€ ê¸°í›„</option>
                        <option value="unit_10">10. ì—ë„ˆì§€</option>
                        <option value="unit_11">11. ê³¼í•™ê³¼ ë¯¸ë˜</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ë¬¸ì œ (Q)</label>
                    <textarea id="v2-q" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white h-20 focus:border-amber-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì •ë‹µ (A)</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="setV2Answer('O')" id="btn-ans-o" class="flex-1 py-2 rounded border border-gray-600 text-gray-400 text-sm hover:bg-gray-700">O</button>
                        <button type="button" onclick="setV2Answer('X')" id="btn-ans-x" class="flex-1 py-2 rounded border border-gray-600 text-gray-400 text-sm hover:bg-gray-700">X</button>
                    </div>
                    <input type="hidden" id="v2-a">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">í•´ì„¤ (Exp)</label>
                    <textarea id="v2-exp" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white h-20 focus:border-amber-500 outline-none"></textarea>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeV2Modal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded text-sm hover:bg-gray-600">ì·¨ì†Œ</button>
                <button onclick="saveV2Question()" class="flex-1 py-2 bg-amber-600 text-white rounded text-sm font-bold hover:bg-amber-500">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ì‹œí—˜ ì •ë³´ ìˆ˜ì • -->
    <div id="edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden p-4">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl p-6 border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">ì‹œí—˜ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="edit-doc-id">
            <div class="space-y-3">
                <div id="edit-id-container">
                    <label class="text-xs text-gray-400 block mb-1">ì‹œí—˜ ID (í•„ìˆ˜)</label>
                    <input id="edit-id-input" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none" placeholder="ì˜ˆ: exam_01">
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì œëª© (Title)</label>
                    <input id="edit-title" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ë¶€ì œëª© (SubTitle)</label>
                    <input id="edit-subtitle" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ê°€ê²© (Price)</label>
                    <input type="number" id="edit-price" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì‹œí–‰ ë‚ ì§œ (Date)</label>
                    <input type="date" id="edit-date" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none">
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700">
                <button onclick="openExamQuestionsModal()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2 mb-4">
                    <i data-lucide="list-checks" class="w-4 h-4"></i> ë¬¸í•­ êµ¬ì„± ë° ë°°ì  ê´€ë¦¬
                </button>
                <div class="flex gap-2">
                    <button onclick="closeEditModal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded-lg text-sm hover:bg-gray-600">ì·¨ì†Œ</button>
                    <button onclick="saveExamData()" class="flex-1 py-2 bg-emerald-600 text-white rounded-lg text-sm font-bold hover:bg-emerald-500">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ë¬¸í•­ êµ¬ì„± ê´€ë¦¬ -->
    <div id="exam-questions-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[80] hidden p-4 overflow-y-auto">
        <div class="bg-gray-800 w-full max-w-5xl rounded-2xl p-6 border border-gray-600 shadow-2xl my-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-emerald-400"></i> ë¬¸í•­ êµ¬ì„± (25ë¬¸í•­)</h3>
                    <p class="text-sm text-gray-400 mt-1">Questions ì»¬ë ‰ì…˜ì˜ ë¬¸í•­ IDë¥¼ ì—°ê²°í•˜ì—¬ ì‹œí—˜ì„ êµ¬ì„±í•©ë‹ˆë‹¤.</p>
                </div>
                <button onclick="closeExamQuestionsModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="mb-4 bg-gray-700/50 p-3 rounded-lg flex items-center gap-2 text-xs text-gray-300">
                <i data-lucide="info" class="w-4 h-4 text-blue-400"></i>
                <span>ë¬¸í•­ IDë¥¼ ì…ë ¥í•˜ê³  ì—”í„°/í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ë°°ì ê³¼ ì •ë‹µì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (ìˆ˜ë™ ë³€ê²½ ê°€ëŠ¥)</span>
            </div>

            <div id="mapping-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-3 max-h-[60vh] overflow-y-auto p-1 custom-scrollbar">
                </div>

            <div class="flex justify-end mt-6 pt-4 border-t border-gray-700">
                <button onclick="closeExamQuestionsModal()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-500 shadow-lg">í™•ì¸ (ì„ì‹œ ì €ì¥)</button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ë¬¸í•­ í¸ì§‘ (Question Edit) -->
    <div id="question-edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden p-4 overflow-y-auto">
        <div class="bg-gray-800 w-full max-w-lg rounded-2xl p-6 border border-gray-600 shadow-2xl my-auto">
            <h3 class="text-lg font-bold text-white mb-4">ë¬¸í•­ ì •ë³´ (Questions)</h3>
            <input type="hidden" id="q-doc-id"> 
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ë¬¸í•­ ID (ì˜ˆ: q_2026_phys_01)</label>
                    <input id="q-id" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none" placeholder="ìë™ ìƒì„± ê°€ëŠ¥">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ëŒ€ë‹¨ì› (Domain)</label>
                        <select id="q-domain" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ë¬¼ë¦¬í•™">ë¬¼ë¦¬í•™</option>
                            <option value="í™”í•™">í™”í•™</option>
                            <option value="ìƒëª…ê³¼í•™">ìƒëª…ê³¼í•™</option>
                            <option value="ì§€êµ¬ê³¼í•™">ì§€êµ¬ê³¼í•™</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ì¤‘ë‹¨ì› (Chapter)</label>
                        <select id="q-chapter" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ê³¼í•™ì˜ ê¸°ì´ˆ">ê³¼í•™ì˜ ê¸°ì´ˆ</option>
                            <option value="ë¬¼ì§ˆê³¼ ê·œì¹™ì„±">ë¬¼ì§ˆê³¼ ê·œì¹™ì„±</option>
                            <option value="ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©">ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©</option>
                            <option value="ë³€í™”ì™€ ë‹¤ì–‘ì„±">ë³€í™”ì™€ ë‹¤ì–‘ì„±</option>
                            <option value="í™˜ê²½ê³¼ ì—ë„ˆì§€">í™˜ê²½ê³¼ ì—ë„ˆì§€</option>
                            <option value="ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ">ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-400 block mb-1">ì†Œë‹¨ì›/ìœ í˜• (Topic)</label>
                    <select id="q-topic" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                        <option value="">ì¤‘ë‹¨ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <!-- í–‰ë™ ì˜ì—­ (admin.html ê³ ìœ  í•„ë“œ) -->
                <div class="mb-4">
                    <label class="block text-gray-400 text-xs font-bold mb-2">í–‰ë™ ì˜ì—­ (ê³¼í•™ì  íƒêµ¬ ì—­ëŸ‰)</label>
                    <select id="question-behavioral-domain" class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded-xl p-3 focus:outline-none focus:border-purple-500 transition-colors">
                        <option value="">-- í–‰ë™ ì˜ì—­ ì„ íƒ --</option>
                        <option value="ì˜ì‚¬ì†Œí†µ">ì´í•´ì™€ ì ìš©</option>
                        <option value="ì˜ì‚¬ì†Œí†µ">ì˜ì‚¬ì†Œí†µ</option>
                        <option value="ê°€ì„¤ ì„¤ì •">ê°€ì„¤ ì„¤ì •</option>
                        <option value="íƒêµ¬ ì„¤ê³„">íƒêµ¬ ì„¤ê³„</option>
                        <option value="íƒêµ¬ ìˆ˜í–‰ ë° ìë£Œ ìˆ˜ì§‘">íƒêµ¬ ìˆ˜í–‰ ë° ìë£Œ ìˆ˜ì§‘</option>
                        <option value="ìë£Œ ë³€í™˜ ë° í•´ì„">ìë£Œ ë³€í™˜ ë° í•´ì„</option>
                        <option value="ê²°ë¡  ë„ì¶œ">ê²°ë¡  ë„ì¶œ</option>
                    </select>
                    <p class="text-gray-500 text-[10px] mt-1">* 2022 ê°œì • êµìœ¡ê³¼ì •ì˜ íƒêµ¬ ê¸°ëŠ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ë‚œì´ë„ / ë°°ì </label>
                        <select id="q-difficulty" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="1.5">1.5ì  (í•˜)</option>
                            <option value="2.0">2.0ì  (ì¤‘)</option>
                            <option value="2.5">2.5ì  (ìƒ)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ì •ë‹µ (Correct Answer)</label>
                        <input type="number" id="q-answer" min="1" max="5" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 outline-none" placeholder="1~5">
                    </div>
                </div>
                
                <div class="bg-gray-700/30 p-3 rounded-lg border border-gray-600">
                    <p class="text-xs font-bold text-gray-400 mb-2">ëˆ„ì  í†µê³„ (ìë™ ê³„ì‚°)</p>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div>
                            <span class="block text-gray-500">ì´ ì‘ì‹œ</span>
                            <span class="font-bold text-white" id="stat-total">0</span>
                        </div>
                        <div>
                            <span class="block text-gray-500">ì •ë‹µ ìˆ˜</span>
                            <span class="font-bold text-white" id="stat-correct">0</span>
                        </div>
                        <div>
                            <span class="block text-gray-500">ì •ë‹µë¥ </span>
                            <span class="font-bold text-indigo-400" id="stat-accuracy">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="closeQuestionModal()" class="flex-1 py-3 bg-gray-700 text-gray-300 rounded-xl text-sm font-bold hover:bg-gray-600">ì·¨ì†Œ</button>
                <button onclick="saveQuestionData()" class="flex-1 py-3 bg-purple-600 text-white rounded-xl text-sm font-bold hover:bg-purple-500">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, updateDoc, onSnapshot, collection, query, where, getDocs, orderBy, writeBatch, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const V2_APP_ID = "godtonggwa_v1";

        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentRound = 0;
        let unsubscribe = null;
        let searchedUserUid = null; 
        let tempExamQuestions = Array(25).fill(null);
        let v2CurrentFilter = 'all'; 

        const UNIT_NAMES = {
            unit_01: '1. ê³¼í•™ì˜ ê¸°ì´ˆ',
            unit_02: '2. ì›ì†Œì˜ í˜•ì„±',
            unit_03: '3. ë¬¼ì§ˆì˜ êµ¬ì¡°',
            unit_04: '4. ì§€êµ¬ ì‹œìŠ¤í…œ',
            unit_05: '5. ì—­í•™ì  ì‹œìŠ¤í…œ',
            unit_06: '6. ìƒëª… ì‹œìŠ¤í…œ',
            unit_07: '7. ì§€ì§ˆê³¼ ìƒë¬¼',
            unit_08: '8. í™”í•™ ë³€í™”',
            unit_09: '9. ìƒíƒœê³„ì™€ ê¸°í›„',
            unit_10: '10. ì—ë„ˆì§€',
            unit_11: '11. ê³¼í•™ê³¼ ë¯¸ë˜'
        };

        const TOPIC_MAP = {
            "ê³¼í•™ì˜ ê¸°ì´ˆ": ["ê¸°ë³¸ëŸ‰ê³¼ ë‹¨ìœ„", "ì¸¡ì •ê³¼ ì–´ë¦¼", "ì •ë³´ì™€ ì‹ í˜¸"],
            "ë¬¼ì§ˆê³¼ ê·œì¹™ì„±": ["ì›ì†Œ í˜•ì„±", "ë³„ì˜ ì§„í™”", "ì›ì†Œì˜ ì£¼ê¸°ì„±", "í™”í•™ ê²°í•©", "ì§€ê°ê³¼ ìƒëª…ì²´ êµ¬ì„± ë¬¼ì§ˆì˜ ê·œì¹™ì„±"],
            "ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©": ["ì§€êµ¬ì‹œìŠ¤í…œì˜ êµ¬ì„±ê³¼ ìƒí˜¸ì‘ìš©", "íŒêµ¬ì¡°ë¡ ê³¼ ì§€ê° ë³€ë™", "ì¤‘ë ¥ì¥ ë‚´ì˜ ìš´ë™", "ì¶©ê²©ëŸ‰ê³¼ ìš´ë™ëŸ‰", "ìƒëª… ì‹œìŠ¤í…œì˜ ê¸°ë³¸ ë‹¨ìœ„", "ë¬¼ì§ˆëŒ€ì‚¬", "ìœ ì „ìì™€ ë‹¨ë°±ì§ˆ", "ë¬¼ì§ˆì˜ ì „ê¸°ì  ì„±ì§ˆ"],
            "ë³€í™”ì™€ ë‹¤ì–‘ì„±": ["ì§€ì§ˆì‹œëŒ€ì˜ ìƒë¬¼ê³¼ í™”ì„", "ì§€ì§ˆì‹œëŒ€ í™˜ê²½ ë³€í™”ì™€ ëŒ€ë©¸ì¢…", "ìì—°ì„ íƒ", "ìƒë¬¼ë‹¤ì–‘ì„±", "ì‚°í™”ì™€ í™˜ì›", "ì¤‘í™” ë°˜ì‘", "ë¬¼ì§ˆ ë³€í™”ì—ì„œ ì—ë„ˆì§€ ì¶œì…"],
            "í™˜ê²½ê³¼ ì—ë„ˆì§€": ["ìƒíƒœê³„ êµ¬ì„± ìš”ì†Œ", "ìƒíƒœê³„ í‰í˜•", "ëŒ€ê¸°ì™€ í•´ì–‘ì˜ ìƒí˜¸ì‘ìš©", "ì˜¨ì‹¤ê¸°ì²´ì™€ ì§€êµ¬ì˜¨ë‚œí™”", "í•µìœµí•©", "ë°œì „", "ì—ë„ˆì§€ ì „í™˜ê³¼ íš¨ìœ¨"],
            "ê³¼í•™ê³¼ ë¯¸ë˜ ì‚¬íšŒ": ["ê°ì—¼ë³‘ê³¼ ë³‘ì›ì²´", "ì¸ê³µì§€ëŠ¥ê³¼ ê³¼í•™ íƒêµ¬", "ë¡œë´‡", "ê³¼í•™ê¸°ìˆ ê³¼ ìœ¤ë¦¬"]
        };

        onAuthStateChanged(auth, async (user) => {
            const loginContainer = document.getElementById('login-container');
            const adminContainer = document.getElementById('admin-container');
            const deniedContainer = document.getElementById('access-denied-container');
            
            if (user) {
                try {
                    const adminDoc = await getDoc(doc(db, "settings", "admin"));
                    if (adminDoc.exists() && adminDoc.data().adminEmail === user.email) {
                        loginContainer.classList.add('hidden');
                        deniedContainer.classList.add('hidden');
                        adminContainer.classList.remove('hidden');
                        document.getElementById('admin-badge').innerText = user.email;
                        if (!unsubscribe) initAdminListener();
                        window.loadExamList();
                        createV2Filters();
                    } else {
                        loginContainer.classList.add('hidden');
                        adminContainer.classList.add('hidden');
                        deniedContainer.classList.remove('hidden');
                        document.getElementById('denied-email').innerText = user.email;
                        if (unsubscribe) { unsubscribe(); unsubscribe = null; }
                    }
                } catch (error) {
                    console.error("DB Check Error:", error);
                    alert("DB ì—°ê²° ì˜¤ë¥˜: " + error.message);
                    await signOut(auth);
                }
            } else {
                loginContainer.classList.remove('hidden');
                adminContainer.classList.add('hidden');
                deniedContainer.classList.add('hidden');
                if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            }
        });

        window.switchAdminTab = (tabName) => {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            ['round', 'exam', 'user', 'question', 'v2'].forEach(t => {
                const btn = document.getElementById(`btn-tab-${t}`);
                if (!btn) return;
                if (t === tabName) {
                    if (t === 'v2') {
                        btn.className = "flex-1 py-2 px-4 rounded-lg text-sm font-bold bg-amber-600 text-white border border-amber-600 whitespace-nowrap";
                        window.loadV2Questions(v2CurrentFilter); 
                    } else {
                        btn.className = "flex-1 py-2 px-4 rounded-lg text-sm font-bold bg-gray-700 text-white shadow whitespace-nowrap";
                    }
                    if(t === 'exam') window.loadExamList();
                    if(t === 'question') window.loadQuestionsList();
                } else {
                    if (t === 'v2') {
                        btn.className = "flex-1 py-2 px-4 rounded-lg text-sm font-bold text-amber-500 hover:text-amber-400 border border-amber-500/30 whitespace-nowrap";
                    } else {
                        btn.className = "flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-white whitespace-nowrap";
                    }
                }
            });
        };

        function createV2Filters() {
            const container = document.getElementById('v2-filters');
            if(!container) return;
            let html = `<button onclick="loadV2Questions('all')" class="v2-filter-btn px-3 py-1.5 rounded-lg text-xs font-bold bg-amber-600 text-white whitespace-nowrap">ì „ì²´</button>`;
            for(let i=1; i<=11; i++) {
                const id = `unit_${String(i).padStart(2,'0')}`;
                html += `<button onclick="loadV2Questions('${id}')" class="v2-filter-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 text-gray-400 border border-gray-700 whitespace-nowrap">${i}ë‹¨ì›</button>`;
            }
            container.innerHTML = html;
        }

        window.loadV2Questions = async (filter) => {
            v2CurrentFilter = filter;
            const container = document.getElementById('v2-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 text-xs py-10">ë¡œë”© ì¤‘...</p>';
            document.querySelectorAll('.v2-filter-btn').forEach(btn => {
                if((filter === 'all' && btn.innerText === 'ì „ì²´') || (filter !== 'all' && btn.getAttribute('onclick').includes(filter))) {
                    btn.classList.remove('bg-gray-800', 'text-gray-400');
                    btn.classList.add('bg-amber-600', 'text-white', 'border-amber-600');
                } else {
                    btn.classList.add('bg-gray-800', 'text-gray-400');
                    btn.classList.remove('bg-amber-600', 'text-white', 'border-amber-600');
                }
            });
            try {
                const colRef = collection(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems');
                let q = filter === 'all' ? query(colRef, orderBy('createdAt', 'desc'), limit(100)) : query(colRef, where('unitId', '==', filter));
                const snapshot = await getDocs(q);
                document.getElementById('v2-total-count').innerText = snapshot.size;
                if (snapshot.empty) { container.innerHTML = '<p class="text-center text-gray-500 text-xs py-10">ë¬¸ì œ ì—†ìŒ</p>'; return; }
                let html = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const color = d.a === 'O' ? 'text-blue-400' : 'text-red-400';
                    const unitLabel = UNIT_NAMES[d.unitId] || d.unitId;
                    html += `<div class="bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-amber-500/50 transition-colors group">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded font-mono">${unitLabel}</span>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openV2EditModal('${doc.id}')" class="text-gray-400 hover:text-white"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="deleteV2Question('${doc.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <p class="text-sm font-bold text-white mb-2">${d.q}</p>
                            <div class="flex gap-4 text-xs text-gray-400">
                                <span class="font-bold ${color}">ì •ë‹µ: ${d.a}</span>
                                <span class="truncate max-w-[200px]">${d.exp || ''}</span>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
                lucide.createIcons();
            } catch(e) { container.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨'; console.error(e); }
        };

        window.openV2EditModal = async (docId = null) => {
            document.getElementById('v2-edit-modal').classList.remove('hidden');
            document.getElementById('v2-doc-id').value = docId || '';
            document.getElementById('v2-q').value = '';
            document.getElementById('v2-exp').value = '';
            window.setV2Answer('O');
            if(v2CurrentFilter !== 'all') document.getElementById('v2-unit-id').value = v2CurrentFilter;
            if(docId) {
                try {
                    const docSnap = await getDoc(doc(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems', docId));
                    if(docSnap.exists()) {
                        const d = docSnap.data();
                        document.getElementById('v2-unit-id').value = d.unitId;
                        document.getElementById('v2-q').value = d.q;
                        document.getElementById('v2-exp').value = d.exp;
                        window.setV2Answer(d.a);
                    }
                } catch(e) { alert("ë¡œë“œ ì‹¤íŒ¨"); }
            }
        };

        window.closeV2Modal = () => document.getElementById('v2-edit-modal').classList.add('hidden');
        window.setV2Answer = (ans) => {
            document.getElementById('v2-a').value = ans;
            const oBtn = document.getElementById('btn-ans-o');
            const xBtn = document.getElementById('btn-ans-x');
            if(ans === 'O') { oBtn.className = "flex-1 py-2 rounded border border-blue-600 bg-blue-600 text-white font-bold"; xBtn.className = "flex-1 py-2 rounded border border-gray-600 text-gray-400"; }
            else { oBtn.className = "flex-1 py-2 rounded border border-gray-600 text-gray-400"; xBtn.className = "flex-1 py-2 rounded border border-red-600 bg-red-600 text-white font-bold"; }
        };

        window.saveV2Question = async () => {
            const docId = document.getElementById('v2-doc-id').value;
            const unitId = document.getElementById('v2-unit-id').value;
            const q = document.getElementById('v2-q').value;
            const a = document.getElementById('v2-a').value;
            const exp = document.getElementById('v2-exp').value;
            const colRef = collection(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems');
            const data = { unitId, q, a, exp, type: 'OX', createdAt: new Date().toISOString() };
            try {
                if(docId) await updateDoc(doc(colRef, docId), data);
                else await addDoc(colRef, data);
                alert("ì €ì¥ë¨");
                window.closeV2Modal();
                window.loadV2Questions(v2CurrentFilter);
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
        };

        window.deleteV2Question = async (id) => {
            if(!confirm("ì‚­ì œ?")) return;
            try { await deleteDoc(doc(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems', id)); window.loadV2Questions(v2CurrentFilter); } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
        };

        function initAdminListener() {
            unsubscribe = onSnapshot(doc(db, "settings", "global"), (docSnapshot) => {
                if (docSnapshot.exists()) { currentRound = docSnapshot.data().latestRound || 0; document.getElementById('current-round-display').innerText = currentRound; }
                else { document.getElementById('current-round-display').innerText = "0"; currentRound = 0; setDoc(doc(db, "settings", "global"), { latestRound: 0 }, { merge: true }); }
            });
        }

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            btnText.textContent = "í™•ì¸ ì¤‘..."; btnSpinner.classList.remove('hidden');
            try { await signInWithEmailAndPassword(auth, document.getElementById('admin-email').value, document.getElementById('admin-pw').value); }
            catch (error) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message); btnText.textContent = "ë¡œê·¸ì¸"; btnSpinner.classList.add('hidden'); }
        });

        window.logout = () => { if (unsubscribe) unsubscribe(); signOut(auth); };
        window.forceLogout = () => signOut(auth);
        
        window.updateRound = async (delta) => { 
            const newValue = currentRound + delta; 
            if(newValue < 0 || newValue > 24) return alert("ë²”ìœ„ ì´ˆê³¼"); 
            if(confirm("ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
                try { document.getElementById('current-round-display').innerText = newValue; currentRound = newValue; await setDoc(doc(db, "settings", "global"), { latestRound: newValue }, { merge: true }); }
                catch(e) { alert("ì˜¤ë¥˜: "+e.message); } 
            } 
        };

        window.loadExamList = async () => {
            const container = document.getElementById('exam-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">ë¡œë”© ì¤‘...</p>';
            try {
                const q = query(collection(db, "public_exams"), orderBy("id", "asc"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { container.innerHTML = '<p class="text-center text-gray-500 text-xs">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `<div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center group hover:border-gray-600 transition-colors">
                            <div class="flex-1 min-w-0 mr-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-gray-700 text-gray-300 text-[10px] px-1.5 py-0.5 rounded font-mono">${doc.id}</span>
                                    <span class="text-xs text-emerald-400 font-bold">#${data.id}</span>
                                </div>
                                <h4 class="text-sm font-bold text-white truncate">${data.title}</h4>
                            </div>
                            <button onclick="openExamEditModal('${doc.id}')" class="p-2 bg-gray-700 hover:bg-emerald-600 rounded-lg text-gray-300 hover:text-white transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        </div>`;
                });
                container.innerHTML = html; lucide.createIcons();
            } catch (e) { container.innerHTML = `<p class="text-center text-red-400 text-xs">ë¡œë”© ì‹¤íŒ¨</p>`; }
        };

        window.loadQuestionsList = async () => {
            const container = document.getElementById('questions-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">ë¡œë”© ì¤‘...</p>';
            try {
                const q = query(collection(db, "questions"), limit(50)); 
                const snapshot = await getDocs(q);
                document.getElementById('total-questions-count').innerText = `${snapshot.size}ê°œ (ìµœê·¼)`;
                if (snapshot.empty) { container.innerHTML = '<p class="text-center text-gray-500 text-xs">ë“±ë¡ëœ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
                let html = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center group hover:border-gray-600 transition-colors">
                            <div class="flex-1 min-w-0 mr-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-purple-900/50 text-purple-300 text-[10px] px-1.5 py-0.5 rounded font-mono border border-purple-800">${doc.id}</span>
                                    <span class="text-xs text-gray-400 font-bold">${d.taxonomy?.domain || 'ë¯¸ë¶„ë¥˜'}</span>
                                </div>
                                <div class="text-xs text-gray-400 flex gap-3 items-center">
                                    <span>ì •ë‹µ: <strong class="text-white">${d.correctAnswer || '?'}</strong></span>
                                    <span>ë°°ì : <strong class="text-white">${d.difficulty || '-'}</strong>ì </span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openQuestionModal('${doc.id}')" class="p-2 bg-gray-700 hover:bg-purple-600 rounded-lg text-gray-300 hover:text-white transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                <button onclick="deleteQuestionData('${doc.id}')" class="p-2 bg-red-900/50 hover:bg-red-900 border border-red-800 rounded-lg text-red-300 hover:text-white transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>`;
                });
                container.innerHTML = html; lucide.createIcons();
            } catch (e) { container.innerHTML = `<p class="text-center text-red-400 text-xs">ë¡œë”© ì‹¤íŒ¨</p>`; }
        };

        function safeSetValue(id, val) { const el = document.getElementById(id); if(el) el.value = val; }

        window.openExamEditModal = async (docId = null) => {
            const idContainer = document.getElementById('edit-id-container');
            safeSetValue('edit-doc-id', docId || '');
            safeSetValue('edit-id-input', '');
            safeSetValue('edit-title', '');
            safeSetValue('edit-subtitle', '');
            safeSetValue('edit-price', 5000);
            safeSetValue('edit-date', '');
            tempExamQuestions = Array(25).fill(null);
            if (docId) {
                idContainer.classList.add('hidden');
                try {
                    const docSnap = await getDoc(doc(db, "public_exams", docId));
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        safeSetValue('edit-title', d.title || ''); safeSetValue('edit-subtitle', d.subTitle || ''); safeSetValue('edit-price', d.price || 5000);
                        if(d.date) safeSetValue('edit-date', d.date.split('T')[0]);
                        const detailSnap = await getDoc(doc(db, "exams", docId));
                        if(detailSnap.exists()) tempExamQuestions = detailSnap.data().questions || Array(25).fill(null);
                    }
                } catch(e) { alert("ë¡œë“œ ì‹¤íŒ¨"); return; }
            } else { idContainer.classList.remove('hidden'); }
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.openExamQuestionsModal = () => {
            const container = document.getElementById('mapping-form');
            container.innerHTML = '';
            for(let i=0; i<25; i++) {
                const data = tempExamQuestions[i] || { qId: '', score: 2.0, correctAnswer: '' };
                container.innerHTML += `<div class="bg-gray-700/50 p-3 rounded-xl border border-gray-600">
                        <div class="flex justify-between items-center mb-2"><span class="text-sm font-bold text-emerald-300">Q${i+1}</span></div>
                        <div class="space-y-2">
                            <div><input type="text" class="map-qid w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:border-emerald-500 outline-none" placeholder="ë¬¸í•­ ID" value="${data.qId || ''}" onchange="fetchQuestionInfo(this, ${i})"></div>
                            <div class="flex gap-2">
                                <input type="number" step="0.1" class="map-score w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-center text-white" placeholder="ë°°ì " value="${data.score || ''}">
                                <input type="number" class="map-ans w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-center text-white" placeholder="ì •ë‹µ" value="${data.correctAnswer || ''}">
                            </div>
                        </div>
                    </div>`;
            }
            document.getElementById('exam-questions-modal').classList.remove('hidden');
        };

        window.closeExamQuestionsModal = () => {
            const qIds = document.querySelectorAll('.map-qid'), scores = document.querySelectorAll('.map-score'), answers = document.querySelectorAll('.map-ans');
            for(let i=0; i<25; i++) tempExamQuestions[i] = { no: i+1, qId: qIds[i].value.trim(), score: Number(scores[i].value) || 0, correctAnswer: Number(answers[i].value) || 0 };
            document.getElementById('exam-questions-modal').classList.add('hidden');
        };

        window.fetchQuestionInfo = async (inputEl, index) => {
            const qId = inputEl.value.trim(); if(!qId) return;
            try {
                const docSnap = await getDoc(doc(db, "questions", qId));
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    document.querySelectorAll('.map-score')[index].value = data.difficulty;
                    document.querySelectorAll('.map-ans')[index].value = data.correctAnswer;
                } else { inputEl.style.borderColor = 'red'; }
            } catch(e) { console.error(e); }
        };

        window.saveExamData = async () => {
            let docId = document.getElementById('edit-doc-id').value || document.getElementById('edit-id-input').value.trim();
            if(!docId) return alert("ì‹œí—˜ ID í•„ìˆ˜");
            if (!confirm("ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try { 
                const title = document.getElementById('edit-title').value, subTitle = document.getElementById('edit-subtitle').value, price = Number(document.getElementById('edit-price').value), dateVal = document.getElementById('edit-date').value;
                const numId = Number(docId.replace(/[^0-9]/g, '')) || 0;
                await setDoc(doc(db, "public_exams", docId), { id: numId, title, subTitle, price, date: dateVal ? new Date(dateVal).toISOString() : null }, { merge: true });
                await setDoc(doc(db, "exams", docId), { title, questions: tempExamQuestions, score_map: tempExamQuestions.map(q=>q?q.score:0), answer_key: tempExamQuestions.map(q=>q?q.correctAnswer:0), updatedAt: new Date().toISOString() }, { merge: true });
                alert("ì €ì¥ ì™„ë£Œ"); closeEditModal(); window.loadExamList(); 
            } catch (e) { alert("ì‹¤íŒ¨: " + e.message); }
        };

        window.batchUpdateYear = async () => {
            if (!confirm("ì¼ê´„ ë³€ê²½?")) return;
            try { 
                const snapshot = await getDocs(collection(db, "public_exams")); 
                const updates = []; 
                snapshot.forEach(sd => { 
                    const d = sd.data(); 
                    if (d.title.includes("2024") || (d.subTitle && d.subTitle.includes("2024"))) {
                        updates.push(updateDoc(sd.ref, { title: d.title.replace(/2024/g, "2026"), subTitle: (d.subTitle || "").replace(/2024/g, "2026") }));
                    }
                }); 
                await Promise.all(updates); alert(`${updates.length}ê°œ ìˆ˜ì • ì™„ë£Œ`); window.loadExamList(); 
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        };

        window.searchUser = async () => {
            const val = document.getElementById('search-user-input').value.trim();
            if (!val) return alert("ê²€ìƒ‰ì–´ ì…ë ¥");
            try {
                const q = val.includes('@') ? query(collection(db,"users"), where("email","==",val)) : query(collection(db,"users"), where("name","==",val));
                const snap = await getDocs(q);
                if (snap.empty) return alert("ì‚¬ìš©ì ì—†ìŒ");
                const userDoc = snap.docs[0], d = userDoc.data(); searchedUserUid = userDoc.id;
                document.getElementById('manage-user-name').innerText = d.name || "ì´ë¦„ ì—†ìŒ";
                document.getElementById('manage-user-email').innerText = d.email || "-";
                document.getElementById('manage-user-joined').innerText = d.joinedAt ? new Date(d.joinedAt).toLocaleDateString() : "-";
                document.getElementById('user-manage-panel').classList.remove('hidden');
                document.getElementById('manage-user-status').innerText = d.isPaid ? "Premium" : "Free";
                document.getElementById('manage-user-status').className = d.isPaid ? "inline-block px-2 py-1 rounded text-xs font-bold bg-indigo-600 text-white" : "inline-block px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300";
                window.loadUserExamList(searchedUserUid);
            } catch (e) { alert("ê²€ìƒ‰ ì˜¤ë¥˜"); }
        };

        window.loadUserExamList = async (uid) => {
            const container = document.getElementById('user-exam-list'); container.innerHTML = 'ë¡œë”©...';
            try { 
                const examsSnap = await getDocs(query(collection(db, "public_exams"), orderBy("id", "asc"))); 
                const mySnap = await getDocs(collection(db, "users", uid, "my_exams")); 
                const myMap = {}; mySnap.forEach(d => myMap[d.id] = d.data()); 
                let html = ''; 
                examsSnap.forEach(ed => { 
                    const e = ed.data(), eid = `exam_${String(e.id).padStart(2,'0')}`, userR = myMap[eid]; 
                    const statusB = userR ? `<span class="text-xs px-2 py-1 rounded ${userR.status==='graded'?'bg-emerald-900':'bg-blue-900'}">${userR.status}</span>` : '<span class="text-xs text-gray-500">ë¯¸êµ¬ë§¤</span>';
                    const actionB = userR ? `<button onclick="toggleUserExam('${uid}','${eid}','${e.title}',false)" class="text-xs bg-red-900/50 p-1.5 rounded">íšŒìˆ˜</button>` : `<button onclick="toggleUserExam('${uid}','${eid}','${e.title}',true)" class="text-xs bg-indigo-600 p-1.5 rounded">ì§€ê¸‰</button>`;
                    html += `<div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between"><div><span class="text-xs text-gray-400">#${e.id}</span> ${statusB}<p class="text-sm font-bold">${e.title}</p></div>${actionB}</div>`;
                }); 
                container.innerHTML = html; 
            } catch (e) { container.innerHTML = 'ì‹¤íŒ¨'; }
        };

        window.toggleUserExam = async (uid, eid, title, grant) => {
            try { grant ? await setDoc(doc(db,"users",uid,"my_exams",eid), {status:'purchased', title, grantedAt:new Date().toISOString(), adminGranted:true}) : await deleteDoc(doc(db,"users",uid,"my_exams",eid)); window.loadUserExamList(uid); } catch(e) { alert("ì‹¤íŒ¨"); }
        };

        window.resetUserExamData = async () => {
            const tid = document.getElementById('reset-exam-id').value.trim();
            if (!searchedUserUid || !tid) return alert("ì…ë ¥ í•„ìš”");
            if (!confirm("ì‚­ì œ?")) return;
            try { const b = writeBatch(db); b.delete(doc(db,"users",searchedUserUid,"my_exams",tid)); b.delete(doc(db,"users",searchedUserUid,"exam_results",tid)); await b.commit(); alert("ì™„ë£Œ"); window.loadUserExamList(searchedUserUid); } catch(e) { alert("ì˜¤ë¥˜"); }
        };

        window.updateUserPaidStatus = async (isPaid) => {
            if (!searchedUserUid) return;
            try { 
                const b = writeBatch(db); b.update(doc(db,"users",searchedUserUid), {isPaid});
                if(isPaid) { const es = await getDocs(collection(db,"public_exams")); es.forEach(ed => { const eid = `exam_${String(ed.data().id).padStart(2,'0')}`; b.set(doc(db,"users",searchedUserUid,"my_exams",eid), {status:'purchased', title:ed.data().title, grantedAt:new Date().toISOString()}, {merge:true}); }); }
                await b.commit(); window.searchUser();
            } catch(e) { alert("ì‹¤íŒ¨"); }
        };

        window.updateTopicOptions = (chapter, topic = null) => {
            const select = document.getElementById('q-topic'); select.innerHTML = '<option value="">ì†Œë‹¨ì› ì„ íƒ</option>';
            if (chapter && TOPIC_MAP[chapter]) TOPIC_MAP[chapter].forEach(t => { const o = document.createElement('option'); o.value = t; o.text = t; if(topic===t) o.selected=true; select.appendChild(o); });
        };
        document.getElementById('q-chapter').addEventListener('change', (e) => window.updateTopicOptions(e.target.value));

        window.openQuestionModal = async (docId = null) => {
            safeSetValue('q-doc-id', docId || ''); safeSetValue('q-id', docId || `q_${new Date().getFullYear()}_${Math.random().toString(36).substr(2,5)}`);
            safeSetValue('q-domain',''); safeSetValue('q-chapter',''); window.updateTopicOptions(''); safeSetValue('q-difficulty','2.0'); safeSetValue('q-answer',''); safeSetValue('question-behavioral-domain','');
            if (docId) {
                try {
                    const snap = await getDoc(doc(db,"questions",docId));
                    if(snap.exists()) { const d = snap.data(), tax = d.taxonomy||{}; safeSetValue('q-id', docId); safeSetValue('q-domain', tax.domain||''); safeSetValue('q-chapter', tax.chapter||''); window.updateTopicOptions(tax.chapter, tax.topic); safeSetValue('q-difficulty', d.difficulty||2.0); safeSetValue('q-answer', d.correctAnswer||''); safeSetValue('question-behavioral-domain', d.behavioralDomain||''); }
                } catch(e) { console.error(e); }
            }
            document.getElementById('question-edit-modal').classList.remove('hidden');
        };
        
        window.closeQuestionModal = () => document.getElementById('question-edit-modal').classList.add('hidden');
        
        /**
         * [ê¸°ëŠ¥ ë³´ê°•] saveQuestionData: questions ìˆ˜ì • ì‹œ exams ë° exam_archive ë™ê¸°í™”
         */
        window.saveQuestionData = async () => {
            const originalDocId = document.getElementById('q-doc-id').value;
            const newDocId = document.getElementById('q-id').value.trim();
            const domain = document.getElementById('q-domain').value;
            const chapter = document.getElementById('q-chapter').value;
            const topic = document.getElementById('q-topic').value;
            const behavior = document.getElementById('question-behavioral-domain').value;
            const difficulty = Number(document.getElementById('q-difficulty').value);
            const correctAnswer = Number(document.getElementById('q-answer').value);

            if (!newDocId || !domain || !chapter || !topic || !behavior) return alert("í•„ìˆ˜ í•­ëª© ì…ë ¥ ëˆ„ë½");
            if (!confirm("ì €ì¥ ë° ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì§„í–‰í• ê¹Œìš”?")) return;

            try {
                const data = { id: newDocId, correctAnswer, difficulty, behavioralDomain: behavior, taxonomy: { subject: "í†µí•©ê³¼í•™", domain, chapter, topic }, updatedAt: new Date().toISOString() };
                
                // 1. questions ì—…ë°ì´íŠ¸
                await setDoc(doc(db, "questions", newDocId), data, { merge: true });
                if (originalDocId && originalDocId !== newDocId) await deleteDoc(doc(db, "questions", originalDocId));

                const batch = writeBatch(db);
                let examUpdateCount = 0;
                let archiveUpdateCount = 0;

                // 2. exams ë™ê¸°í™”
                const examsSnap = await getDocs(collection(db, "exams"));
                examsSnap.forEach(examDoc => {
                    const ed = examDoc.data();
                    if (ed.questions && Array.isArray(ed.questions)) {
                        let mod = false;
                        const updatedQ = ed.questions.map(q => {
                            if (q && (q.qId === originalDocId || q.qId === newDocId)) { mod = true; return { ...q, qId: newDocId, score: difficulty, correctAnswer: correctAnswer }; }
                            return q;
                        });
                        if (mod) { 
                            batch.update(examDoc.ref, { questions: updatedQ, score_map: updatedQ.map(uq => uq ? uq.score : 0), answer_key: updatedQ.map(uq => uq ? uq.correctAnswer : 0), updatedAt: new Date().toISOString() }); 
                            examUpdateCount++; 
                        }
                    }
                });

                /**
                 * 3. [ì¶”ê°€] exam_archive ë™ê¸°í™”
                 * ë¶„ì„ ë§¤íŠ¸ë¦­ìŠ¤ëŠ” ì´ ì»¬ë ‰ì…˜ì˜ topicê³¼ domain(í–‰ë™ì˜ì—­)ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.
                 */
                const archiveRef = collection(db, 'artifacts', 'godtonggwa_v1', 'public', 'data', 'exam_archive');
                const archiveSnap = await getDocs(archiveRef);
                
                archiveSnap.forEach(archiveDoc => {
                    const ad = archiveDoc.data();
                    // archive ë¬¸ì„œ ë‚´ì— q_id í•„ë“œê°€ ìˆê±°ë‚˜, topicê³¼ q_num ì¡°í•©ìœ¼ë¡œ ì¶”ì  ê°€ëŠ¥í•´ì•¼ í•¨
                    // ì—¬ê¸°ì„œëŠ” q_idê°€ ë¬¸ì„œ ë‚´ì— í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, í˜¹ì€ ê´€ë ¨ ë¬¸ì„œë¥¼ JSì—ì„œ í•„í„°ë§
                    if (ad.q_id === originalDocId || ad.q_id === newDocId) {
                        batch.update(archiveDoc.ref, {
                            topic: topic,          // ìˆ˜ì •ëœ ì†Œë‹¨ì›
                            domain: behavior,      // ìˆ˜ì •ëœ í–‰ë™ ì˜ì—­ (ë§¤íŠ¸ë¦­ìŠ¤ ìƒ‰ìƒ ê²°ì •)
                            q_id: newDocId         // ìµœì‹  ID ìœ ì§€
                        });
                        archiveUpdateCount++;
                    }
                });

                await batch.commit();
                alert(`ì €ì¥ ì„±ê³µ!\n- ëª¨ì˜ê³ ì‚¬ ${examUpdateCount}ê±´ ë™ê¸°í™”\n- ë¶„ì„ ê¸°ë¡ ${archiveUpdateCount}ê±´ ë™ê¸°í™”`);
                window.closeQuestionModal(); window.loadQuestionsList();
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
        };
        
        window.deleteQuestionData = async (id) => { if(confirm("ì‚­ì œ?")) { try { await deleteDoc(doc(db, "questions", id)); window.loadQuestionsList(); } catch(e) { alert("ì‹¤íŒ¨"); } } };
        lucide.createIcons();
    </script>
</body>
</html>