<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2028 통합과학 Pro (통합 관리 도구)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .sidebar-item.active { background-color: #e0e7ff; color: #4338ca; border-right: 3px solid #4338ca; font-weight: bold; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .overlay-screen { position: fixed; inset: 0; background: #111827; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { width: 100%; max-width: 400px; padding: 2.5rem; border-radius: 1.5rem; background: #1f2937; border: 1px solid #374151; text-align: center; color: white; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .matrix-table-container { height: calc(100vh - 120px); overflow-x: auto; }
        th.sticky-col-1, td.sticky-col-1 { position: sticky; left: 0; z-index: 20; border-right: 1px solid #e2e8f0; background-color: white; }
        th.sticky-col-2, td.sticky-col-2 { position: sticky; left: 100px; z-index: 20; border-right: 2px solid #cbd5e1; background-color: white; }
        thead th.sticky-col-1, thead th.sticky-col-2 { z-index: 40; background-color: #f1f5f9; }
        .circle-badge {
            width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: white; margin: 1px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: default;
        }
        /* 행동 영역 색상 정의 (admin1.html과 일치) */
        .bg-apply { background-color: #94A3B8; } /* 이해와 적용 */
        .bg-comm { background-color: #475569; } /* 의사소통 */
        .bg-hypo { background-color: #FBBF24; } /* 가설 설정 */
        .bg-design { background-color: #F87171; } /* 탐구 설계 */
        .bg-exec { background-color: #34D399; } /* 탐구 수행 및 자료 수집 */
        .bg-anal { background-color: #60A5FA; } /* 자료 변환 및 해석 */
        .bg-conc { background-color: #A78BFA; } /* 결론 도출 */

        /* 중단원 구분 실선 스타일 */
        .unit-divider { border-top: 3px solid #1e293b !important; }

        #pdf-render-area canvas { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; border-radius: 8px; width: 100%; height: auto; }
        #pdf-panel { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        #pdf-panel.closed { width: 0 !important; opacity: 0; padding: 0; border: none; }
        .menu-tab.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">

    <div id="login-container" class="overlay-screen">
        <div class="login-card fade-in">
            <div class="bg-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">관리자 로그인</h1>
            <p class="text-gray-400 text-sm mb-8">갓통과 시스템 통합 관리 도구</p>
            <form id="admin-login-form" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">이메일</label>
                    <input type="email" id="admin-email" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 outline-none text-white text-sm focus:border-indigo-500 transition-all" placeholder="admin@example.com" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">비밀번호</label>
                    <input type="password" id="admin-pw" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 outline-none text-white text-sm focus:border-indigo-500 transition-all" placeholder="비밀번호" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 transition-all active:scale-95 flex justify-center items-center gap-2">
                    <span id="btn-text">로그인</span>
                    <div id="btn-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </form>
        </div>
    </div>

    <div id="loading-overlay" class="overlay-screen hidden">
        <div class="flex flex-col items-center gap-3 text-white text-center">
            <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="font-bold">시스템 데이터를 동기화 중입니다...</p>
        </div>
    </div>

    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-30 shadow-lg shrink-0">
        <div class="p-6 bg-indigo-700 text-white shadow-md">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="layout-dashboard"></i> 통합 관리 Pro
            </h1>
            <p class="text-[10px] text-indigo-200 mt-1 uppercase font-bold tracking-widest">2028 Unified Science</p>
        </div>

        <div class="p-3 flex gap-1 bg-indigo-50 border-b border-indigo-100">
            <button onclick="switchMenu('qlist')" id="tab-qlist" class="menu-tab active flex-1 py-2 text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-1.5 border border-indigo-200 shadow-sm">
                <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> 출제 도우미
            </button>
            <button onclick="switchMenu('matrix')" id="tab-matrix" class="menu-tab flex-1 py-2 text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-1.5 border border-indigo-200 shadow-sm">
                <i data-lucide="bar-chart-3" class="w-3.5 h-3.5"></i> 분석 매트릭스
            </button>
        </div>
        
        <div id="sidebar-qlist-content" class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-100">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-indigo-800 flex items-center gap-1">
                        <i data-lucide="file-up" class="w-3 h-3"></i> 교재 PDF 로드
                    </label>
                    <button onclick="clearStoredPDF()" id="clear-pdf-btn" class="hidden text-[10px] text-red-500 hover:underline">저장 삭제</button>
                </div>
                <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-[10px] text-slate-500 file:mr-2 file:py-1.5 file:px-2 file:rounded-md file:border-0 file:text-[10px] file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer shadow-sm"/>
                <p id="pdf-status-msg" class="text-[9px] text-indigo-500 mt-1 hidden font-bold">✅ 브라우저 내에 저장됨</p>
            </div>
            <nav class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide" id="sidebar-menu"></nav>
        </div>

        <div id="sidebar-matrix-content" class="hidden flex-1 flex flex-col p-4 space-y-4 overflow-y-auto">
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <h3 class="text-xs font-bold text-slate-500 mb-3 flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> 매트릭스 안내</h3>
                <p class="text-[11px] text-slate-400 leading-relaxed">이 매트릭스는 <b>문항 은행(Questions)</b>의 전체 데이터와 <b>시험별(Archive)</b> 분포를 실시간으로 비교합니다.</p>
                <button onclick="renderMatrix()" class="w-full mt-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold border border-indigo-100 transition-colors flex items-center justify-center gap-2 shadow-sm">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> 데이터 새로고침
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex flex-col gap-2">
            <div class="text-[10px] text-gray-400 mb-1 truncate px-1 flex items-center gap-1">
                <i data-lucide="user" class="w-3 h-3"></i> <span id="display-email">연결됨</span>
            </div>
            <button onclick="handleLogout()" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-600 rounded-lg text-xs hover:bg-gray-100 transition-colors flex items-center justify-center gap-2 shadow-sm">
                로그아웃
            </button>
        </div>
    </aside>

    <main class="flex-1 flex overflow-hidden relative">
        <section id="menu-qlist-container" class="flex-1 flex overflow-hidden">
            <section class="flex-1 flex flex-col border-r border-gray-200 bg-white min-w-[400px]">
                <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20 h-16">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800" id="header-title">단원 선택 대기</h2>
                        <p class="text-xs text-gray-500 mt-0.5" id="header-desc">교육과정 질문 리스트</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="togglePDF()" class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-200 transition-all shadow-sm active:scale-95 flex items-center gap-1.5 text-xs font-bold border border-slate-200">
                            <span id="pdf-toggle-icon"><i data-lucide="book-open" class="w-3 h-3"></i></span> 
                            <span id="toggle-text">교재 닫기</span>
                        </button>
                    </div>
                </header>
                <div class="flex-1 overflow-y-auto p-6 bg-slate-50 scrollbar-hide" id="question-container">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                        <i data-lucide="layout-list" class="w-12 h-12 mb-3"></i>
                        <p class="text-sm text-center">왼쪽 메뉴에서 단원을 선택하세요.</p>
                    </div>
                </div>
            </section>
            <section id="pdf-panel" class="w-[50%] flex flex-col bg-gray-100 min-w-[400px] border-l border-gray-200 relative shadow-inner">
                <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20 h-16 shrink-0">
                    <div class="flex items-center gap-2">
                        <span class="bg-red-100 text-red-600 p-1.5 rounded-md"><i data-lucide="file-text" class="w-4 h-4"></i></span>
                        <h2 class="text-sm font-bold text-gray-800">교재 뷰어</h2>
                    </div>
                    <div id="page-controls" class="hidden flex items-center gap-2">
                         <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200" id="page-indicator">Page -</span>
                    </div>
                </header>
                <div class="flex-1 overflow-y-auto p-6 text-center relative bg-gray-200/50 scrollbar-hide" id="pdf-container">
                    <div id="pdf-render-area" class="w-full max-w-3xl mx-auto"></div>
                </div>
            </section>
        </section>

        <section id="menu-matrix-container" class="hidden flex-1 flex flex-col bg-white overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm h-16 shrink-0 text-gray-800">
                <div class="flex items-center gap-2">
                    <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-md"><i data-lucide="grid-3x3" class="w-4 h-4"></i></span>
                    <h2 class="text-lg font-bold">모의고사 분석 매트릭스</h2>
                </div>
                <div class="flex items-center gap-4 text-[10px] font-medium text-gray-500">
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-apply"></div>이해/적용</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-comm"></div>의사소통</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-hypo"></div>가설설정</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-design"></div>탐구설계</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-exec"></div>수행/수집</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-anal"></div>변환/해석</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-conc"></div>결론도출</div>
                </div>
            </header>
            <div class="flex-1 matrix-table-container scrollbar-hide">
                <table class="w-full text-xs text-left border-collapse min-w-max">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50" id="matrix-thead">
                        <!-- JS에서 동적으로 생성됨 -->
                    </thead>
                    <tbody id="matrix-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div id="matrix-toast" class="hidden fixed bottom-6 right-6 bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-xl">업데이트 완료</div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs", authDomain: "godtonggwa.firebaseapp.com", projectId: "godtonggwa", storageBucket: "godtonggwa.firebasestorage.app", messagingSenderId: "1087434066468", appId: "1:1087434066468:web:00a75c9329543afc76e6b1" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db_fs = getFirestore(app);
        const APP_ID = "godtonggwa_v1";

        const CURRICULUM_STRUCTURE = {
            "과학의 기초": ["기본량과 단위", "측정과 어림", "정보와 신호"],
            "물질과 규칙성": ["원소 형성", "별의 진화", "원소의 주기성", "화학 결합", "지각과 생명체 구성 물질의 규칙성"],
            "시스템과 상호작용": ["지구시스템의 구성과 상호작용", "판구조론과 지각 변동", "중력장 내의 운동", "충격량과 운동량", "생명 시스템의 기본 단위", "물질대사", "유전자와 단백질", "물질의 전기적 성질"],
            "변화와 다양성": ["지질시대의 생물과 화석", "지질시대 환경 변화와 대멸종", "자연선택", "생물다양성", "산화와 환원", "중화 반응", "물질 변화에서 에너지 출입"],
            "환경과 에너지": ["생태계 구성 요소", "생태계 평형", "대기와 해양의 상호작용", "온실기체와 지구온난화", "핵융합", "발전", "에너지 전환과 효율"],
            "과학과 미래 사회": ["감염병과 병원체", "인공지능과 과학 탐구", "로봇", "과학기술과 윤리"]
        };
        const UNIT_KEYS = Object.keys(CURRICULUM_STRUCTURE);
        
        const domainColors = { 
            "이해와 적용": "bg-apply",
            "의사소통": "bg-comm", 
            "가설 설정": "bg-hypo", 
            "탐구 설계": "bg-design", 
            "탐구 수행 및 자료 수집": "bg-exec", 
            "자료 변환 및 해석": "bg-anal", 
            "결론 도출": "bg-conc" 
        };

        let scienceDB = null; let pdfDoc = null; let currentCategory = null; let currentTopic = null; let isPdfVisible = true;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const adminDoc = await getDoc(doc(db_fs, "settings", "admin"));
                if (adminDoc.exists() && adminDoc.data().adminEmail === user.email) {
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('loading-overlay').classList.remove('hidden');
                    startQListSync(); loadLocalPDF();
                } else { alert("권한 없음"); signOut(auth); }
            } else { document.getElementById('login-container').classList.remove('hidden'); }
            lucide.createIcons();
        });

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('admin-email').value, document.getElementById('admin-pw').value); }
            catch (error) { alert("로그인 실패"); }
        });

        const startQListSync = () => {
            const docRef = doc(db_fs, 'artifacts', APP_ID, 'public', 'data', 'questions', 'mainDB');
            onSnapshot(docRef, (snap) => {
                scienceDB = snap.exists() ? snap.data().content : {};
                initSidebar();
                document.getElementById('loading-overlay').classList.add('hidden');
                if (currentCategory && currentTopic) renderQuestions();
            });
        };

        function initSidebar() {
            const nav = document.getElementById('sidebar-menu'); nav.innerHTML = '';
            UNIT_KEYS.forEach(category => {
                const details = document.createElement('details'); details.open = true;
                const summary = document.createElement('summary');
                summary.className = "px-4 py-2 text-xs font-bold text-gray-500 cursor-pointer list-none flex justify-between bg-gray-50 rounded mb-1";
                summary.innerHTML = `${category} <i data-lucide="chevron-down" class="w-4 h-4"></i>`;
                const ul = document.createElement('ul'); ul.className = "pl-2 border-l-2 border-indigo-100 ml-2 mb-2";
                (CURRICULUM_STRUCTURE[category] || []).forEach(topic => {
                    const li = document.createElement('li');
                    li.className = `sidebar-item px-3 py-2 rounded text-sm text-gray-600 hover:bg-indigo-50 cursor-pointer transition-colors ${currentTopic === topic ? 'active' : ''}`;
                    li.innerText = topic;
                    li.onclick = () => {
                        currentCategory = category; currentTopic = topic;
                        document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
                        li.classList.add('active');
                        document.getElementById('header-title').innerText = topic;
                        renderQuestions(); if (pdfDoc && isPdfVisible) renderPDF();
                    };
                    ul.appendChild(li);
                });
                details.appendChild(summary); details.appendChild(ul); nav.appendChild(details);
            });
            lucide.createIcons();
        }

        function renderQuestions() {
            const container = document.getElementById('question-container'); container.innerHTML = '';
            if(!scienceDB[currentCategory] || !scienceDB[currentCategory][currentTopic]) {
                container.innerHTML = '<p class="text-center text-gray-400 py-10">질문 데이터가 없습니다.</p>'; return;
            }
            scienceDB[currentCategory][currentTopic].q.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-lg shadow-sm mb-3 border border-gray-200 group hover:border-indigo-200 transition-all";
                card.innerHTML = `<div class="flex gap-3"><span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold flex items-center justify-center shrink-0 mt-0.5">${idx+1}</span><p class="text-gray-800 leading-relaxed">${q}</p></div>`;
                container.appendChild(card);
            });
        }

        window.renderMatrix = async () => {
            const thead = document.getElementById('matrix-thead');
            const tbody = document.getElementById('matrix-body');
            const toast = document.getElementById('matrix-toast');
            
            try {
                // 1. 문항 은행 전체 데이터 로드
                const bankSnap = await getDocs(collection(db_fs, "questions"));
                let bankCounts = {}; 
                bankSnap.forEach(d => {
                    const data = d.data(); const topic = data.taxonomy?.topic;
                    if(topic) bankCounts[topic] = (bankCounts[topic] || 0) + 1;
                });

                // 2. 시험 아카이브 데이터 로드
                const archiveSnap = await getDocs(collection(db_fs, 'artifacts', APP_ID, 'public', 'data', 'exam_archive'));
                let archiveData = {}; let roundsSet = new Set();
                archiveSnap.forEach(doc => {
                    const item = doc.data(); 
                    const round = item.exam_id || "미분류"; 
                    roundsSet.add(round);
                    if (!archiveData[round]) archiveData[round] = {};
                    if (!archiveData[round][item.topic]) archiveData[round][item.topic] = [];
                    archiveData[round][item.topic].push({ qNum: item.q_num, domain: item.domain });
                });

                // 3. 모의고사(exams) 정답지 데이터 로드
                const examsSnap = await getDocs(collection(db_fs, "exams"));
                let examsMeta = {};
                examsSnap.forEach(doc => {
                    const d = doc.data();
                    const key = d.answer_key || [];
                    let dist = [0,0,0,0,0];
                    key.forEach(ans => { if(ans >= 1 && ans <= 5) dist[ans-1]++; });
                    examsMeta[doc.id] = { ansDist: dist.join('/') };
                });

                const sortedRounds = Array.from(roundsSet).sort();

                // 4. 헤더 생성 (3줄 구성: 이름, 정답분포, 단원분포)
                let headerHtml = `
                    <tr>
                        <th rowspan="3" class="px-2 py-3 sticky-col-1 w-[100px] text-center bg-slate-100 border-b">중단원</th>
                        <th rowspan="3" class="px-4 py-3 sticky-col-2 w-[220px] bg-slate-100 shadow-md text-left border-b">소단원 (내용 요소)</th>
                `;
                sortedRounds.forEach(r => headerHtml += `<th class="px-2 py-2 text-center min-w-[95px] bg-white border-b font-black text-indigo-900 border-r border-gray-100 text-[11px]">${r}</th>`);
                headerHtml += `<th rowspan="3" class="px-2 py-3 text-center min-w-[80px] bg-indigo-50 border-b text-indigo-700 font-black">Bank</th></tr>`;
                
                // 정답 분포 줄 (글씨 크기 인상: text-[11px])
                headerHtml += `<tr>`;
                sortedRounds.forEach(r => {
                    const dist = examsMeta[r] ? examsMeta[r].ansDist : "-/-/-/-/-";
                    headerHtml += `<th class="px-2 py-1.5 text-center bg-slate-50 border-b text-[11px] font-medium text-gray-600 border-r border-gray-100">${dist}</th>`;
                });
                headerHtml += `</tr>`;

                // 단원별 문항수 줄 (글씨 크기 인상 및 강조: text-[11px], font-bold, text-indigo-800)
                headerHtml += `<tr>`;
                sortedRounds.forEach(r => {
                    let unitStats = [];
                    UNIT_KEYS.forEach(unit => {
                        let count = 0;
                        CURRICULUM_STRUCTURE[unit].forEach(t => { if(archiveData[r] && archiveData[r][t]) count += archiveData[r][t].length; });
                        unitStats.push(count);
                    });
                    headerHtml += `<th class="px-2 py-1.5 text-center bg-indigo-50/50 border-b text-[11px] font-bold text-indigo-800 border-r border-gray-100">${unitStats.join('/')}</th>`;
                });
                headerHtml += `</tr>`;
                
                thead.innerHTML = headerHtml;

                // 5. 본문 생성 (중단원 사이 구분선 추가)
                tbody.innerHTML = '';
                UNIT_KEYS.forEach((unit) => {
                    const topics = CURRICULUM_STRUCTURE[unit];
                    topics.forEach((topic, tIdx) => {
                        const tr = document.createElement('tr'); 
                        tr.className = "hover:bg-gray-50 transition-colors group";
                        
                        // 중단원 시작 시 굵은 실선 추가
                        if (tIdx === 0) tr.classList.add('unit-divider');

                        if (tIdx === 0) {
                            const tdUnit = document.createElement('td'); 
                            tdUnit.className = "px-2 py-3 font-bold text-[10px] text-gray-600 bg-white sticky-col-1 align-top pt-4 border-b border-r border-gray-200";
                            tdUnit.rowSpan = topics.length; tdUnit.innerText = unit; tr.appendChild(tdUnit);
                        }
                        
                        const tdTopic = document.createElement('td'); 
                        tdTopic.className = "px-4 py-2 text-xs font-medium text-gray-700 bg-white sticky-col-2 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] border-b border-r border-gray-300 truncate";
                        tdTopic.innerText = topic; tr.appendChild(tdTopic);
                        
                        sortedRounds.forEach((round) => {
                            const qs = (archiveData[round] && archiveData[round][topic]) ? archiveData[round][topic] : [];
                            const td = document.createElement('td'); 
                            td.className = "px-1 py-1 text-center border-r border-gray-100 border-b align-middle";
                            if (qs.length > 0) {
                                let html = '<div class="flex justify-center gap-1 flex-wrap">';
                                qs.forEach(q => html += `<div class="circle-badge ${domainColors[q.domain] || "bg-gray-400"}" title="${q.domain}">${q.qNum}</div>`);
                                td.innerHTML = html + '</div>';
                            } else td.innerHTML = `<span class="text-gray-200">-</span>`;
                            tr.appendChild(td);
                        });
                        
                        const tdTotal = document.createElement('td'); 
                        tdTotal.className = "px-2 py-2 text-center text-xs font-bold bg-indigo-50/20 border-b border-indigo-100";
                        const countInBank = bankCounts[topic] || 0;
                        tdTotal.innerHTML = `<span class="${countInBank > 0 ? 'text-indigo-600' : 'text-gray-300'}">${countInBank}</span>`;
                        tr.appendChild(tdTotal);
                        tbody.appendChild(tr);
                    });
                });
                toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 2000);
                lucide.createIcons();
            } catch (e) { console.error(e); }
        };

        const openIDB = () => new Promise(res => { const req = indexedDB.open("ScientificPDFStore", 1); req.onsuccess = (e) => res(e.target.result); });
        const loadLocalPDF = async () => {
            try {
                const idb = await openIDB(); const req = idb.transaction("files", "readonly").objectStore("files").get("last_pdf");
                req.onsuccess = async () => { if (req.result) { const reader = new FileReader(); reader.onload = async function() { pdfDoc = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise; document.getElementById('pdf-status-msg').classList.remove('hidden'); document.getElementById('clear-pdf-btn').classList.remove('hidden'); }; reader.readAsArrayBuffer(req.result); } };
            } catch (e) {}
        };
        window.clearStoredPDF = async () => { if(confirm("삭제?")) { const idb = await openIDB(); idb.transaction("files", "readwrite").objectStore("files").delete("last_pdf"); location.reload(); } };
        window.togglePDF = () => { const panel = document.getElementById('pdf-panel'); isPdfVisible = !isPdfVisible; panel.classList.toggle('closed', !isPdfVisible); if(isPdfVisible && pdfDoc && currentTopic) renderPDF(); };
        async function renderPDF() {
            const area = document.getElementById('pdf-render-area'); area.innerHTML = '';
            if(!pdfDoc || !scienceDB[currentCategory] || !scienceDB[currentCategory][currentTopic] || !scienceDB[currentCategory][currentTopic].pdf) return;
            const info = scienceDB[currentCategory][currentTopic].pdf;
            document.getElementById('page-indicator').innerText = `p.${info.s} ~ p.${info.e}`;
            for (let i = info.s; i <= info.e; i++) {
                if (i > pdfDoc.numPages) break;
                const canvas = document.createElement('canvas'); area.appendChild(canvas);
                const page = await pdfDoc.getPage(i); const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height; canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
            }
        }
        window.switchMenu = (menu) => {
            document.querySelectorAll('.menu-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${menu}`).classList.add('active');
            ['qlist', 'matrix'].forEach(m => { document.getElementById(`menu-${m}-container`).classList.add('hidden'); document.getElementById(`sidebar-${m}-content`).classList.add('hidden'); });
            document.getElementById(`menu-${menu}-container`).classList.remove('hidden'); document.getElementById(`sidebar-${menu}-content`).classList.remove('hidden');
            if (menu === 'matrix') renderMatrix();
            lucide.createIcons();
        };
        window.handleLogout = () => { if(confirm("로그아웃?")) signOut(auth); };
        lucide.createIcons();
    </script>
</body>
</html>