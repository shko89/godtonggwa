<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합과학 모의고사 분석 매트릭스</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        
        /* 테이블 스크롤 및 고정 스타일 */
        .table-container {
            overflow-x: auto;
            position: relative;
            height: calc(100vh - 120px); /* 헤더 및 범례 제외 높이 */
        }
        
        /* 첫 번째(대단원), 두 번째(내용요소) 열 고정 */
        th.sticky-col-1, td.sticky-col-1 {
            position: sticky; left: 0; z-index: 20;
            border-right: 1px solid #e2e8f0;
            background-color: white;
        }
        th.sticky-col-2, td.sticky-col-2 {
            position: sticky; left: 80px; z-index: 20;
            border-right: 2px solid #cbd5e1;
            background-color: white;
        }
        
        /* 헤더는 더 위에 (z-index 30) */
        thead th { position: sticky; top: 0; z-index: 30; }
        thead th.sticky-col-1, thead th.sticky-col-2 { z-index: 40; background-color: #f1f5f9; }

        /* 하단 요약 행 고정 */
        tfoot th, tfoot td {
            position: sticky; bottom: 0; z-index: 25;
            background-color: #f8fafc;
            border-top: 2px solid #94a3b8;
            font-weight: bold;
        }
        tfoot .sticky-col-1, tfoot .sticky-col-2 { z-index: 35; background-color: #f1f5f9; }

        /* 스크롤바 커스텀 */
        .custom-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* 원형 배지 */
        .circle-badge {
            width: 20px; height: 20px;
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: white;
            margin: 1px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
        }
        .circle-badge:hover { transform: scale(1.3); z-index: 50; }

        /* 행동 영역별 색상 */
        .bg-comm { background-color: #94A3B8; } /* 의사소통 */
        .bg-hypo { background-color: #FBBF24; } /* 가설설정 */
        .bg-design { background-color: #F87171; } /* 탐구설계 */
        .bg-exec { background-color: #34D399; } /* 수행/자료수집 */
        .bg-anal { background-color: #60A5FA; } /* 변환/해석 */
        .bg-conc { background-color: #A78BFA; } /* 결론도출 */
        
        /* 로딩 인디케이터 */
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; font-weight: bold; color: #4F46E5;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- 상단 헤더 -->
    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-900">모의고사 매트릭스 분석</h1>
                <p id="data-source-label" class="text-xs text-gray-500">초기화 중...</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button id="refresh-btn" class="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition text-sm font-bold">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> 데이터 갱신
            </button>
        </div>
    </header>

    <!-- 범례 바 -->
    <div class="bg-white border-b border-gray-200 px-6 py-2 flex items-center gap-4 overflow-x-auto whitespace-nowrap z-40 text-xs shadow-sm">
        <span class="font-bold text-gray-500">행동 영역:</span>
        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-comm"></div>의사소통</div>
        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-hypo"></div>가설설정</div>
        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-design"></div>탐구설계</div>
        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-exec"></div>수행/수집</div>
        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-anal"></div>변환/해석</div>
        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-conc"></div>결론도출</div>
    </div>

    <!-- 메인 테이블 -->
    <main class="flex-1 bg-white relative overflow-hidden">
        <div id="loading-overlay" class="hidden">
            <div class="flex flex-col items-center">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-2"></i>
                <span>데이터 처리 중...</span>
            </div>
        </div>
        <div class="table-container custom-scroll">
            <table class="w-full text-sm text-left border-collapse min-w-max">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr id="header-row">
                        <!-- 고정 헤더 -->
                        <th class="px-2 py-3 sticky-col-1 w-[80px] text-center font-bold text-gray-600 border-b">대단원</th>
                        <th class="px-4 py-3 sticky-col-2 w-[180px] font-bold text-gray-600 border-b shadow-md text-left">내용 요소 (35)</th>
                        <!-- 동적 회차 헤더 -->
                    </tr>
                </thead>
                <tbody id="matrix-body" class="divide-y divide-gray-100">
                    <!-- 데이터 로드 -->
                </tbody>
                <tfoot id="matrix-footer" class="text-xs text-gray-600">
                    <!-- 하단 요약 로드 -->
                </tfoot>
            </table>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. 설정 ---
        const COLLECTION_NAME = 'exam_archive';
        const DB_FIELDS = {
            ROUND: 'exam_round',
            Q_NUM: 'q_num',
            TOPIC: 'topic',
            DOMAIN: 'domain'
        };

        // --- 1. 데이터 정의 ---
        const curriculum = {
            "0. 기초": ["기본량과 단위", "측정과 어림", "정보와 신호", "인공지능", "로봇", "과학 윤리", "감염병"],
            "1. 물질": ["원소의 생성", "별의 진화", "원소의 주기성", "이온 결합", "공유 결합", "지각과 생명체", "전기적 성질"],
            "2. 시스템": ["지구 시스템", "판 구조론", "중력장 운동", "충돌과 안전", "세포와 물질", "물질대사", "유전자"],
            "3. 변화": ["지질 시대", "대멸종", "진화", "생물 다양성", "산화 환원", "산과 염기", "중화 반응", "에너지 출입"],
            "4. 환경": ["생태계 평형", "대기와 해양", "지구 온난화", "핵융합", "발전과 송전", "에너지 효율"]
        };
        const unitNames = Object.keys(curriculum);

        const domainColors = {
            "의사소통": "bg-comm",
            "가설설정": "bg-hypo",
            "탐구설계": "bg-design",
            "탐구수행 및 자료수집": "bg-exec",
            "자료변환 및 해석": "bg-anal",
            "결론도출": "bg-conc"
        };
        const domains = Object.keys(domainColors);

        // --- 2. Firebase 안전 초기화 ---
        let db, auth, currentUser;
        let isFirebaseAvailable = false;

        try {
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseAvailable = true;
            } else {
                console.warn("Firebase 설정이 없습니다. 로컬/가상 모드로 동작합니다.");
            }
        } catch (e) {
            console.error("Firebase 초기화 오류:", e);
            isFirebaseAvailable = false;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- 3. 데이터 로직 ---
        function getMockData() {
            const rounds = ["1회", "2회", "3회", "4회", "5회"];
            const allTopics = Object.values(curriculum).flat();
            let data = {}; 

            rounds.forEach(round => {
                data[round] = {};
                for(let i=1; i<=25; i++) {
                    const topic = allTopics[Math.floor(Math.random() * allTopics.length)];
                    const domain = domains[Math.floor(Math.random() * domains.length)];
                    if(!data[round][topic]) data[round][topic] = [];
                    data[round][topic].push({ qNum: i, domain: domain });
                }
            });
            return { rounds, data, isMock: true };
        }

        async function fetchExamData() {
            // Firebase가 없거나 유저 인증이 안된 경우 즉시 가상 데이터 반환
            if (!isFirebaseAvailable || !currentUser) {
                return getMockData();
            }

            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    return getMockData();
                }

                let dbData = {};
                let roundSet = new Set();

                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    const round = item[DB_FIELDS.ROUND] || "미분류";
                    const topic = item[DB_FIELDS.TOPIC];
                    const domain = item[DB_FIELDS.DOMAIN];
                    const qNum = item[DB_FIELDS.Q_NUM];

                    if (topic) {
                        roundSet.add(round);
                        if (!dbData[round]) dbData[round] = {};
                        if (!dbData[round][topic]) dbData[round][topic] = [];
                        
                        dbData[round][topic].push({
                            qNum: qNum,
                            domain: domain || "미분류"
                        });
                    }
                });

                const sortedRounds = Array.from(roundSet).sort();
                if (sortedRounds.length === 0) return getMockData(); // 데이터는 있는데 유효한게 없을 경우

                return { rounds: sortedRounds, data: dbData, isMock: false };

            } catch (error) {
                console.error("데이터 가져오기 실패:", error);
                // alert() 제거하고 조용히 가상 데이터로 전환
                return getMockData();
            }
        }

        // --- 4. 렌더링 로직 ---
        async function renderMatrix() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const sourceLabel = document.getElementById('data-source-label');
            
            loadingOverlay.classList.remove('hidden');

            // fetchExamData는 이제 절대 실패하지 않고 항상 데이터를 반환함 (Mock 포함)
            const { rounds, data, isMock } = await fetchExamData();
            
            loadingOverlay.classList.add('hidden');
            
            if (isMock) {
                sourceLabel.innerHTML = isFirebaseAvailable ? "DB 데이터 없음 (가상 예시)" : "DB 미연결 (가상 예시)";
                sourceLabel.className = "text-xs text-gray-400";
            } else {
                sourceLabel.innerHTML = `<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>Firestore 연동됨`;
                sourceLabel.className = "text-xs text-green-700 font-bold flex items-center";
            }

            const theadRow = document.getElementById('header-row');
            const tbody = document.getElementById('matrix-body');
            const tfoot = document.getElementById('matrix-footer');

            // 1) 헤더
            theadRow.innerHTML = `
                <th class="px-2 py-3 sticky-col-1 w-[80px] text-center bg-slate-100 border-b border-r border-gray-200">대단원</th>
                <th class="px-4 py-3 sticky-col-2 w-[180px] bg-slate-100 shadow-md text-left border-b border-r border-gray-300">내용 요소</th>
            `;
            
            rounds.forEach(r => {
                theadRow.innerHTML += `<th class="px-2 py-3 text-center min-w-[70px] bg-white border-b font-bold text-indigo-900 border-r border-gray-100">${r}</th>`;
            });
            theadRow.innerHTML += `<th class="px-2 py-3 text-center min-w-[80px] bg-indigo-50 border-b text-indigo-700">누적</th>`;

            // 2) 바디
            tbody.innerHTML = '';
            const stats = Array.from({length: Math.max(rounds.length, 1)}, () => Array(unitNames.length).fill(0));

            unitNames.forEach((unit, uIdx) => {
                const topics = curriculum[unit];
                
                topics.forEach((topic, tIdx) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors group";

                    if (tIdx === 0) {
                        const tdUnit = document.createElement('td');
                        tdUnit.className = "px-2 py-3 font-bold text-xs text-gray-500 bg-white sticky-col-1 align-top pt-4 border-b border-r border-gray-200";
                        tdUnit.rowSpan = topics.length;
                        tdUnit.innerText = unit;
                        tr.appendChild(tdUnit);
                    }

                    const tdTopic = document.createElement('td');
                    tdTopic.className = "px-4 py-2 text-xs font-medium text-gray-700 bg-white sticky-col-2 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] border-b border-r border-gray-300 truncate";
                    tdTopic.innerText = topic;
                    tr.appendChild(tdTopic);

                    let totalTopicCount = 0;
                    
                    rounds.forEach((round, rIdx) => {
                        const questions = (data[round] && data[round][topic]) ? data[round][topic] : [];
                        totalTopicCount += questions.length;
                        if (stats[rIdx]) stats[rIdx][uIdx] += questions.length;

                        const td = document.createElement('td');
                        td.className = "px-1 py-1 text-center border-r border-gray-100 border-b align-middle";
                        
                        if (questions.length > 0) {
                            let circlesHtml = '<div class="flex justify-center gap-1 flex-wrap">';
                            questions.forEach(q => {
                                const colorClass = domainColors[q.domain] || "bg-gray-400";
                                circlesHtml += `<div class="circle-badge ${colorClass}" title="[${round}] ${q.qNum}번: ${q.domain}">${q.qNum}</div>`;
                            });
                            circlesHtml += '</div>';
                            td.innerHTML = circlesHtml;
                        } else {
                            td.innerHTML = `<span class="text-gray-200 text-[10px]">-</span>`;
                        }
                        tr.appendChild(td);
                    });

                    const tdTotal = document.createElement('td');
                    tdTotal.className = "px-2 py-2 text-center text-xs font-bold bg-indigo-50/20 border-b border-indigo-100";
                    tdTotal.innerText = totalTopicCount;
                    tr.appendChild(tdTotal);

                    tbody.appendChild(tr);
                });
            });

            // 3) 푸터
            tfoot.innerHTML = '';
            const trFoot = document.createElement('tr');
            trFoot.innerHTML = `
                <td colspan="2" class="sticky-col-1 px-4 py-3 text-right text-xs font-bold text-gray-600 bg-slate-100 border-t-2 border-gray-300 z-30" style="left:0; width:260px;">
                    단원별 문항수 (0/1/2/3/4)
                </td>
            `;

            rounds.forEach((_, rIdx) => {
                const counts = stats[rIdx];
                if (!counts) return; // 안전장치
                const total = counts.reduce((a,b)=>a+b, 0);
                const isValid = total === 25;
                const color = isValid ? "text-gray-700" : "text-red-600";

                const td = document.createElement('td');
                td.className = "px-1 py-2 text-center border-r border-gray-300 border-t-2 bg-slate-100";
                td.innerHTML = `
                    <div class="text-[9px] font-mono leading-tight text-gray-500 mb-1">
                        ${counts.join('<span class="text-gray-300">/</span>')}
                    </div>
                    <div class="text-[10px] font-bold ${color}">
                        계: ${total}
                    </div>
                `;
                trFoot.appendChild(td);
            });
            trFoot.innerHTML += `<td class="bg-indigo-100 border-t-2 border-indigo-200"></td>`;
            tfoot.appendChild(trFoot);
            
            if (window.lucide) window.lucide.createIcons();
        }

        // --- 5. 앱 실행 ---
        const init = async () => {
            if (isFirebaseAvailable && auth) {
                // Firebase 사용 가능 시 인증 시도
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    // Auth 리스너 등록
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        renderMatrix();
                    });
                } catch (e) {
                    console.error("Auth Fail:", e);
                    // 인증 실패해도 가상 모드로 렌더링
                    renderMatrix();
                }
            } else {
                // Firebase 불가 시 즉시 렌더링 (가상 모드)
                renderMatrix();
            }
        };

        // 버튼 이벤트
        const btn = document.getElementById('refresh-btn');
        if(btn) btn.addEventListener('click', renderMatrix);

        // 실행
        init();

    </script>
</body>
</html>