<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°“í†µê³¼ - 1íƒ€ ê°•ì‚¬ ë¹„ë°€ë…¸íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 1. ì†ê¸€ì”¨ í°íŠ¸ ë¡œë“œ */
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Gaegu:wght@400;700&display=swap');
        
        body { font-family: 'Gaegu', cursive; background-color: #f0f0f0; }

        /* 2. ì¤„ ê³µì±… ë°°ê²½ ìŠ¤íƒ€ì¼ (CSS íŒ¨í„´) */
        .notebook-paper {
            background-color: #fffef0; /* ë¯¸ìƒ‰ ì¢…ì´ */
            background-image: linear-gradient(to bottom, transparent 29px, #a8d5e5 30px); /* íŒŒë€ ì¤„ */
            background-size: 100% 30px; /* ì¤„ ê°„ê²© */
            line-height: 30px; /* ê¸€ì ì¤„ ê°„ê²© ë§ì¶¤ */
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .notebook-paper::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 40px;
            width: 2px;
            background-color: #ff9999; /* ë¹¨ê°„ ì„¸ë¡œì¤„ */
            opacity: 0.6;
        }

        .handwriting {
            font-family: 'Nanum Pen Script', cursive;
            font-size: 1.6rem;
            color: #374151;
            padding-left: 50px;
            padding-right: 20px;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        .btn-selected { 
            background-color: #4f46e5; 
            color: white; 
            transform: scale(1.1); 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.5);
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4 bg-stone-200">

    <div class="w-full max-w-4xl flex justify-between items-center mb-6">
        <button onclick="history.back()" class="bg-white p-2 rounded-full shadow hover:bg-gray-100 transition">
            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
        </button>
        <h1 class="text-2xl font-bold text-gray-700 flex items-center gap-2">
            <span class="text-3xl">ğŸ““</span> 
            <span id="exam-title-header">ì˜¤ë‹µë…¸íŠ¸ í¼ì¹˜ëŠ” ì¤‘...</span>
        </h1>
        <div class="w-10"></div>
    </div>

    <div class="w-full max-w-4xl flex flex-col md:flex-row gap-6 h-[80vh]">
        
        <div class="w-full md:w-1/3 bg-white rounded-2xl p-4 shadow-xl flex flex-col border-4 border-gray-300">
            <div class="mb-4 pb-2 border-b-2 border-dashed border-gray-300 text-center">
                <span class="text-xl font-bold text-indigo-600">ë¬¸í•­ ì„ íƒí•˜ê¸°</span>
                <p class="text-sm text-gray-500 mt-1">ë²ˆí˜¸ë¥¼ ëˆ„ë¥´ë©´ í•´ì„¤ì´ ë³´ì—¬ìš”!</p>
            </div>
            
            <div class="flex-1 overflow-y-auto hide-scrollbar">
                <div class="grid grid-cols-5 gap-2" id="question-grid">
                    <p class="col-span-5 text-center text-gray-400 py-10 text-xs">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                </div>
            </div>

            <div class="mt-4 pt-3 border-t-2 border-gray-100 bg-gray-50 rounded-xl p-3 text-center shrink-0">
                <p class="text-xs text-gray-400 mb-1">í˜„ì¬ ë³´ê³  ìˆëŠ” ë¬¸ì œ</p>
                <div id="current-info-badges" class="flex justify-center gap-2">
                    <span class="bg-gray-200 text-gray-500 text-xs px-2 py-1 rounded">ì„ íƒ ëŒ€ê¸°ì¤‘</span>
                </div>
            </div>
        </div>

        <div class="w-full md:w-2/3 relative perspective-1000">
            <div class="absolute -left-3 top-4 bottom-4 w-6 flex flex-col justify-between z-10 py-2">
                <div class="w-6 h-6 bg-gray-400 rounded-full shadow-inner border-2 border-gray-500"></div>
                <div class="w-6 h-6 bg-gray-400 rounded-full shadow-inner border-2 border-gray-500"></div>
                <div class="w-6 h-6 bg-gray-400 rounded-full shadow-inner border-2 border-gray-500"></div>
                <div class="w-6 h-6 bg-gray-400 rounded-full shadow-inner border-2 border-gray-500"></div>
                <div class="w-6 h-6 bg-gray-400 rounded-full shadow-inner border-2 border-gray-500"></div>
                <div class="w-6 h-6 bg-gray-400 rounded-full shadow-inner border-2 border-gray-500"></div>
            </div>

            <div class="w-full h-full bg-[#fffef0] rounded-r-lg shadow-2xl overflow-hidden flex flex-col border border-l-8 border-gray-300 notebook-paper">
                
                <div class="min-h-[4rem] border-b-2 border-gray-300 flex items-center px-6 py-3 ml-8 bg-indigo-50/10">
                    <span class="text-2xl font-bold text-gray-700 handwriting leading-tight break-keep" style="padding:0;" id="note-q-number">
                        Q. ë¬¸í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”
                    </span>
                </div>

                <div class="flex-1 overflow-y-auto p-6 ml-2 custom-scrollbar relative" id="note-content-area">
                    <div class="handwriting flex flex-col items-center justify-center h-full text-gray-400 opacity-50 text-center">
                        <i data-lucide="hand-metal" class="w-12 h-12 mb-2"></i>
                        ì™¼ìª½ì—ì„œ ë¬¸í•­ ë²ˆí˜¸ë¥¼<br>ì½•! ëˆŒëŸ¬ë³´ì„¸ìš”.
                    </div>
                </div>
                
                <div class="absolute bottom-4 right-4 transform rotate-[-10deg] opacity-80 pointer-events-none">
                    <span class="bg-yellow-200 text-yellow-800 px-3 py-1 text-lg font-bold shadow-lg border-2 border-yellow-400 rounded-sm">
                        Very Good! ğŸ‘
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ (ì‹œìŠ¤í…œ alert ëŒ€ì²´) -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-xs w-full mx-4">
            <i data-lucide="lock" class="w-12 h-12 text-indigo-600 mx-auto mb-4"></i>
            <h2 class="text-xl font-bold mb-2">ë¡œê·¸ì¸ í•„ìš”</h2>
            <p class="text-gray-500 text-sm mb-6">ìœ ë£Œ íšŒì› ì „ìš© ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br>ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.</p>
            <button id="go-login" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl active:scale-95 transition-transform">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const EXAM_ID = urlParams.get('id') || 'exam_01';
        
        let examMetaData = null;
        let aiExamData = null;

        function loadExamDataScript(examId) {
            return new Promise((resolve) => {
                const fileName = `${examId}/${examId}.js?v=${new Date().getTime()}`; 
                const script = document.createElement('script');
                script.src = fileName;
                
                script.onload = () => {
                    if (window.globalExamData) resolve(window.globalExamData);
                    else resolve(null);
                };
                
                script.onerror = () => {
                    console.warn(`í•´ì„¤ íŒŒì¼(${fileName})ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    resolve(null);
                };
                
                document.head.appendChild(script);
            });
        }

        async function init() {
            try {
                const [metaSnap, loadedAiData] = await Promise.allSettled([
                    getDoc(doc(db, "exams", EXAM_ID)),
                    loadExamDataScript(EXAM_ID)
                ]);

                if (metaSnap.status === 'fulfilled' && metaSnap.value.exists()) {
                    examMetaData = metaSnap.value.data();
                    document.getElementById('exam-title-header').innerText = examMetaData.title || "ë‚˜ë§Œì˜ ì˜¤ë‹µë…¸íŠ¸";
                } else {
                    document.getElementById('exam-title-header').innerText = "ì‹œí—˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                }

                if (loadedAiData.status === 'fulfilled' && loadedAiData.value) {
                    aiExamData = loadedAiData.value;
                }

                renderQuestionGrid();
                lucide.createIcons();

            } catch (e) {
                console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            }
        }

        // [ìˆ˜ì •] ìµëª… ë¡œê·¸ì¸ ë°°ì œ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸ ì—ëŸ¬ í•´ê²°
        onAuthStateChanged(auth, (user) => {
            if (user) {
                init();
            } else {
                const modal = document.getElementById('auth-modal');
                modal.classList.remove('hidden');
                document.getElementById('go-login').onclick = () => {
                    const target = 'exam.html';
                    // ë¹ˆ URLì´ ì•„ë‹˜ì„ ë³´ì¥í•˜ë©° ì•ˆì „í•˜ê²Œ ì´ë™
                    if (target) window.location.assign(target);
                };
            }
        });

        function renderQuestionGrid() {
            const grid = document.getElementById('question-grid');
            grid.innerHTML = '';
            const totalQ = examMetaData?.questions?.length || 25;

            for (let i = 1; i <= totalQ; i++) {
                const btn = document.createElement('button');
                btn.className = "w-full aspect-square rounded-xl bg-gray-100 border-2 border-gray-200 text-lg font-bold text-gray-500 hover:bg-indigo-100 hover:border-indigo-300 hover:text-indigo-600 transition-all flex items-center justify-center shadow-sm";
                btn.innerText = i;
                btn.onclick = () => selectQuestion(i, btn);
                grid.appendChild(btn);
            }
        }

        window.selectQuestion = (no, btnElement) => {
            document.querySelectorAll('#question-grid button').forEach(b => b.classList.remove('btn-selected'));
            btnElement.classList.add('btn-selected');

            // [ìˆ˜ì •] Firebase Databaseì˜ topic ê°’ì„ ìµœìš°ì„ ìœ¼ë¡œ í˜¸ì¶œ
            const dbQ = examMetaData?.questions ? examMetaData.questions[no-1] : { score: 0, correctAnswer: '-', topic: 'í†µí•©ê³¼í•™' };
            const aiQ = aiExamData?.explanations ? aiExamData.explanations.find(e => e.no === no) : null;
            
            const topic = dbQ.topic || aiQ?.topic || "í†µí•©ê³¼í•™";
            const content = aiQ?.content || "ì•—! ì•„ì§ ì´ ë¬¸í•­ì˜ ë¹„ë°€ë…¸íŠ¸ í•´ì„¤ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”. ğŸ˜…<br>ì„ ìƒë‹˜ì´ ì§€ê¸ˆ ì •ë¦¬ ì¤‘ì´ë‹ˆ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì¤˜!";

            const noteArea = document.getElementById('note-content-area');
            const qNumTitle = document.getElementById('note-q-number');
            
            noteArea.style.opacity = 0;
            
            setTimeout(() => {
                qNumTitle.innerHTML = `<span class="text-indigo-600 mr-2">Q${no}.</span>${topic}`;
                
                document.getElementById('current-info-badges').innerHTML = `
                    <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200 text-xs font-bold">ë°°ì  ${dbQ.score || 0}ì </span>
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded border border-blue-200 text-xs font-bold">ì •ë‹µ ${dbQ.correctAnswer || '-'}</span>
                `;
                
                // [ìˆ˜ì •] í•˜ë‹¨ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ pb-32 ì¶”ê°€
                noteArea.innerHTML = `<div class="handwriting leading-[30px] pt-2 pb-32">${content}</div>`;
                noteArea.style.opacity = 1;
                noteArea.style.transition = "opacity 0.3s ease-in-out";
            }, 150);
        };
    </script>
</body>
</html>