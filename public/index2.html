<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>갓통과 - 2028 통합과학 완전정복</title>
    
    <!-- 스타일링을 위한 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 아이콘 라이브러리 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 기본 폰트 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        /* 암기장용 손글씨 폰트 추가 */
        @import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Nanum+Pen+Script&display=swap');
        
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* 앱 컨테이너 스타일 */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #F9FAFB;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        /* 스크롤바 숨기기 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 애니메이션 */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 카드 뒤집기 효과 (3D Transform) */
        .card-flip { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        
        /* [중요] absolute 포지션이 HTML 클래스에 의해 덮어씌워지지 않도록 !important 사용하거나 HTML에서 relative 제거 */
        .card-front, .card-back { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            border-radius: 1.5rem; 
            top: 0; 
            left: 0; 
        }
        .card-back { transform: rotateY(180deg); }
        .flipped .card-inner { transform: rotateY(180deg); }

        /* 암기장 전용 스타일 */
        .font-gamja { font-family: 'Gamja Flower', cursive; }
        .font-pen { font-family: 'Nanum Pen Script', cursive; }
        .bg-paper { background-color: #FDFCF0; }
        .bg-paper-pattern {
            background-color: #ffffff;
            background-image: radial-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* 형광펜 효과 */
        .highlight-pen {
            background: linear-gradient(120deg, rgba(255, 240, 107, 0) 0%, rgba(255, 240, 107, 0.4) 100%);
            box-shadow: inset 0 -0.5em 0 rgba(255, 240, 107, 0.4);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="app-container" id="app">
        <!-- 상단 헤더 -->
        <header class="bg-white/80 backdrop-blur-md px-5 py-4 flex justify-between items-center sticky top-0 z-50 border-b border-gray-100">
            <div class="flex items-center gap-3 cursor-pointer" onclick="renderHome()">
                <!-- 로고 -->
                <div class="w-10 h-10 bg-gray-900 rounded-xl flex items-center justify-center relative overflow-hidden shrink-0 shadow-md transform hover:rotate-3 transition-transform">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-900 to-black opacity-80"></div>
                    <svg class="w-7 h-7 relative z-10" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <ellipse cx="50" cy="50" rx="40" ry="12" stroke="url(#grad_header)" stroke-width="6" transform="rotate(45 50 50)"/>
                        <ellipse cx="50" cy="50" rx="40" ry="12" stroke="url(#grad_header)" stroke-width="6" transform="rotate(-45 50 50)"/>
                        <circle cx="50" cy="50" r="8" fill="#A78BFA"/>
                        <defs>
                            <linearGradient id="grad_header" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#3B82F6;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <!-- 타이틀 영역 -->
                <div class="flex flex-col justify-center">
                    <div class="flex items-baseline gap-2">
                    <h1 class="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 drop-shadow-sm flex items-center gap-1">
                        갓통과<span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-1.5 py-0.5 rounded-full border border-indigo-100 tracking-normal self-start mt-1">PLUS</span>
                    </h1>
                </div>
            </div>
            </div>
            <div class="flex items-center gap-3">
                <button class="relative p-2 hover:bg-gray-50 rounded-full transition-colors">
                    <i data-lucide="bell" class="w-6 h-6 text-gray-600"></i>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
            </div>
        </header>

        <!-- 메인 콘텐츠 영역 -->
        <main id="main-content" class="flex-1 overflow-y-auto p-5 pb-28 hide-scrollbar">
            <!-- 자바스크립트에 의해 콘텐츠가 여기에 로드됩니다 -->
        </main>

        <!-- 하단 네비게이션 바 -->
        <nav class="bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center fixed bottom-0 w-full max-w-[480px] z-50 pb-6 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
            <button onclick="renderHome()" class="nav-btn text-indigo-600 flex flex-col items-center gap-1 transition-colors">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">홈</span>
            </button>
            
            <button onclick="location.href='STEST/exam.html'" class="nav-btn text-gray-400 flex flex-col items-center gap-1 transition-colors">
                <i data-lucide="file-text" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">시험응시</span>
            </button>
            
            <button onclick="location.href='Q-Bank/student_quiz.html'" class="nav-btn flex flex-col items-center gap-1 -mt-8 group">
                <div class="bg-gray-900 p-4 rounded-full shadow-lg shadow-gray-300 group-hover:scale-105 transition-transform group-active:scale-95 border-4 border-white">
                    <i data-lucide="brain-circuit" class="w-7 h-7 text-white"></i>
                </div>
                <span class="text-[10px] font-bold text-gray-600 mt-1">문제은행</span>
            </button>
            
            <button onclick="location.href='STEST/exam.html?view=report'" class="nav-btn text-gray-400 flex flex-col items-center gap-1 transition-colors">
                <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">성적분석</span>
            </button>
            
            <button onclick="renderMarket()" class="nav-btn text-gray-400 flex flex-col items-center gap-1 transition-colors">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">마이</span>
            </button>
        </nav>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 전역 변수
        window.auth = auth;
        window.db = db;
        
        let currentUser = null;
        let userData = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(userDoc.exists()) {
                        userData = userDoc.data();
                    }
                } catch(e) { console.error("User Load Error:", e); }
                
                if (document.getElementById('mypage-user-name')) {
                    renderMarket();
                }
            } else {
                currentUser = null;
                userData = null;
                if (document.getElementById('mypage-user-name')) {
                    renderMarket();
                }
            }
        });

        window.handleLogout = () => {
            if(confirm("정말 로그아웃 하시겠습니까?")) {
                signOut(auth).then(() => {
                    alert("로그아웃 되었습니다.");
                    renderHome(); 
                }).catch((error) => {
                    console.error("Logout Error:", error);
                });
            }
        };

        // --- 데이터: 5종 교과서 통합 분석 데이터 ---
        window.FULL_CARD_DATABASE = [
             {
                id: "U1_001",
                unit: "1. 과학의 기초",
                term: "기본량 (Base Quantities)",
                definition: "다른 물리량을 정의하는 데 기초가 되는 7가지 물리량.",
                hook: "길질시 전온물광 (길이, 질량, 시간, 전류, 온도, 물질량, 광도)",
                publisher_note: {
                    default: "SI 단위계의 기초가 됨.",
                    visang: "킬로그램 원기 폐지와 플랑크 상수를 이용한 재정의 역사 중요!",
                    miraen: "물질량(mol)과 광도(cd)는 심화 학습으로 분류됨."
                }
            },
            {
                id: "U1_002",
                unit: "1. 과학의 기초",
                term: "계통 오차 (Systematic Error)",
                definition: "측정 계기의 불완전함이나 잘못된 실험 방법으로 인해 발생하는 오차.",
                hook: "원인을 알 수 있어 보정 가능한 오차! (영점 조절 실패 등)",
                publisher_note: {
                    default: "반복 측정으로 줄일 수 없는 오차임.",
                    chunjae: "실험 기구의 눈금을 읽는 관측자의 습관도 원인이 됨."
                }
            },
            {
                id: "U2_001",
                unit: "2. 물질과 규칙성",
                term: "스펙트럼 (Spectrum)",
                definition: "빛이 분광기를 통과할 때 파장에 따라 분산되어 나타나는 색의 띠.",
                hook: "우주의 지문! 선 스펙트럼으로 원소를 식별한다.",
                publisher_note: {
                    default: "연속, 방출(선), 흡수 스펙트럼의 차이 구별 필수.",
                    donga: "태양의 흡수 스펙트럼(프라운호퍼 선) 탐구 활동 강조."
                }
            },
            {
                id: "U2_002",
                unit: "2. 물질과 규칙성",
                term: "공유 결합 (Covalent Bond)",
                definition: "비금속 원소들이 전자쌍을 공유하여 형성하는 화학 결합.",
                hook: "너 하나 나 하나, 사이좋게 공유해서 옥텟 규칙 만족!",
                publisher_note: {
                    default: "물(H₂O), 메테인(CH₄) 등이 대표적 예시.",
                    jihak: "단일, 이중, 삼중 결합의 결합 길이와 에너지 비교 심화."
                }
            },
            {
                id: "U3_001",
                unit: "3. 시스템과 상호작용",
                term: "충격량 (Impulse)",
                definition: "물체에 작용하는 힘과 힘이 작용한 시간의 곱 (I = FΔt).",
                hook: "운동량의 변화량과 같다! (I = Δp)",
                publisher_note: {
                    default: "에어백, 범퍼 등 안전 장치의 원리.",
                    visang: "그래프(F-t) 밑넓이가 충격량임을 강조."
                }
            },
            {
                id: "U3_002",
                unit: "3. 시스템과 상호작용",
                term: "중심 원리 (Central Dogma)",
                definition: "유전 정보가 DNA → RNA → 단백질 순으로 전달된다는 원리.",
                hook: "DNA는 설계도, RNA는 전달자, 단백질은 일꾼!",
                publisher_note: {
                    default: "전사(Transcription)와 번역(Translation) 과정 구분.",
                    miraen: "코돈표 해석 문제가 자주 출제됨."
                }
            },
            {
                id: "U4_001",
                unit: "4. 변화와 다양성",
                term: "산화 (Oxidation)",
                definition: "물질이 산소를 얻거나 전자를 잃는 화학 반응.",
                hook: "산소는 얻고(O), 전자는 잃고(X) → '산얻전잃'",
                publisher_note: {
                    default: "환원과 항상 동시에 일어남 (동시성).",
                    visang: "전자의 이동에 의한 산화 환원 메커니즘 심화 설명."
                }
            },
            {
                id: "U5_001",
                unit: "5. 환경과 에너지",
                term: "지구 열수지 (Heat Budget)",
                definition: "지구가 흡수하는 태양 복사 에너지와 방출하는 지구 복사 에너지의 평형.",
                hook: "들어온 만큼 나간다! (복사 평형 → 온도 일정)",
                publisher_note: {
                    default: "온실 효과로 인한 에너지 재방출 과정 이해 필요.",
                    chunjae: "위도별 에너지 불균형과 대기 대순환 연계."
                }
            }
        ];
        
        window.activeDeck = []; 
        window.currentCardIndex = 0;
        window.selectedPublisher = 'visang';

        // 1. 홈 화면 렌더링
        window.renderHome = function() {
            updateNav('홈');
            document.querySelector('.app-container').style.backgroundColor = '#F9FAFB';
            
            const html = `
                <div class="fade-in space-y-6">
                    <!-- 1. 핵심 서비스: 프리미엄 모의고사 -->
                    <div class="relative bg-gray-900 rounded-3xl p-6 text-white overflow-hidden shadow-xl group cursor-pointer" onclick="location.href='STEST/exam.html'">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-600 rounded-full blur-3xl opacity-20 -mr-16 -mt-16"></div>
                        <div class="absolute bottom-0 left-0 w-48 h-48 bg-purple-600 rounded-full blur-3xl opacity-20 -ml-10 -mb-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-3">
                                <span class="bg-indigo-500/30 border border-indigo-400/30 text-indigo-100 text-[10px] font-bold px-2 py-1 rounded-full backdrop-blur-sm">국내 최고 퀄리티</span>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <h2 class="text-3xl font-black mb-2 leading-tight"><span class="text-white">통합과학 실전모의고사</span></h2>
                            <p class="text-gray-400 text-xs mb-6 max-w-[90%] font-medium">수능 1등급을 위한 프리미엄 서비스. 24회차 풀패키지 진행중.</p>
                            <div class="flex gap-3">
                                <button class="flex-1 bg-white text-gray-900 py-3.5 rounded-xl font-bold text-sm hover:bg-gray-50 transition-colors flex items-center justify-center gap-2 shadow-lg">
                                    <i data-lucide="pen-tool" class="w-4 h-4 text-indigo-600"></i> 시험 응시하기
                                </button>
                                <button class="w-1/3 bg-gray-800 text-white border border-gray-700 py-3.5 rounded-xl font-bold text-sm hover:bg-gray-700 transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="file-check" class="w-4 h-4"></i> OMR
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 데일리 트레이닝 -->
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 mb-3 px-1 flex items-baseline gap-2">
                            데일리 트레이닝
                            <span class="text-xs text-indigo-500 font-medium tracking-wide">Daily Training</span>
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- 용어 학습 카드 -->
                            <div onclick="startNewSession()" class="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-2xl border border-blue-100 active:scale-95 transition-transform cursor-pointer relative overflow-hidden group">
                                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="layers" class="w-16 h-16 text-blue-600"></i></div>
                                <div class="bg-white w-10 h-10 rounded-full flex items-center justify-center shadow-sm mb-3 text-blue-600"><i data-lucide="book-open" class="w-5 h-5"></i></div>
                                <h4 class="font-bold text-gray-800 mb-1 font-gamja text-xl">용어 암기장</h4>
                                <p class="text-[11px] text-gray-500 leading-tight">손글씨 노트 보고<br>용어 맞추기</p>
                            </div>
                            <!-- 오늘의 퀴즈 -->
                            <!-- [수정] student_quiz.html로 연결되도록 변경 -->
                            <div onclick="location.href='Q-Bank/student_quiz.html'" class="bg-gradient-to-br from-orange-50 to-red-50 p-5 rounded-2xl border border-orange-100 active:scale-95 transition-transform cursor-pointer relative overflow-hidden group">
                                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="zap" class="w-16 h-16 text-orange-600"></i></div>
                                <div class="bg-white w-10 h-10 rounded-full flex items-center justify-center shadow-sm mb-3 text-orange-600"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                                <h4 class="font-bold text-gray-800 mb-1">오늘의 퀴즈</h4>
                                <p class="text-[11px] text-gray-500 leading-tight">이동 시간에 푸는<br>수능필수암기 문제 은행</p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 성적 분석 요약 -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <h3 class="font-bold text-lg text-gray-900">나의 학습 리포트</h3>
                                <p class="text-xs text-gray-500 mt-1">최근 모의고사 성적 추이입니다.</p>
                            </div>
                            <span class="text-indigo-600 font-bold text-2xl">B+ <span class="text-xs text-gray-400 font-normal">등급</span></span>
                        </div>
                        <div class="h-32 w-full bg-gray-50 rounded-xl relative overflow-hidden flex items-end justify-between px-6 pb-4 mb-4">
                            <div class="w-4 bg-gray-200 h-[40%] rounded-t-sm"></div>
                            <div class="w-4 bg-gray-200 h-[55%] rounded-t-sm"></div>
                            <div class="w-4 bg-gray-200 h-[45%] rounded-t-sm"></div>
                            <div class="w-4 bg-indigo-500 h-[75%] rounded-t-sm relative group">
                                <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">이번 시험</div>
                            </div>
                            <div class="w-4 bg-gray-200 h-[60%] rounded-t-sm"></div>
                            <div class="absolute top-1/2 left-0 w-full border-t border-dashed border-gray-300"></div>
                        </div>
                        <button onclick="location.href='STEST/exam.html?view=report'" class="w-full py-3 border border-gray-200 rounded-xl text-gray-600 text-sm font-bold hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="pie-chart" class="w-4 h-4"></i> 취약 단원 상세 분석 보기
                        </button>
                    </div>

                    <!-- 고객센터 -->
                    <div class="mt-8 pt-6 border-t border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-3 text-sm px-1">학습에 어려움이 있나요?</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div onclick="openKakaoInquiry()" class="bg-[#FEE500] p-4 rounded-xl flex flex-col items-center justify-center cursor-pointer shadow-sm active:scale-95 transition-transform">
                                <div class="bg-white/30 p-2 rounded-lg mb-2"><i data-lucide="message-circle" class="w-6 h-6 text-[#371D1E]"></i></div>
                                <span class="text-xs font-bold text-[#371D1E]">카톡 문의하기</span><span class="text-[9px] text-[#371D1E]/70 mt-0.5">실시간 상담</span>
                            </div>
                            <div class="bg-white border border-gray-200 p-4 rounded-xl flex flex-col items-center justify-center cursor-pointer shadow-sm active:scale-95 transition-transform" onclick="copyToClipboard('godtonggwa@gmail.com')">
                                <div class="bg-gray-50 p-2 rounded-lg mb-2"><i data-lucide="mail" class="w-6 h-6 text-gray-600"></i></div>
                                <span class="text-xs font-bold text-gray-700">이메일 문의</span><span class="text-[9px] text-gray-400 mt-0.5">godtonggwa@gmail.com</span>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-3 text-center">운영시간: 평일 09:00 - 18:00 (주말/공휴일 휴무)</p>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
            lucide.createIcons();
        }

        // 학습 세션 시작
        window.startNewSession = function() {
            window.activeDeck = [...window.FULL_CARD_DATABASE]; 
            window.currentCardIndex = 0;
            renderFlashcards();
        }

        // 용어 암기장 렌더링
        window.renderFlashcards = function() {
            updateNav('홈');
            document.querySelector('.app-container').style.backgroundColor = '#FDFCF0';
            
            const card = window.activeDeck[window.currentCardIndex];
            
            const publisherTip = card.publisher_note[window.selectedPublisher] || card.publisher_note.default;
            const publisherName = window.selectedPublisher === 'visang' ? '비상' : 
                                  window.selectedPublisher === 'miraen' ? '미래엔' : 
                                  window.selectedPublisher === 'chunjae' ? '천재' : 
                                  window.selectedPublisher === 'donga' ? '동아' : '지학사';

            const html = `
                <div class="fade-in h-full flex flex-col relative">
                    <!-- 상단 네비게이션 -->
                    <div class="flex items-center justify-between mb-2">
                        <button onclick="renderHome()" class="p-2 -ml-2 hover:bg-black/5 rounded-full transition-colors">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] text-gray-400 font-bold tracking-widest uppercase">Flashcard</span>
                            <span class="text-xl font-bold text-gray-800 font-gamja">${window.currentCardIndex + 1} / ${window.activeDeck.length}</span>
                        </div>
                        <button onclick="togglePublisherSetting()" class="p-2 -mr-2 hover:bg-black/5 rounded-full transition-colors">
                            <i data-lucide="settings-2" class="w-5 h-5 text-gray-600"></i>
                        </button>
                    </div>

                    <!-- 설정 패널 -->
                    <div id="publisher-settings" class="hidden mb-4 bg-white p-4 rounded-xl border border-indigo-100 shadow-sm animate-fade-in-down">
                        <p class="text-xs font-bold text-indigo-600 mb-2">내 교과서 선택</p>
                        <div class="flex flex-wrap gap-2">
                            ${['visang:비상', 'miraen:미래엔', 'chunjae:천재', 'donga:동아', 'jihak:지학사'].map(pub => {
                                const [key, name] = pub.split(':');
                                const activeClass = window.selectedPublisher === key ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-500 border-gray-200';
                                return `<button onclick="changePublisher('${key}')" class="text-xs px-3 py-1.5 rounded-lg border font-medium ${activeClass}">${name}</button>`;
                            }).join('')}
                        </div>
                    </div>

                    <!-- 카드 영역 (높이 조절: 55vh) -->
                    <div class="flex-1 flex flex-col justify-center items-center py-4 relative perspective-1000">
                        <div class="w-full max-w-[320px] h-[75vh] min-h-[400px] card-flip cursor-pointer group relative" onclick="toggleFlashcard(this)">
                            <div class="card-inner w-full h-full duration-500">
                                
                                <!-- [앞면] 손글씨 요약 노트 -->
                                <!-- [FIX]: relative 클래스 제거 -->
                                <div class="card-front bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-200 p-0 flex flex-col text-left overflow-hidden bg-paper-pattern">
                                    <div class="relative w-full h-full flex flex-col">
                                        <div class="p-6 pb-2 border-b border-dashed border-gray-200 text-center bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                                            <span class="inline-block px-3 py-1 bg-indigo-50 text-indigo-600 text-[10px] font-bold rounded-full border border-indigo-100 mb-1 tracking-tight">
                                                ${card.unit}
                                            </span>
                                            <p class="text-gray-400 text-xs font-bold mt-1">이 설명은 어떤 용어일까요?</p>
                                        </div>
                                        
                                        <div class="flex-1 p-6 pt-4 overflow-y-auto hide-scrollbar space-y-5">
                                            <div>
                                                <span class="text-[10px] font-bold text-gray-400 block mb-1 uppercase tracking-wider">Definition</span>
                                                <p class="text-2xl text-gray-700 leading-normal font-pen transform -rotate-1 origin-left">
                                                    ${card.definition}
                                                </p>
                                            </div>
                                            
                                            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 relative shadow-sm">
                                                <div class="absolute -top-2.5 -left-1 bg-[#FCD34D] text-white text-[9px] font-bold px-2 py-0.5 rounded shadow-sm transform -rotate-3 flex items-center gap-1">
                                                    <i data-lucide="lightbulb" class="w-3 h-3"></i> 암기 TIP
                                                </div>
                                                <p class="text-xl text-gray-800 font-pen leading-relaxed relative z-10 mt-1">
                                                    <span class="highlight-pen px-1 box-decoration-clone">
                                                        "${card.hook}"
                                                    </span>
                                                </p>
                                            </div>

                                            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-2">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-[10px] font-bold text-indigo-600 flex items-center gap-1">
                                                        <i data-lucide="book" class="w-3 h-3"></i> 교과서 Point
                                                    </span>
                                                    <span class="text-[9px] bg-indigo-200 text-indigo-800 px-1.5 py-0.5 rounded font-bold">
                                                        ${publisherName}
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-700 leading-snug font-sans text-justify break-keep">
                                                    ${publisherTip}
                                                </p>
                                            </div>
                                            <div class="text-center pb-2 opacity-50">
                                                <span class="text-xs font-light text-gray-400 animate-pulse">탭하여 정답 확인</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- [뒷면] 용어 정답 -->
                                <!-- [FIX]: relative 클래스 제거 -->
                                <div class="card-back bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-200 overflow-hidden">
                                    <div class="relative w-full h-full flex flex-col justify-center items-center p-8 text-center">
                                        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-24 h-6 bg-indigo-100/50 rotate-2 z-0"></div>
                                        
                                        <span class="text-xs font-bold text-indigo-500 mb-4 block uppercase tracking-widest border border-indigo-200 px-2 py-1 rounded-full bg-white relative z-10">Answer</span>
                                        
                                        <h2 class="text-4xl leading-snug text-gray-800 mb-2 break-keep font-gamja relative z-10">
                                            ${card.term.split('(')[0]}
                                        </h2>
                                        <p class="text-gray-400 text-lg font-serif italic mb-8 relative z-10">
                                            ${card.term.includes('(') ? `(${card.term.split('(')[1]}` : ''}
                                        </p>
                                        
                                        <p class="text-gray-300 text-xs font-light animate-pulse absolute bottom-8 w-full text-center">
                                            탭하여 다음 카드
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('main-content').innerHTML = html;
            lucide.createIcons();
        }

        window.toggleFlashcard = function(element) {
            // 심플 모드 로직: 이미 뒤집혀있으면 다음 카드로
            if (element.classList.contains('flipped')) {
                nextCard();
            } else {
                element.classList.add('flipped');
            }
        }

        window.nextCard = function() {
            setTimeout(() => {
                if (window.currentCardIndex < window.activeDeck.length - 1) {
                    window.currentCardIndex++;
                    renderFlashcards();
                } else {
                    alert("완벽합니다! 오늘의 모든 용어를 마스터하셨어요! 갓통과 하세요!");
                    renderHome();
                }
            }, 200);
        }
        
        window.togglePublisherSetting = function() {
            const el = document.getElementById('publisher-settings');
            el.classList.toggle('hidden');
        }
        
        window.changePublisher = function(pubKey) {
            window.selectedPublisher = pubKey;
            renderFlashcards(); 
        }

        // 분석, 마이페이지, 기타 기능
        window.renderAnalysis = function() { location.href = 'STEST/exam.html?view=report'; }
        window.updateUserInfo = async () => {
            if(!currentUser) return alert("로그인이 필요합니다.");
            const newName = prompt("변경할 닉네임을 입력:", userData.name);
            if(newName && newName.trim()) {
                try { await updateDoc(doc(db, "users", currentUser.uid), { name: newName.trim() }); userData.name = newName.trim(); alert("변경 완료"); renderMarket(); }
                catch(e) { console.error(e); }
            }
        };
        window.manageSubscription = () => { if(!currentUser) return alert("로그인 필요"); alert(userData.isPaid ? "프리미엄 이용 중" : "관리자 문의 필요"); };
        window.openSettings = () => { alert("설정\n\nv1.3.0"); };
        window.openKakaoInquiry = () => { window.open("https://open.kakao.com/o/s2YBNObi", '_blank'); };
        window.copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => alert('복사 완료')).catch(() => alert('복사 실패')); };
        window.renderMarket = function() {
            updateNav('마이');
            const userName = userData ? userData.name : '비회원';
            let userPlan = userData && userData.isPaid ? '프리미엄' : '일반';
            const loginBtn = currentUser ? `<button onclick="handleLogout()" class="text-xs text-gray-500 underline ml-auto">로그아웃</button>` : `<button onclick="location.href='STEST/exam.html'" class="text-xs text-indigo-600 font-bold ml-auto">로그인</button>`;
            document.getElementById('main-content').innerHTML = `
                <div class="fade-in space-y-4 pt-10 px-6">
                    <h2 class="text-xl font-bold text-gray-800 flex justify-between items-center">마이페이지 ${loginBtn}</h2>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex items-center gap-4 shadow-sm">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-400"><i data-lucide="user" class="w-6 h-6"></i></div>
                        <div><p class="font-bold text-lg">${userName}님</p><p class="text-xs text-gray-500">${userPlan}</p></div>
                    </div>
                    <!-- (생략: 기존 메뉴들 유지) -->
                    <div class="space-y-3 mt-6">
                         <div onclick="updateUserInfo()" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50"><div class="flex items-center gap-3"><i data-lucide="edit-3" class="w-4 h-4 text-blue-500"></i><span class="text-sm">내 정보 수정</span></div></div>
                         <div onclick="manageSubscription()" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50"><div class="flex items-center gap-3"><i data-lucide="credit-card" class="w-4 h-4 text-purple-500"></i><span class="text-sm">이용권 관리</span></div></div>
                    </div>
                </div>`;
            lucide.createIcons();
        }
        window.updateNav = function(activeName) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const text = btn.querySelector('span').innerText;
                if(text === activeName) { btn.classList.remove('text-gray-400'); btn.classList.add('text-indigo-600'); }
                else { btn.classList.remove('text-indigo-600'); btn.classList.add('text-gray-400'); }
            });
        }
        renderHome();
        window.addEventListener('load', () => { if(window.lucide) lucide.createIcons(); });
    </script>
</body>
</html>