<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°“í†µê³¼ - ê¸°ì¶œ ì¢Œí‘œ ì¶”ì¶œê¸° (Admin)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #0f172a; color: white; }
        
        /* ì‘ì—… ì˜ì—­: ê°€ë¡œ/ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©, ì¤‘ì•™ ì •ë ¬ */
        #viewer-pane {
            scroll-behavior: smooth;
            background-color: #020617;
        }

        #pdf-render-container { 
            position: relative; 
            display: inline-block; 
            cursor: crosshair; 
            user-select: none;
            text-align: left;
            margin: 40px auto 120px auto; /* ìƒí•˜ ì—¬ë°±ìœ¼ë¡œ ì‹œì•¼ í™•ë³´ */
        }
        
        #selection-rect {
            position: absolute; border: 2px solid #6366f1; background-color: rgba(99, 102, 241, 0.2);
            pointer-events: none; display: none; z-index: 10;
        }
        .captured-rect {
            position: absolute; border: 1px solid #10b981; background-color: rgba(16, 185, 129, 0.1);
            pointer-events: none; z-index: 5;
        }
        
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- ìƒë‹¨ íˆ´ë°” -->
    <header class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center shrink-0 shadow-2xl z-50">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg shadow-inner"><i data-lucide="crosshair" class="w-5 h-5"></i></div>
            <h1 class="text-xl font-black tracking-tight">ê¸°ì¶œ ì¢Œí‘œ ì¶”ì¶œê¸° <span class="text-xs text-indigo-400 font-bold ml-2 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Pro Admin</span></h1>
        </div>
        
        <!-- í™•ëŒ€/ì¶•ì†Œ ì œì–´ê¸° (ì¤‘ì•™ ë°°ì¹˜) -->
        <div class="flex items-center gap-2 bg-slate-900 px-3 py-1.5 rounded-2xl border border-slate-700 shadow-inner">
            <button onclick="changeZoom(-0.2)" class="p-1.5 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white" title="ì¶•ì†Œ"><i data-lucide="minus-circle" class="w-5 h-5"></i></button>
            <div class="flex flex-col items-center px-2">
                <span id="zoom-label" class="text-[11px] font-black text-indigo-400 leading-none">100%</span>
                <span class="text-[8px] text-slate-500 font-bold uppercase mt-0.5">Zoom</span>
            </div>
            <button onclick="changeZoom(0.2)" class="p-1.5 hover:bg-slate-800 rounded-lg transition-colors text-slate-400 hover:text-white" title="í™•ëŒ€"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
            <div class="w-px h-4 bg-slate-700 mx-2"></div>
            <button onclick="resetZoom()" class="px-2 py-1 text-[9px] font-black bg-slate-800 hover:bg-indigo-600 rounded text-slate-300 hover:text-white transition-colors">FIT</button>
        </div>

        <div class="flex gap-2">
            <input type="file" id="pdf-input" accept=".pdf" class="hidden">
            <button onclick="document.getElementById('pdf-input').click()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-2 border border-slate-600">
                <i data-lucide="file-up" class="w-4 h-4"></i> PDF ë¡œë“œ
            </button>
            <button onclick="saveToDB()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-2 shadow-lg shadow-emerald-900/20">
                <i data-lucide="save" class="w-4 h-4"></i> DB ì €ì¥
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- PDF ë·°ì–´ íŒ¨ë„ (í™•ëŒ€/ì¶•ì†Œ ëŒ€ìƒ) -->
        <div class="flex-1 overflow-auto custom-scrollbar text-center relative p-4" id="viewer-pane">
            <div id="pdf-render-container" class="shadow-[0_0_50px_rgba(0,0,0,0.5)] bg-white">
                <canvas id="pdf-canvas"></canvas>
                <div id="selection-rect"></div>
                <div id="captured-layers"></div>
            </div>
        </div>

        <!-- ì„¤ì • ì‚¬ì´ë“œë°” (ì™„ì „ ê³ ì • ë©”ë‰´) -->
        <aside class="w-96 bg-slate-900 border-l border-slate-800 flex flex-col shrink-0 shadow-2xl z-40 h-full">
            <!-- ì‚¬ì´ë“œë°” í—¤ë”: ì‹œí—˜ ì •ë³´ -->
            <div class="p-6 border-b border-slate-800 bg-slate-900/80 backdrop-blur-md">
                <div class="mb-5">
                    <label class="text-[10px] uppercase font-black text-indigo-400 mb-1.5 block tracking-widest flex items-center gap-1">
                        <i data-lucide="tag" class="w-3 h-3"></i> Target Exam ID
                    </label>
                    <input type="text" id="target-exam-id" placeholder="ì˜ˆ: 2028_PRETEST" class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 font-bold text-indigo-300 shadow-inner text-sm">
                </div>
                <div class="flex justify-between items-center mb-3">
                    <span id="page-info" class="text-[11px] text-slate-500 font-black uppercase tracking-tighter">PDF Navigation</span>
                    <span class="text-[10px] text-slate-600 font-bold" id="total-pages-label">Page 0 of 0</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="prevPage()" class="flex-1 bg-slate-800 py-3 rounded-xl hover:bg-indigo-600 transition-all border border-slate-700 hover:border-indigo-500 group">
                        <i data-lucide="chevron-left" class="mx-auto group-hover:-translate-x-1 transition-transform"></i>
                    </button>
                    <button onclick="nextPage()" class="flex-1 bg-slate-800 py-3 rounded-xl hover:bg-indigo-600 transition-all border border-slate-700 hover:border-indigo-500 group">
                        <i data-lucide="chevron-right" class="mx-auto group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- ì‚¬ì´ë“œë°” ë°”ë””: ì…ë ¥ í¼ & ëª©ë¡ (ë‚´ë¶€ ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
            <div class="p-6 flex-1 overflow-y-auto space-y-8 custom-scrollbar bg-slate-900">
                <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-800">
                    <h2 class="font-bold text-white mb-5 flex items-center gap-2 text-xs uppercase tracking-wide opacity-80"><i data-lucide="edit-3" class="w-4 h-4 text-indigo-500"></i> ë¬¸í•­ ìƒì„¸ ì„¤ì •</h2>
                    <div class="space-y-5">
                        <div>
                            <label class="text-[10px] uppercase font-black text-slate-500 mb-1.5 block ml-1">ë¬¸í•­ ë²ˆí˜¸ (ìë™ ì¦ê°€)</label>
                            <input type="number" id="q-num" value="1" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 outline-none focus:border-indigo-500 font-black text-xl shadow-inner">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] uppercase font-black text-slate-500 mb-1.5 block ml-1">ì •ë‹µ ê¸°í˜¸</label>
                                <input type="text" id="q-ans" placeholder="ì˜ˆ: â‘ " class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 outline-none focus:border-indigo-500 font-bold shadow-inner text-emerald-400">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-black text-slate-500 mb-1.5 block ml-1">ë°°ì </label>
                                <input type="number" id="q-score" value="3" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 outline-none focus:border-indigo-500 font-bold shadow-inner">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-black text-slate-500 mb-1.5 block ml-1">ë‹¨ì›ëª… (Topic)</label>
                            <input type="text" id="q-topic" placeholder="ì˜ˆ: ë¬¼ì§ˆì˜ ê·œì¹™ì„±" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 outline-none focus:border-indigo-500 font-bold shadow-inner text-sm">
                        </div>
                    </div>
                </div>

                <div class="pt-2">
                    <h2 class="font-bold text-white mb-4 flex items-center justify-between">
                        <span class="text-[11px] uppercase tracking-widest opacity-60">ì¶”ì¶œ ì™„ë£Œ ëª©ë¡</span>
                        <span id="captured-count" class="text-[10px] font-black bg-indigo-600 px-2 py-0.5 rounded-md">0</span>
                    </h2>
                    <div id="data-list" class="space-y-2">
                        <!-- ë™ì ìœ¼ë¡œ ì•„ì´í…œ ì¶”ê°€ -->
                    </div>
                </div>
            </div>

            <!-- ì‚¬ì´ë“œë°” í‘¸í„°: ì¡°ì‘ íŒ -->
            <div class="p-5 bg-slate-950/80 border-t border-slate-800">
                <button onclick="copyCode()" class="w-full py-2.5 mb-4 bg-slate-800 hover:bg-slate-700 rounded-xl text-[11px] font-bold transition-all flex items-center justify-center gap-2 border border-slate-700 text-slate-300">
                    <i data-lucide="copy" class="w-3.5 h-3.5"></i> í´ë¦½ë³´ë“œì— ì½”ë“œ ë³µì‚¬
                </button>
                <div class="flex items-start gap-2 bg-indigo-500/5 p-3 rounded-xl border border-indigo-500/10">
                    <i data-lucide="mouse-pointer-2" class="w-4 h-4 text-indigo-400 shrink-0 mt-0.5"></i>
                    <p class="text-[10px] text-slate-500 leading-relaxed font-medium">
                        <b class="text-indigo-400">ë“œë˜ê·¸ íŒ:</b> ë“œë˜ê·¸ ì¤‘ í™”ë©´ ëìœ¼ë¡œ ë§ˆìš°ìŠ¤ë¥¼ ì˜®ê¸°ë©´ <span class="text-slate-300 underline underline-offset-2">ìë™ ìŠ¤í¬ë¡¤</span>ë©ë‹ˆë‹¤. ì„¸ë°€í•œ ì„ íƒì´ í•„ìš”í•  ë• ìƒë‹¨ ë©”ë‰´ì—ì„œ <b class="text-slate-300">í™•ëŒ€(Zoom In)</b> í•˜ì„¸ìš”.
                    </p>
                </div>
            </div>
        </aside>
    </main>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold text-white tracking-widest text-sm uppercase">Synchronizing...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs", authDomain: "godtonggwa.firebaseapp.com", projectId: "godtonggwa", storageBucket: "godtonggwa.firebasestorage.app", messagingSenderId: "1087434066468", appId: "1:1087434066468:web:00a75c9329543afc76e6b1" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'godtonggwa_v1';

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let currentScale = 1.4; 
        let canvas = document.getElementById('pdf-canvas');
        let ctx = canvas.getContext('2d');
        let currentData = {};

        signInAnonymously(auth);

        document.getElementById('pdf-input').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async function() {
                pdfDoc = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                pageNum = 1;
                renderPage();
            };
            reader.readAsArrayBuffer(file);
        };

        async function renderPage() {
            if(!pdfDoc) return;
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: currentScale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: ctx, viewport }).promise;
            
            document.getElementById('total-pages-label').innerText = `Page ${pageNum} of ${pdfDoc.numPages}`;
            document.getElementById('zoom-label').innerText = `${Math.round(currentScale * 100 / 1.4)}%`;
            updateDataList();
            renderCapturedLayers();
        }

        window.prevPage = () => { if(pageNum > 1) { pageNum--; renderPage(); } };
        window.nextPage = () => { if(pageNum < pdfDoc.numPages) { pageNum++; renderPage(); } };

        // ì¤Œ ì œì–´: ìº”ë²„ìŠ¤ í¬ê¸°ë§Œ ë³€ê²½í•˜ì—¬ ì‚¬ì´ë“œë°”ì— ì˜í–¥ ì£¼ì§€ ì•ŠìŒ
        window.changeZoom = (delta) => {
            currentScale = Math.max(0.4, Math.min(5.0, currentScale + delta));
            renderPage();
        };
        window.resetZoom = () => {
            currentScale = 1.4;
            renderPage();
        };

        const viewerPane = document.getElementById('viewer-pane');
        const container = document.getElementById('pdf-render-container');
        const selection = document.getElementById('selection-rect');
        let startX, startY, isDragging = false;
        let scrollInterval = null;

        // ë“œë˜ê·¸ ì¤‘ ìë™ ìŠ¤í¬ë¡¤ ë¡œì§
        function handleAutoScroll(e) {
            const threshold = 80; 
            const speed = 20; 
            
            const rect = viewerPane.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            clearInterval(scrollInterval);
            
            let dx = 0;
            let dy = 0;

            if (mouseY < rect.top + threshold) dy = -speed;
            else if (mouseY > rect.bottom - threshold) dy = speed;
            
            if (mouseX < rect.left + threshold) dx = -speed;
            else if (mouseX > rect.right - threshold) dx = speed;

            if (dx !== 0 || dy !== 0) {
                scrollInterval = setInterval(() => {
                    viewerPane.scrollBy(dx, dy);
                }, 20);
            }
        }

        container.onmousedown = (e) => {
            if(!pdfDoc) return;
            isDragging = true;
            const bounds = container.getBoundingClientRect();
            startX = e.clientX - bounds.left;
            startY = e.clientY - bounds.top;
            
            selection.style.left = startX + 'px';
            selection.style.top = startY + 'px';
            selection.style.width = '0px'; 
            selection.style.height = '0px';
            selection.style.display = 'block';
        };

        window.onmousemove = (e) => {
            if(!isDragging) return;
            handleAutoScroll(e);

            const bounds = container.getBoundingClientRect();
            const currentX = e.clientX - bounds.left;
            const currentY = e.clientY - bounds.top;
            
            const w = currentX - startX; 
            const h = currentY - startY;
            
            selection.style.width = Math.abs(w) + 'px';
            selection.style.height = Math.abs(h) + 'px';
            selection.style.left = (w > 0 ? startX : currentX) + 'px';
            selection.style.top = (h > 0 ? startY : currentY) + 'px';
        };

        window.onmouseup = () => {
            if(!isDragging) return;
            isDragging = false;
            clearInterval(scrollInterval);
            
            const rx = parseFloat(selection.style.left) / canvas.width;
            const ry = parseFloat(selection.style.top) / canvas.height;
            const rw = parseFloat(selection.style.width) / canvas.width;
            const rh = parseFloat(selection.style.height) / canvas.height;

            if(rw < 0.005 || rh < 0.005) { 
                selection.style.display = 'none';
                return;
            }

            const num = document.getElementById('q-num').value;
            currentData[num] = {
                p: pageNum,
                rect: [parseFloat(rx.toFixed(4)), parseFloat(ry.toFixed(4)), parseFloat(rw.toFixed(4)), parseFloat(rh.toFixed(4))],
                ans: document.getElementById('q-ans').value || "?",
                score: parseInt(document.getElementById('q-score').value),
                topic: document.getElementById('q-topic').value || "ë¯¸ë¶„ë¥˜"
            };

            document.getElementById('q-num').value = parseInt(num) + 1;
            document.getElementById('q-ans').value = "";
            selection.style.display = 'none';
            updateDataList();
            renderCapturedLayers();
        };

        function updateDataList() {
            const list = document.getElementById('data-list');
            list.innerHTML = '';
            const keys = Object.keys(currentData).sort((a,b)=>Number(a)-Number(b));
            document.getElementById('captured-count').innerText = keys.length;
            keys.forEach(n => {
                const d = currentData[n];
                list.innerHTML += `<div class="bg-slate-800 border border-slate-700 p-3 rounded-xl flex justify-between items-center group hover:bg-slate-700 transition-colors shadow-sm">
                    <div class="flex flex-col">
                        <span class="text-indigo-400 font-black text-sm">Question ${n}</span>
                        <span class="text-[9px] font-bold opacity-50 uppercase tracking-widest">Page ${d.p} Â· ${d.topic}</span>
                    </div>
                    <button onclick="deleteData('${n}')" class="text-slate-500 hover:text-red-400 transition-colors p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
            });
            lucide.createIcons();
        }

        function renderCapturedLayers() {
            const layer = document.getElementById('captured-layers');
            layer.innerHTML = '';
            Object.keys(currentData).forEach(n => {
                const d = currentData[n];
                if(d.p !== pageNum) return;
                const div = document.createElement('div');
                div.className = 'captured-rect';
                div.style.left = (d.rect[0] * canvas.width) + 'px';
                div.style.top = (d.rect[1] * canvas.height) + 'px';
                div.style.width = (d.rect[2] * canvas.width) + 'px';
                div.style.height = (d.rect[3] * canvas.height) + 'px';
                div.innerHTML = `<span class="bg-emerald-500 text-[9px] font-black text-white px-1.5 py-0.5 absolute top-0 left-0 shadow-lg rounded-br-md">Q${n}</span>`;
                layer.appendChild(div);
            });
        }

        window.deleteData = (n) => { 
            if(confirm(`Q${n} ë¬¸í•­ì˜ ì¢Œí‘œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                delete currentData[n]; 
                updateDataList(); 
                renderCapturedLayers(); 
            }
        };

        window.saveToDB = async () => {
            const examId = document.getElementById('target-exam-id').value.trim();
            if(!examId) return alert("ì €ì¥ë  ì‹œí—˜ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 2028_PRETEST)");
            if(Object.keys(currentData).length === 0) return alert("ì¶”ì¶œëœ ë¬¸í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'archive_coords', examId), {
                    examId: examId,
                    coords: currentData,
                    updatedAt: new Date().toISOString()
                });
                alert("ğŸ‰ ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™” ì™„ë£Œ!");
            } catch (e) {
                alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        window.copyCode = () => {
            const code = JSON.stringify(currentData, null, 4);
            const textArea = document.createElement("textarea");
            textArea.value = code;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("JSON ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        lucide.createIcons();
    </script>
</body>
</html>