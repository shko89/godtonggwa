<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°“í†µê³¼ í•™ìƒìš© í€´ì¦ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* ì•± ì»¨í…Œì´ë„ˆ (index.htmlê³¼ ë™ì¼) */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            height: 100vh; /* ê³ ì • ë†’ì´ */
            background-color: #F9FAFB;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ë²„íŠ¼ ì¸í„°ë™ì…˜ */
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="app-container">
        <!-- [1] ìƒë‹¨ ê³ ì • í—¤ë” -->
        <header class="bg-white/90 backdrop-blur-md px-5 py-4 flex justify-between items-center z-50 border-b border-gray-100 shrink-0">
            <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                <!-- ë¡œê³  ë””ìì¸ (index.html í†µì¼) -->
                <div class="w-9 h-9 bg-gray-900 rounded-lg flex items-center justify-center relative overflow-hidden shrink-0 shadow-md">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-900 to-black opacity-80"></div>
                    <svg class="w-5 h-5 relative z-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tight text-gray-900 leading-none">ì˜¤ëŠ˜ì˜ í€´ì¦ˆ</h1>
                    <div class="flex items-center gap-1.5 mt-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-300" id="conn-status"></span>
                        <p class="text-[10px] text-gray-500 font-medium" id="conn-text">ì—°ê²° ëŒ€ê¸°ì¤‘</p>
                    </div>
                </div>
            </div>
            <button onclick="goHome()" class="p-2 bg-gray-50 rounded-full hover:bg-gray-100 text-gray-400">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- [2] ì¤‘ì•™ ìŠ¤í¬ë¡¤ ì˜ì—­ (ë¬¸ì œ í‘œì‹œ) -->
        <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar p-5 relative bg-[#F9FAFB]">
            <!-- Content Injected via JS -->
        </main>

        <!-- [3] í•˜ë‹¨ ê³ ì • ì˜ì—­ (ë„¤ë¹„ê²Œì´ì…˜ or O/Xë²„íŠ¼) -->
        <div id="bottom-bar" class="bg-white border-t border-gray-100 p-4 shrink-0 z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] pb-8">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center hidden">
        <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div>
        <p class="text-xs font-bold text-indigo-600 animate-pulse">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // [ìˆ˜ì •] doc, getDoc ì¶”ê°€ (ë§ˆì´í˜ì´ì§€ ë°ì´í„° ì—°ë™ìš©)
        import { getFirestore, collection, query, where, getDocs, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const V2_APP_ID = "godtonggwa_v1";

        const UNIT_NAMES = [
            { id: 'unit_01', title: '1. ê³¼í•™ì˜ ê¸°ì´ˆ', color: 'from-blue-500 to-indigo-500' },
            { id: 'unit_02', title: '2. ì›ì†Œì˜ í˜•ì„±', color: 'from-indigo-500 to-purple-500' },
            { id: 'unit_03', title: '3. ë¬¼ì§ˆì˜ êµ¬ì¡°', color: 'from-purple-500 to-pink-500' },
            { id: 'unit_04', title: '4. ì§€êµ¬ ì‹œìŠ¤í…œ', color: 'from-emerald-500 to-teal-500' },
            { id: 'unit_05', title: '5. ì—­í•™ì  ì‹œìŠ¤í…œ', color: 'from-teal-500 to-cyan-500' },
            { id: 'unit_06', title: '6. ìƒëª… ì‹œìŠ¤í…œ', color: 'from-rose-500 to-red-500' },
            { id: 'unit_07', title: '7. ì§€ì§ˆê³¼ ìƒë¬¼', color: 'from-orange-500 to-amber-500' },
            { id: 'unit_08', title: '8. í™”í•™ ë³€í™”', color: 'from-amber-500 to-yellow-500' },
            { id: 'unit_09', title: '9. ìƒíƒœê³„ì™€ ê¸°í›„', color: 'from-lime-500 to-green-500' },
            { id: 'unit_10', title: '10. ì—ë„ˆì§€', color: 'from-cyan-500 to-sky-500' },
            { id: 'unit_11', title: '11. ê³¼í•™ê³¼ ë¯¸ë˜', color: 'from-sky-500 to-blue-500' }
        ];

        let state = {
            questions: [],
            currentIdx: 0,
            score: 0,
            wrongAnswers: [],
            mode: 'home', // home, quiz, result, market
            currentUser: null,
            userData: null
        };

        // --- ì´ˆê¸°í™” ë° ì¸ì¦ ---
        async function init() {
            await initAuth();
            renderHome();
            lucide.createIcons();

            onAuthStateChanged(auth, async (user) => {
                const dot = document.getElementById('conn-status');
                const text = document.getElementById('conn-text');
                
                if(user) {
                    state.currentUser = user;
                    dot.classList.replace('bg-gray-300', 'bg-green-500');
                    text.innerText = "ì˜¨ë¼ì¸";
                    text.classList.add('text-green-600');
                    
                    // [ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ë¡œë“œ (ë§ˆì´í˜ì´ì§€ìš©)
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if(userDoc.exists()) {
                            state.userData = userDoc.data();
                        }
                    } catch(e) { console.warn("User data fetch failed", e); }
                    
                } else {
                    state.currentUser = null;
                    state.userData = null;
                    dot.classList.replace('bg-green-500', 'bg-gray-300');
                    text.innerText = "ì—°ê²° ëŠê¹€";
                    text.classList.remove('text-green-600');
                }
            });
        }

        const initAuth = () => {
            return new Promise((resolve) => {
                // Firebaseê°€ ê¸°ì¡´ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë³µêµ¬í–ˆëŠ”ì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    unsubscribe(); // í™•ì¸ì´ ëë‚¬ìœ¼ë¯€ë¡œ ë¦¬ìŠ¤ë„ˆë¥¼ ë°”ë¡œ í•´ì œí•©ë‹ˆë‹¤.

                    if (user) {
                        // 1. ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ìˆë‹¤ë©´? ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  ìœ ì§€í•©ë‹ˆë‹¤.
                        console.log("ê¸°ì¡´ ë¡œê·¸ì¸ ì„¸ì…˜ ìœ ì§€ë¨:", user.uid);
                        resolve(user);
                    } else {
                        // 2. ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ì„ ë•Œë§Œ! ìµëª… ë¡œê·¸ì¸ì„ ì§„í–‰í•©ë‹ˆë‹¤.
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                try { 
                                    await signInWithCustomToken(auth, __initial_auth_token); 
                                } catch (e) { 
                                    console.warn("Token auth failed, fallback to anon");
                                    await signInAnonymously(auth);
                                }
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Auth Error", e);
                            if(e.code === 'auth/admin-restricted-operation') alert("ê´€ë¦¬ì ì„¤ì • ì˜¤ë¥˜: ìµëª… ë¡œê·¸ì¸ì„ í™œì„±í™”í•´ì£¼ì„¸ìš”.");
                        }
                        resolve();
                    }
                });
            });
        };

        // --- ë Œë”ë§ í•¨ìˆ˜ë“¤ ---

        // 1. í™ˆ í™”ë©´ (ë‹¨ì› ì„ íƒ)
        window.renderHome = () => {
            state.mode = 'home';
            const main = document.getElementById('main-content');
            const bottom = document.getElementById('bottom-bar');

            // Main: ë‹¨ì› ëª©ë¡
            main.innerHTML = `
                <div class="fade-in pb-4">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 text-center mb-6">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="zap" class="w-6 h-6"></i>
                        </div>
                        <h2 class="text-xl font-black text-gray-900 mb-2">OX ìŠ¤í”¼ë“œ í€´ì¦ˆ</h2>
                        <p class="text-sm text-gray-500 break-keep leading-relaxed">
                            ì´ë™ ì‹œê°„ì— ê°€ë³ê²Œ í‘¸ëŠ” ìˆ˜ëŠ¥ í•„ìˆ˜ ì•”ê¸°!<br>
                            <span class="text-indigo-600 font-bold">í•˜ë£¨ 5ë¶„</span>, ê³¼í•™ ë“±ê¸‰ì„ ì˜¬ë ¤ë³´ì„¸ìš”.
                        </p>
                    </div>

                    <p class="text-xs font-bold text-gray-400 mb-3 px-1">í•™ìŠµí•  ë‹¨ì› ì„ íƒ</p>
                    <div class="space-y-3">
                        ${UNIT_NAMES.map(unit => `
                            <button onclick="startQuiz('${unit.id}', '${unit.title}')" class="w-full bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:border-indigo-100 hover:shadow-md transition-all flex items-center justify-between group text-left">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${unit.color} flex items-center justify-center text-white shadow-sm shrink-0">
                                        <span class="font-bold text-sm">${unit.id.split('_')[1]}</span>
                                    </div>
                                    <span class="font-bold text-gray-700 text-sm group-hover:text-indigo-600 transition-colors">${unit.title}</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 group-hover:text-indigo-400"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            renderBottomNav('quiz');
        };

        // [ì¶”ê°€] í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë Œë”ë§ í•¨ìˆ˜
        function renderBottomNav(activeTab) {
            const bottom = document.getElementById('bottom-bar');
            
            // íƒ­ ìŠ¤íƒ€ì¼ ê²°ì •
            const getTabClass = (name) => name === activeTab 
                ? "flex flex-col items-center gap-1 text-indigo-600 transition-colors"
                : "flex flex-col items-center gap-1 text-gray-400 hover:text-indigo-600 transition-colors";

            bottom.innerHTML = `
                <div class="flex justify-between items-center max-w-[400px] mx-auto">
                    <button onclick="location.href='../index.html'" class="flex flex-col items-center gap-1 text-gray-400 hover:text-indigo-600 transition-colors">
                        <i data-lucide="home" class="w-6 h-6"></i>
                        <span class="text-[10px] font-bold">í™ˆ</span>
                    </button>
                    <button onclick="renderHome()" class="${getTabClass('quiz')}">
                        <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                        <span class="text-[10px] font-bold">í€´ì¦ˆ</span>
                    </button>
                    <button onclick="location.href='../STEST/exam.html'" class="flex flex-col items-center gap-1 text-gray-400 hover:text-indigo-600 transition-colors">
                        <i data-lucide="file-text" class="w-6 h-6"></i>
                        <span class="text-[10px] font-bold">ëª¨ì˜ê³ ì‚¬</span>
                    </button>
                    <button onclick="renderMarket()" class="${getTabClass('market')}">
                        <i data-lucide="user" class="w-6 h-6"></i>
                        <span class="text-[10px] font-bold">ë§ˆì´</span>
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        // [ì¶”ê°€] ë§ˆì´ í˜ì´ì§€ ë Œë”ë§ (index.html ì°¸ê³ )
        window.renderMarket = () => {
            state.mode = 'market';
            const main = document.getElementById('main-content');
            
            const userName = state.userData ? state.userData.name : 'ë¹„íšŒì› (Guest)';
            const userPlan = state.userData && state.userData.isPaid ? 'í”„ë¦¬ë¯¸ì—„' : 'ë¬´ë£Œ íšŒì›';
            const loginBtn = state.currentUser && !state.currentUser.isAnonymous 
                ? `<button onclick="handleLogout()" class="text-xs text-gray-500 underline ml-auto">ë¡œê·¸ì•„ì›ƒ</button>` 
                : `<span class="text-xs text-gray-400 ml-auto">ìë™ ë¡œê·¸ì¸ ìƒíƒœ</span>`;

            main.innerHTML = `
                <div class="fade-in space-y-4 pt-4">
                    <h2 class="text-xl font-bold text-gray-800 flex justify-between items-center px-1">ë§ˆì´í˜ì´ì§€ ${loginBtn}</h2>
                    
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 flex items-center gap-4 shadow-sm">
                        <div class="w-14 h-14 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 border border-gray-100">
                            <i data-lucide="user" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-gray-900">${userName}</p>
                            <p class="text-xs text-indigo-500 font-bold bg-indigo-50 px-2 py-0.5 rounded inline-block mt-1">${userPlan}</p>
                        </div>
                    </div>

                    <div class="space-y-3 mt-6">
                         <div onclick="alert('ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-50 p-2 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4 text-blue-500"></i></div>
                                <span class="text-sm font-medium text-gray-700">ë‚´ ì •ë³´ ìˆ˜ì •</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                        </div>
                         <div onclick="alert('ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”')" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="bg-purple-50 p-2 rounded-lg"><i data-lucide="credit-card" class="w-4 h-4 text-purple-500"></i></div>
                                <span class="text-sm font-medium text-gray-700">ì´ìš©ê¶Œ ê´€ë¦¬</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl mt-6 text-center">
                        <p class="text-xs text-gray-400">ì•± ë²„ì „ v1.0.2</p>
                    </div>
                </div>
            `;
            
            renderBottomNav('market');
            lucide.createIcons();
        };

        window.handleLogout = async () => {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await signOut(auth);
                window.location.reload();
            }
        };

        // 2. í€´ì¦ˆ ì§„í–‰ (ë¬¸ì œ í‘œì‹œ)
        window.startQuiz = async (unitId, unitTitle) => {
            showLoading(true);
            try {
                const colRef = collection(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems');
                const q = query(colRef, where('unitId', '==', unitId));
                const snapshot = await getDocs(q);

                if(snapshot.empty) {
                    alert("ì´ ë‹¨ì›ì—ëŠ” ì•„ì§ ë¬¸ì œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    showLoading(false);
                    return;
                }

                state.questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort(() => Math.random() - 0.5);
                state.currentIdx = 0;
                state.score = 0;
                state.wrongAnswers = [];
                state.mode = 'quiz';

                renderQuestion();

            } catch(e) {
                console.error(e);
                alert("ë¬¸ì œ ë¡œë”© ì‹¤íŒ¨");
            } finally {
                showLoading(false);
            }
        };

        function renderQuestion() {
            const q = state.questions[state.currentIdx];
            const main = document.getElementById('main-content');
            const bottom = document.getElementById('bottom-bar');

            // Main: ë¬¸ì œ ì¹´ë“œ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
            main.innerHTML = `
                <div class="fade-in min-h-full flex flex-col justify-center">
                    <!-- ì§„í–‰ë¥  -->
                    <div class="flex items-center gap-2 mb-6 px-2">
                        <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-500 transition-all duration-300" style="width: ${((state.currentIdx) / state.questions.length) * 100}%"></div>
                        </div>
                        <span class="text-xs font-bold text-gray-500 font-mono">${state.currentIdx + 1}/${state.questions.length}</span>
                    </div>

                    <!-- ë¬¸ì œ ì¹´ë“œ -->
                    <div id="quiz-card" class="bg-white rounded-[2rem] p-8 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.1)] border border-gray-100 text-center relative overflow-hidden transition-all duration-300">
                        <div class="absolute -top-6 -left-6 w-24 h-24 bg-indigo-50 rounded-full"></div>
                        <span class="relative z-10 text-indigo-600 font-black text-6xl opacity-10 block mb-4 font-serif">Q.</span>
                        <p class="relative z-10 text-xl font-bold text-gray-800 leading-relaxed break-keep min-h-[120px] flex items-center justify-center">
                            ${q.q}
                        </p>
                    </div>

                    <!-- í•´ì„¤ ë°•ìŠ¤ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
                    <div id="exp-box" class="hidden mt-6 bg-gray-900 text-white p-5 rounded-2xl shadow-lg slide-up">
                        <div class="flex items-start gap-3">
                            <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-400 shrink-0 mt-0.5"></i>
                            <div>
                                <p id="result-msg" class="font-bold text-lg mb-1"></p>
                                <p class="text-sm text-gray-300 leading-relaxed">${q.exp || 'í•´ì„¤ ì—†ìŒ'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Bottom: O/X ë²„íŠ¼ (ê³ ì •)
            bottom.innerHTML = `
                <div id="ox-container" class="grid grid-cols-2 gap-3 h-full">
                    <button onclick="submitAnswer('O')" class="btn-press bg-white border-2 border-indigo-100 hover:border-indigo-500 hover:bg-indigo-50 rounded-2xl h-16 flex items-center justify-center gap-2 transition-all group shadow-sm">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                            <span class="text-lg font-black">O</span>
                        </div>
                        <span class="font-bold text-gray-600 group-hover:text-indigo-700">ê·¸ë ‡ë‹¤</span>
                    </button>
                    <button onclick="submitAnswer('X')" class="btn-press bg-white border-2 border-red-100 hover:border-red-500 hover:bg-red-50 rounded-2xl h-16 flex items-center justify-center gap-2 transition-all group shadow-sm">
                        <div class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-colors">
                            <span class="text-lg font-black">X</span>
                        </div>
                        <span class="font-bold text-gray-600 group-hover:text-red-700">ì•„ë‹ˆë‹¤</span>
                    </button>
                </div>
                <button id="next-btn" onclick="nextQuestion()" class="hidden w-full bg-gray-900 text-white font-bold h-16 rounded-2xl shadow-lg hover:bg-black transition-colors flex items-center justify-center gap-2">
                    ë‹¤ìŒ ë¬¸ì œ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            `;
            lucide.createIcons();
        }

        window.submitAnswer = (ans) => {
            const q = state.questions[state.currentIdx];
            const isCorrect = ans === q.a;
            
            // 1. ë²„íŠ¼ ìˆ¨ê¸°ê³  ë‹¤ìŒ ë²„íŠ¼ ì¤€ë¹„
            document.getElementById('ox-container').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');

            // 2. ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³€ê²½
            const card = document.getElementById('quiz-card');
            card.classList.remove('border-gray-100');
            
            if(isCorrect) {
                state.score++;
                card.classList.add('border-green-500', 'bg-green-50');
                document.getElementById('result-msg').innerHTML = `<span class="text-green-400">ì •ë‹µì…ë‹ˆë‹¤!</span>`;
            } else {
                state.wrongAnswers.push({ ...q, myAns: ans });
                card.classList.add('border-red-500', 'bg-red-50');
                document.getElementById('result-msg').innerHTML = `<span class="text-red-400">ì˜¤ë‹µì…ë‹ˆë‹¤.</span> <span class="text-xs text-gray-400">(ì •ë‹µ: ${q.a})</span>`;
            }

            // 3. í•´ì„¤ í‘œì‹œ
            document.getElementById('exp-box').classList.remove('hidden');
        };

        window.nextQuestion = () => {
            state.currentIdx++;
            if(state.currentIdx >= state.questions.length) finishQuiz();
            else renderQuestion();
        };

        // 3. ê²°ê³¼ í™”ë©´
        function finishQuiz() {
            state.mode = 'result';
            const main = document.getElementById('main-content');
            const bottom = document.getElementById('bottom-bar');

            // ì ìˆ˜ì— ë”°ë¥¸ ë©”ì‹œì§€
            const percentage = (state.score / state.questions.length) * 100;
            let msg = "ë…¸ë ¥ì´ í•„ìš”í•´ìš”!";
            if(percentage === 100) msg = "ì™„ë²½í•©ë‹ˆë‹¤! ê°“í†µê³¼!";
            else if(percentage >= 80) msg = "í›Œë¥­í•´ìš”! ì¡°ê¸ˆë§Œ ë”!";
            else if(percentage >= 50) msg = "ì˜í–ˆì–´ìš”! ë³µìŠµí•´ë³¼ê¹Œìš”?";

            // ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const reviewHtml = state.wrongAnswers.length > 0 
                ? state.wrongAnswers.map(item => `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm mb-3">
                        <div class="flex gap-2 mb-2">
                            <span class="bg-red-100 text-red-600 text-[10px] font-bold px-1.5 py-0.5 rounded">ì˜¤ë‹µ</span>
                            <p class="text-sm font-bold text-gray-800">${item.q}</p>
                        </div>
                        <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg leading-relaxed">
                            <span class="font-bold text-indigo-600 mr-1">í•´ì„¤</span> ${item.exp}
                        </div>
                    </div>`).join('') 
                : `<div class="text-center py-8 text-gray-400 text-sm">í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì™„ë²½í•´ìš”! ğŸ‰</div>`;

            main.innerHTML = `
                <div class="fade-in text-center pt-4">
                    <div class="inline-block relative mb-6">
                        <div class="w-24 h-24 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg shadow-indigo-200">
                            <i data-lucide="trophy" class="w-10 h-10 text-white"></i>
                        </div>
                        <div class="absolute -bottom-2 -right-2 bg-white text-indigo-600 font-black text-lg px-3 py-1 rounded-full shadow border border-gray-100">
                            ${state.score}ì 
                        </div>
                    </div>
                    
                    <h2 class="text-2xl font-black text-gray-900 mb-1">${msg}</h2>
                    <p class="text-sm text-gray-500 mb-8">ì´ ${state.questions.length}ë¬¸ì œ ì¤‘ ${state.score}ê°œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤.</p>

                    <div class="text-left">
                        <h3 class="text-sm font-bold text-gray-900 mb-3 px-1 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4 text-indigo-500"></i> ì˜¤ë‹µ ë…¸íŠ¸
                        </h3>
                        <div class="pb-10">${reviewHtml}</div>
                    </div>
                </div>
            `;

            // Bottom: ì¬ì‹œì‘ ë²„íŠ¼
            bottom.innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="goHome()" class="col-span-1 bg-white border border-gray-200 text-gray-600 font-bold h-14 rounded-xl hover:bg-gray-50">
                        ëª©ë¡ìœ¼ë¡œ
                    </button>
                    <button onclick="renderQuestion()" class="col-span-2 bg-indigo-600 text-white font-bold h-14 rounded-xl shadow-lg hover:bg-indigo-700 shadow-indigo-200">
                        ë‹¤ì‹œ í’€ê¸°
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        window.goHome = () => renderHome();
        window.location.hrefLink = (url) => window.location.href = url;

        function showLoading(show) {
            const el = document.getElementById('loading-overlay');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        init();
    </script>
</body>
</html>