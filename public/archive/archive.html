<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ê°“í†µê³¼ - ê¸°ì¶œ í•´ì„¤ ì•„ì¹´ì´ë¸Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Nanum+Pen+Script&family=Gaegu:wght@400;700&display=swap');
        
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #F3F4F6; overflow-x: hidden; }
        
        .app-container { 
            max-width: 480px; 
            margin: 0 auto; 
            min-height: 100vh; 
            background-color: #FFFFFF; 
            position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column;
            transition: max-width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .app-container.wide-mode { max-width: 1024px; }
        
        .notebook-paper {
            background-color: #fffef0;
            background-image: linear-gradient(to bottom, transparent 29px, #a8d5e5 30px);
            background-size: 100% 30px;
            line-height: 30px;
            position: relative;
        }
        .notebook-paper::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 40px;
            width: 2px;
            background-color: #ff9999;
            opacity: 0.4;
        }
        .handwriting {
            font-family: 'Nanum Pen Script', cursive;
            font-size: 1.7rem;
            color: #1e293b;
            padding-left: 50px;
            padding-right: 20px;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .num-btn { aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; border-radius: 18px; font-weight: 800; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid #F1F5F9; background-color: #F8FAFC; color: #64748B; font-size: 1.1rem; }
        .num-btn:active { transform: scale(0.9); background-color: #EEF2FF; color: #4F46E5; }
        .num-btn.active { background-color: #4F46E5; color: white; border-color: #4F46E5; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        
        .question-canvas { width: 100%; height: auto; display: block; border-radius: 12px; image-rendering: -webkit-optimize-contrast; cursor: zoom-in; }
        .premium-banner { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 50%, #EC4899 100%); }
        
        #zoom-modal { display: none; position: fixed; inset: 0; z-index: 2000; background: #000; flex-direction: column; overflow: hidden; touch-action: none; }
        .zoom-header { padding: 16px; display: flex; justify-content: space-between; items-center: center; color: white; background: rgba(0,0,0,0.7); z-index: 10; }
        .zoom-content { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #zoom-canvas-container { position: absolute; transform-origin: center center; will-change: transform; display: flex; align-items: center; justify-content: center; }
        #zoom-canvas { background: white; border-radius: 4px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: block; max-width: none; }
        .zoom-footer { padding: 24px; display: flex; justify-content: center; gap: 16px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); z-index: 10; padding-bottom: 40px; }

        /* ì „ì²´ í™”ë©´ í™•ëŒ€ ìµœì í™” */
        #solve-zoom-wrapper { 
            transform-origin: top center; 
            transition: transform 0.05s linear;
            will-change: transform; 
            touch-action: pan-y; 
        }
        #solve-zoom-wrapper.zoomed {
            touch-action: none;
        }
        .zoom-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(79, 70, 229, 0.9);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 800;
            z-index: 100;
            pointer-events: none;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .highlight-yellow { background-color: #fef08a; padding: 2px 4px; border-radius: 4px; font-weight: bold; color: #854d0e; }
        .highlight-blue { background: linear-gradient(120deg, transparent 0%, rgba(225, 245, 254, 1) 20%, rgba(225, 245, 254, 1) 80%, transparent 100%); padding: 0 2px; }
        .red-pen { color: #ef4444; text-decoration: underline; font-weight: bold; }
        
        /* [ì¶”ê°€] ì •ë‹µ ë° í•´ì„¤ ê°€ë¦¬ê¸° ìŠ¤íƒ€ì¼ */
        .ans-blurred { filter: blur(8px); opacity: 0.5; transition: all 0.3s; }
        .ans-revealed { filter: blur(0); opacity: 1; }
        .btn-exp-view { 
            background: #4F46E5; 
            color: white; 
            padding: 12px 24px; 
            border-radius: 50px; 
            font-weight: 900; 
            font-size: 1.1rem;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-exp-view:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="app-container" id="main-app-container">
        <!-- ìƒë‹¨ í—¤ë” -->
        <header id="app-header" class="hidden bg-white/95 backdrop-blur-md px-5 py-4 flex items-center sticky top-0 z-50 border-b border-gray-100">
            <button onclick="handleBack()" class="mr-3 p-1.5 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i></button>
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-100"><i data-lucide="scroll-text" class="w-4.5 h-4.5 text-white"></i></div>
                <h1 class="text-lg font-black text-gray-900 tracking-tight" id="header-title">ê¸°ì¶œ í•´ì„¤ ì•„ì¹´ì´ë¸Œ</h1>
            </div>
            <button id="solve-zoom-reset" onclick="resetStageZoom()" class="ml-auto hidden bg-indigo-600 text-white px-3 py-1.5 rounded-full text-[10px] font-black border border-indigo-700 shadow-lg animate-pulse">ì¤Œ ë¦¬ì…‹</button>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar overflow-x-hidden">
            
            <!-- [View 1] ì‹œí—˜ì§€ ëª©ë¡ í™”ë©´ -->
            <div id="view-exam-list" class="fade-in p-5 space-y-7">
                <div class="premium-banner rounded-[32px] p-8 text-white shadow-2xl relative overflow-hidden mt-2">
                    <div class="absolute top-0 right-0 w-40 h-40 bg-white opacity-10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                    <div class="relative z-10 text-left">
                        <div class="flex items-center gap-3 mb-4">
                             <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-md border border-white/20"><i data-lucide="scroll-text" class="w-4.5 h-4.5 text-white"></i></div>
                             <h2 class="text-2xl font-black tracking-tight text-white leading-tight">ê¸°ì¶œ í•´ì„¤ ì•„ì¹´ì´ë¸Œ</h2>
                        </div>
                        <p class="text-indigo-50 text-[13px] font-medium leading-relaxed opacity-90">ë²„ìŠ¤ë‚˜ ì§€í•˜ì²  ì´ë™ ì‹œê°„, ìíˆ¬ë¦¬ ì‹œê°„ì„ í™œìš©í•´ <br>ê¸°ì¶œ ë¬¸ì œë¥¼ í•œ ë¬¸í•­ì”© ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í•˜ì„¸ìš”!</p>
                        <div class="mt-8 flex items-center gap-2 text-[11px] font-black bg-white text-indigo-700 w-fit px-4 py-2.5 rounded-full shadow-xl">
                            <i data-lucide="sparkles" class="w-4 h-4 text-amber-500 fill-amber-500"></i> <span>2028 í†µí•©ê³¼í•™ ì˜ˆë¹„ë¬¸í•­ ì™„ë²½ í•´ì„¤</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-black text-gray-900 flex items-center gap-2 text-lg px-1"><i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i>í•™ë…„ë„ë³„ ê¸°ì¶œ ë¶„ì„</h3>
                    <div id="exam-list-container" class="grid grid-cols-1 gap-4 pb-20"></div>
                </div>
            </div>

            <!-- [View 2] ë¬¸í•­ ì„ íƒ ê·¸ë¦¬ë“œ -->
            <div id="view-num-grid" class="hidden fade-in p-6">
                <div class="bg-indigo-50/50 rounded-[32px] p-7 border border-indigo-100/50 mb-7 shadow-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-indigo-600 text-white text-[9px] font-black px-2 py-0.5 rounded-md uppercase tracking-wider">Exam Board</span>
                        <h3 id="grid-title" class="text-xl font-black text-gray-900 tracking-tight leading-tight">-</h3>
                    </div>
                    <p class="text-[13px] text-gray-500 font-medium">í•™ìŠµì„ ì›í•˜ëŠ” ë¬¸í•­ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                </div>
                <div id="num-grid" class="grid grid-cols-5 gap-4 pb-24"></div>
            </div>

            <!-- [View 3] ìƒì„¸ í’€ì´ í™”ë©´ -->
            <div id="view-solve" class="hidden fade-in px-4 pt-4 pb-32">
                <div id="solve-zoom-wrapper">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="w-full lg:w-1/2 space-y-4">
                            <div class="bg-white rounded-[32px] shadow-xl border border-gray-100 p-4 overflow-hidden relative">
                                <div class="flex justify-between items-center px-3 py-3 border-b border-gray-50 mb-4">
                                    <div class="flex items-center gap-2">
                                        <span id="solve-q-label" class="text-indigo-600 font-black text-xl tracking-tighter">Q 01</span>
                                        <span class="text-gray-200 font-thin text-xl">|</span>
                                        <span id="solve-q-score" class="text-amber-500 text-xs font-black uppercase">2.0 Points</span>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="openZoom()" class="p-2 hover:bg-indigo-50 rounded-full text-indigo-600 transition-colors"><i data-lucide="maximize-2" class="w-5 h-5"></i></button>
                                        <button onclick="showStep(2)" class="p-2 hover:bg-gray-50 rounded-full text-gray-400 transition-colors"><i data-lucide="grid" class="w-5 h-5"></i></button>
                                    </div>
                                </div>
                                <div id="canvas-wrapper" class="flex items-center justify-center relative group cursor-zoom-in" onclick="openZoom()">
                                    <canvas id="q-canvas" class="question-canvas"></canvas>
                                </div>
                            </div>

                            <!-- [ìˆ˜ì •] ì •ë‹µ ì˜ì—­: ë¸”ëŸ¬ ì²˜ë¦¬ ë° í´ë¦­ ì¸í„°ë™ì…˜ -->
                            <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex items-center justify-between cursor-pointer group" onclick="revealCorrectAns()">
                                <div class="text-left pl-2">
                                    <h4 class="text-emerald-700 font-black text-[9px] uppercase tracking-widest">Answer</h4>
                                    <div id="ans-mask" class="flex items-center gap-2 py-1">
                                        <p id="correct-ans" class="text-3xl font-black text-emerald-600 ans-blurred">â‘¢</p>
                                        <span id="ans-click-tip" class="text-[10px] text-emerald-400 font-bold bg-emerald-100/50 px-2 py-0.5 rounded animate-pulse">íƒ­í•˜ì—¬ ì •ë‹µ í™•ì¸</span>
                                    </div>
                                </div>
                                <div class="text-right pr-2">
                                    <span id="solve-q-topic" class="text-emerald-600 text-[10px] font-bold bg-white px-3 py-1.5 rounded-full border border-emerald-100 shadow-sm block mb-1">ë‹¨ì› ì •ë³´</span>
                                </div>
                            </div>
                        </div>

                        <div class="w-full lg:w-1/2">
                            <!-- [ìˆ˜ì •] ë¹„ë°€ë…¸íŠ¸ ì˜ì—­: í•´ì„¤ ê°€ë¦¬ê¸° ë²„íŠ¼ ë° ì¸í„°ë™ì…˜ -->
                            <div class="h-full min-h-[600px] rounded-3xl shadow-2xl overflow-hidden flex flex-col border border-l-8 border-gray-300 notebook-paper fade-in">
                                <div class="min-h-[4rem] border-b-2 border-gray-300 flex items-center px-6 py-4 ml-8 bg-indigo-50/30">
                                    <i data-lucide="pen-tool" class="w-5 h-5 text-indigo-600 mr-2"></i>
                                    <span id="note-topic-text" class="text-xl font-bold text-gray-700 handwriting" style="padding:0;">ë¹„ë°€ë…¸íŠ¸ ë¡œë”© ì¤‘...</span>
                                </div>
                                <div class="flex-1 p-6 ml-2 relative text-left">
                                    <!-- í•´ì„¤ ë³´ê¸° ë²„íŠ¼ ì˜¤ë²„ë ˆì´ -->
                                    <div id="exp-lock-overlay" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/10 backdrop-blur-[2px]">
                                        <button onclick="revealExplanation()" class="btn-exp-view flex items-center gap-2">
                                            <i data-lucide="eye" class="w-5 h-5"></i>
                                            <span>í•´ì„¤ ë³´ê¸°</span>
                                        </button>
                                        <p class="mt-4 text-[13px] font-bold text-gray-500">ë¬¸ì œë¥¼ ì¶©ë¶„íˆ ê³ ë¯¼í•œ í›„ í™•ì¸í•˜ì„¸ìš”!</p>
                                    </div>
                                    <!-- í•´ì„¤ ë³¸ë¬¸ (ì´ˆê¸° hidden) -->
                                    <div id="exp-text-main" class="handwriting leading-[30px] pt-2 pb-16 text-left opacity-0 transition-opacity duration-500">í•´ì„¤ì„ ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                                    
                                    <div class="absolute bottom-10 right-6 transform rotate-[-10deg] opacity-60">
                                        <span class="bg-rose-100 text-rose-600 px-4 py-1.5 text-xl font-black shadow-lg border-2 border-rose-300 rounded-sm">Very Good! ğŸ‘</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-10"></div>
            </div>
        </main>

        <nav id="bottom-nav" class="bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center fixed bottom-0 w-full max-w-[480px] z-50 pb-6 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
            <button onclick="location.href='../index.html'" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="home" class="w-6 h-6"></i><span class="text-[10px] font-bold">í™ˆ</span></button>
            <button onclick="location.href='../STEST/exam.html'" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="file-text" class="w-6 h-6"></i><span class="text-[10px] font-bold">ì‹œí—˜ì‘ì‹œ</span></button>
            <button onclick="location.href='../Q-Bank/student_quiz.html'" class="nav-btn flex flex-col items-center gap-1 -mt-8 group"><div class="bg-gray-900 p-4 rounded-full shadow-lg border-4 border-white"><i data-lucide="brain-circuit" class="w-7 h-7 text-white"></i></div><span class="text-[10px] font-bold text-gray-600 mt-1">ë¬¸ì œì€í–‰</span></button>
            <button onclick="location.href='../STEST/exam.html?view=report'" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="bar-chart-2" class="w-6 h-6"></i><span class="text-[10px] font-bold">ì„±ì ë¶„ì„</span></button>
            <button onclick="location.href='../index.html?view=market'" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px] font-bold">ë§ˆì´</span></button>
        </nav>
    </div>

    <!-- UHD í™•ëŒ€ ëª¨ë‹¬ ë“± ê¸°íƒ€ ìš”ì†Œ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼) -->
    <div id="solve-zoom-info" class="zoom-indicator">ZOOM x1.0</div>
    <div id="zoom-modal">
        <div class="zoom-header">
            <div class="flex items-center gap-2"><span class="bg-indigo-600 p-1 rounded shadow-lg shadow-indigo-500/20"><i data-lucide="search" class="w-4 h-4 text-white"></i></span><div class="flex flex-col"><span class="text-[9px] font-black uppercase text-indigo-400 leading-none tracking-widest">UHD Display</span><span class="text-[11px] font-bold text-white mt-1" id="zoom-status">100%</span></div></div>
            <button onclick="closeZoom()" class="p-1.5 bg-white/10 hover:bg-white/20 rounded-full transition-colors active:scale-90"><i data-lucide="x" class="w-6 h-6 text-white"></i></button>
        </div>
        <div class="zoom-content" id="zoom-viewport"><div id="zoom-canvas-container"><canvas id="zoom-canvas"></canvas></div></div>
        <div class="zoom-footer">
            <button onclick="adjustZoomBtn(-0.2)" class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center text-white active:scale-90 border border-white/5"><i data-lucide="minus" class="w-6 h-6"></i></button>
            <button onclick="resetZoomToFit()" class="px-8 h-14 bg-indigo-600 hover:bg-indigo-500 rounded-full text-white text-xs font-black active:scale-95 transition-all shadow-xl">RESET FIT</button>
            <button onclick="adjustZoomBtn(0.2)" class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center text-white active:scale-90 border border-white/5"><i data-lucide="plus" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-white/95 z-[100] flex flex-col items-center justify-center text-indigo-600 backdrop-blur-sm">
        <div class="w-14 h-14 border-[5px] border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
        <p class="font-black text-sm text-gray-900 tracking-tight">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs", authDomain: "godtonggwa.firebaseapp.com", projectId: "godtonggwa", storageBucket: "godtonggwa.firebasestorage.app", messagingSenderId: "1087434066468", appId: "1:1087434066468:web:00a75c9329543afc76e6b1" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        const appId = 'godtonggwa_v1';

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const RENDERING_QUALITY = 3.5;
        const EXAM_META = { "2028_pretest": { title: "2028 í†µí•©ê³¼í•™ ì˜ˆë¹„ë¬¸í•­", pdfFile: "2028_pretest.pdf" }, "2024_11": { title: "2024í•™ë…„ë„ ìˆ˜ëŠ¥ ê¸°ì¶œ", pdfFile: "2024_11.pdf" } };

        let currentExamId = null, currentQNum = 0, pdfDoc = null, examCoords = {}, currentStep = 1, aiExamData = null; 
        let scale = 1, fitScale = 1, translateX = 0, translateY = 0, lastX = 0, lastY = 0, initialDist = 0;
        let stageScale = 1, stageX = 0, stageY = 0, stageLastX = 0, stageLastY = 0, stageInitialDist = 0;
        
        const stageWrapper = document.getElementById('solve-zoom-wrapper');
        const mainContent = document.getElementById('main-content');
        const zoomInfo = document.getElementById('solve-zoom-info');
        const zoomResetBtn = document.getElementById('solve-zoom-reset');

        signInAnonymously(auth).then(() => renderExamList());

        function loadExamDataScript(examId) {
            return new Promise((resolve) => {
                const fileName = `${examId}.js?v=${new Date().getTime()}`; 
                const script = document.createElement('script'); script.src = fileName;
                script.onload = () => resolve(window.globalExamData || null); script.onerror = () => resolve(null);
                document.head.appendChild(script);
            });
        }

        function renderExamList() {
            const container = document.getElementById('exam-list-container'); container.innerHTML = '';
            Object.keys(EXAM_META).forEach(id => {
                const exam = EXAM_META[id];
                const btn = document.createElement('button');
                btn.className = "bg-white border border-gray-100 p-6 rounded-[28px] text-left hover:border-indigo-400 shadow-sm active:scale-[0.97] group mb-2 w-full transition-all";
                btn.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="text-[10px] font-black text-indigo-500 tracking-widest uppercase opacity-60">High Performance</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i></div><h4 class="font-black text-gray-900 text-xl tracking-tight leading-tight">${exam.title}</h4>`;
                btn.onclick = () => selectExam(id); container.appendChild(btn);
            });
            lucide.createIcons();
        }

        window.selectExam = async (id) => {
            document.getElementById('loading').classList.remove('hidden');
            currentExamId = id;
            try {
                const [docSnap, loadedAiData] = await Promise.all([getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'archive_coords', id)), loadExamDataScript(id)]);
                if (!docSnap.exists()) throw new Error("ì¢Œí‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                examCoords = docSnap.data().coords; aiExamData = loadedAiData;
                pdfDoc = await pdfjsLib.getDocument(EXAM_META[id].pdfFile).promise;
                initNumGrid(Object.keys(examCoords).length); showStep(2);
            } catch(e) { alert(e.message); } finally { document.getElementById('loading').classList.add('hidden'); }
        };

        function initNumGrid(count) {
            const container = document.getElementById('num-grid'); container.innerHTML = '';
            for(let i=1; i<=count; i++) {
                const btn = document.createElement('button'); btn.className = "num-btn shadow-sm"; btn.innerText = i;
                btn.onclick = () => loadQuestion(i); container.appendChild(btn);
            }
        }

        window.loadQuestion = async (num) => {
            currentQNum = num; const qData = examCoords[num];
            const aiQ = aiExamData?.explanations ? aiExamData.explanations.find(e => e.no === num) : null;
            const dbTopic = qData.topic || "í†µí•©ê³¼í•™";
            
            // ìƒíƒœ ì´ˆê¸°í™” (ì •ë‹µ ë° í•´ì„¤ ê°€ë¦¬ê¸°)
            document.getElementById('correct-ans').classList.add('ans-blurred');
            document.getElementById('ans-click-tip').classList.remove('hidden');
            document.getElementById('exp-lock-overlay').classList.remove('hidden');
            document.getElementById('exp-text-main').classList.add('opacity-0');

            document.getElementById('solve-q-label').innerText = `Q ${String(num).padStart(2, '0')}`;
            document.getElementById('solve-q-score').innerText = `${qData.score || 2.0} Points`;
            document.getElementById('solve-q-topic').innerText = dbTopic;
            document.getElementById('correct-ans').innerText = qData.ans || "?";
            document.getElementById('note-topic-text').innerText = `Q${num}. ${dbTopic}`;
            document.getElementById('exp-text-main').innerHTML = aiQ?.content || "í•´ì„¤ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.";
            
            await renderQuestionCrop(qData); showStep(3); lucide.createIcons();
        };

        // [ì¶”ê°€] ì •ë‹µ ë° í•´ì„¤ ê³µê°œ í•¨ìˆ˜
        window.revealCorrectAns = () => {
            document.getElementById('correct-ans').classList.remove('ans-blurred');
            document.getElementById('ans-click-tip').classList.add('hidden');
        };

        window.revealExplanation = () => {
            document.getElementById('exp-lock-overlay').classList.add('hidden');
            document.getElementById('exp-text-main').classList.remove('opacity-0');
        };

        async function renderQuestionCrop(qData) {
            const canvas = document.getElementById('q-canvas'), ctx = canvas.getContext('2d');
            const page = await pdfDoc.getPage(qData.p);
            const dpr = window.devicePixelRatio || 1;
            const vp = page.getViewport({ scale: RENDERING_QUALITY * dpr });
            const temp = document.createElement('canvas'); temp.width = vp.width; temp.height = vp.height;
            await page.render({ canvasContext: temp.getContext('2d'), viewport: vp }).promise;
            const [rx, ry, rw, rh] = qData.rect;
            canvas.width = rw * vp.width; canvas.height = rh * vp.height;
            ctx.drawImage(temp, rx * vp.width, ry * vp.height, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
        }

        function updateStageTransform() {
            window.requestAnimationFrame(() => {
                stageWrapper.style.transform = `translate(${stageX}px, ${stageY}px) scale(${stageScale})`;
                if (stageScale > 1.02) {
                    zoomInfo.style.display = 'block'; zoomInfo.innerText = `ZOOM x${stageScale.toFixed(1)}`;
                    zoomResetBtn.classList.remove('hidden');
                    stageWrapper.classList.add('zoomed');
                } else {
                    zoomInfo.style.display = 'none'; zoomResetBtn.classList.add('hidden');
                    stageWrapper.classList.remove('zoomed');
                }
            });
        }

        window.resetStageZoom = () => {
            stageScale = 1; stageX = 0; stageY = 0;
            updateStageTransform();
        };

        mainContent.addEventListener('touchstart', (e) => {
            if (currentStep !== 3) return;
            if (e.touches.length === 1) {
                stageLastX = e.touches[0].clientX; stageLastY = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                stageInitialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            }
        }, { passive: true });

        mainContent.addEventListener('touchmove', (e) => {
            if (currentStep !== 3) return;
            if (e.touches.length === 2) {
                if (e.cancelable) e.preventDefault();
                const currentDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                if (stageInitialDist > 0) {
                    const factor = currentDist / stageInitialDist;
                    stageScale = Math.max(1, Math.min(4, stageScale * factor));
                }
                stageInitialDist = currentDist;
                updateStageTransform();
            } else if (stageScale > 1.02 && e.touches.length === 1) {
                if (e.cancelable) e.preventDefault();
                stageX += (e.touches[0].clientX - stageLastX);
                stageY += (e.touches[0].clientY - stageLastY);
                stageLastX = e.touches[0].clientX;
                stageLastY = e.touches[0].clientY;
                updateStageTransform();
            }
        }, { passive: false });

        const zViewport = document.getElementById('zoom-viewport'), zContainer = document.getElementById('zoom-canvas-container'), zCanvas = document.getElementById('zoom-canvas');
        window.openZoom = () => {
            const src = document.getElementById('q-canvas'); document.getElementById('zoom-modal').style.display = 'flex';
            zCanvas.width = src.width; zCanvas.height = src.height; zCanvas.getContext('2d').drawImage(src, 0, 0);
            const dpr = window.devicePixelRatio || 1; const logicalW = zCanvas.width / (dpr * RENDERING_QUALITY);
            zCanvas.style.width = logicalW + 'px'; zCanvas.style.height = (zCanvas.height / (dpr * RENDERING_QUALITY)) + 'px';
            fitScale = (zViewport.clientWidth * 0.94) / logicalW; scale = window.innerWidth > 480 ? fitScale * 0.4 : fitScale;
            translateX = 0; translateY = 0; updateZ(); lucide.createIcons();
        };
        window.closeZoom = () => { document.getElementById('zoom-modal').style.display = 'none'; scale = 1; translateX = 0; translateY = 0; };
        window.adjustZoomBtn = (delta) => { scale = Math.max(0.1, Math.min(8, scale + delta)); updateZ(); };
        window.resetZoomToFit = () => { scale = window.innerWidth > 480 ? fitScale * 0.4 : fitScale; translateX = 0; translateY = 0; updateZ(); };
        function updateZ() { zContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`; document.getElementById('zoom-status').innerText = `View: ${Math.round((scale/fitScale)*100)}%`; }

        zViewport.addEventListener('touchstart', e => {
            if (e.touches.length === 1) { lastX = e.touches[0].clientX; lastY = e.touches[0].clientY; } 
            else if (e.touches.length === 2) initialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        }, { passive: false });
        zViewport.addEventListener('touchmove', e => {
            if (document.getElementById('zoom-modal').style.display !== 'flex') return; e.preventDefault();
            if (e.touches.length === 1) { translateX += (e.touches[0].clientX - lastX); translateY += (e.touches[0].clientY - lastY); lastX = e.touches[0].clientX; lastY = e.touches[0].clientY; } 
            else if (e.touches.length === 2) {
                const currentDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                if (initialDist > 0) scale = Math.max(0.1, Math.min(8, scale * (currentDist / initialDist)));
                initialDist = currentDist;
            }
            updateZ();
        }, { passive: false });

        window.handleBack = () => { if(currentStep === 3) showStep(2); else if(currentStep === 2) showStep(1); };
        window.showStep = (step) => {
            resetStageZoom(); currentStep = step; 
            const container = document.getElementById('main-app-container');
            const header = document.getElementById('app-header');
            const nav = document.getElementById('bottom-nav');
            const views = [document.getElementById('view-exam-list'), document.getElementById('view-num-grid'), document.getElementById('view-solve')];
            views.forEach(v => v.classList.add('hidden'));
            if(step === 1) { container.classList.remove('wide-mode'); header.classList.add('hidden'); views[0].classList.remove('hidden'); }
            else if(step === 2) { container.classList.remove('wide-mode'); header.classList.remove('hidden'); views[1].classList.remove('hidden'); document.getElementById('grid-title').innerText = EXAM_META[currentExamId].title; }
            else if(step === 3) { container.classList.add('wide-mode'); header.classList.remove('hidden'); views[2].classList.remove('hidden'); }
            lucide.createIcons(); window.scrollTo({ top: 0 });
        };
        lucide.createIcons();
    </script>
</body>
</html>