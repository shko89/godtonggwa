<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>갓통과 관리자 모드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div id="login-container" class="w-full max-w-md bg-gray-800 rounded-3xl p-8 border border-gray-700 shadow-2xl fade-in">
        <div class="text-center mb-8">
            <div class="bg-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-2xl font-bold">관리자 로그인</h1>
            <p class="text-gray-400 text-sm mt-2">시스템 접근 권한이 필요합니다.</p>
        </div>
        
        <form id="admin-login-form" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">이메일</label>
                <input type="email" id="admin-email" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 focus:border-indigo-500 outline-none text-white text-sm" placeholder="admin@example.com" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">비밀번호</label>
                <input type="password" id="admin-pw" class="w-full px-4 py-3 rounded-xl bg-gray-900 border border-gray-700 focus:border-indigo-500 outline-none text-white text-sm" placeholder="비밀번호" required>
            </div>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 transition-colors flex justify-center items-center gap-2">
                <span id="btn-text">로그인</span>
                <div id="btn-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
        </form>
    </div>

    <div id="admin-container" class="w-full max-w-6xl bg-gray-800 rounded-3xl p-8 border border-gray-700 shadow-2xl fade-in hidden space-y-6 my-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="settings" class="w-6 h-6 text-white"></i></div>
                <div>
                    <h1 class="text-2xl font-bold">통합 관리자 모드</h1>
                    <p class="text-xs text-indigo-300 font-medium" id="admin-badge">Admin Access</p>
                </div>
            </div>
            <button onclick="logout()" class="text-xs text-gray-400 hover:text-white underline">로그아웃</button>
        </div>

        <div class="flex space-x-1 bg-gray-900 p-1 rounded-xl overflow-x-auto no-scrollbar">
            <button onclick="switchAdminTab('round')" id="btn-tab-round" class="flex-1 py-2 px-4 rounded-lg text-sm font-bold bg-gray-700 text-white whitespace-nowrap">회차 관리</button>
            <button onclick="switchAdminTab('exam')" id="btn-tab-exam" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-white whitespace-nowrap">모의고사 관리</button>
            <button onclick="switchAdminTab('question')" id="btn-tab-question" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-white whitespace-nowrap">문항 은행</button>
            <button onclick="switchAdminTab('user')" id="btn-tab-user" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-white whitespace-nowrap">사용자 관리</button>
            <button onclick="switchAdminTab('v2')" id="btn-tab-v2" class="flex-1 py-2 px-4 rounded-lg text-sm font-bold text-amber-500 hover:text-amber-400 border border-amber-500/30 whitespace-nowrap">V2 퀴즈DB</button>
        </div>

        <div id="section-round" class="admin-section">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
                <h2 class="text-sm font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="calendar-clock" class="w-4 h-4 text-indigo-400"></i> 회차 진행 관리</h2>
                <div class="flex items-center justify-center gap-1 mb-4">
                    <span id="current-round-display" class="text-5xl font-black text-indigo-400">-</span>
                    <span class="text-lg text-gray-500 font-bold mt-3">회</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="updateRound(-1)" class="bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold text-sm border border-gray-600">-1 회차</button>
                    <button onclick="updateRound(1)" class="bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg">+1 회차</button>
                </div>
            </div>
        </div>

        <div id="section-exam" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="database" class="w-4 h-4 text-emerald-400"></i> 모의고사 목록</h2>
                    <div class="flex gap-2">
                        <button onclick="openExamEditModal()" class="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg font-bold">새 시험 생성</button>
                        <button onclick="loadExamList()" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-lg border border-gray-600">새로고침</button>
                    </div>
                </div>
                <div id="exam-list-container" class="space-y-3 max-h-[500px] overflow-y-auto hide-scrollbar">
                    <p class="text-center text-gray-500 text-sm py-4">데이터를 불러오는 중...</p>
                </div>
            </div>
        </div>

        <div id="section-question" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4 text-purple-400"></i> 문항 은행</h2>
                    <div class="flex gap-2">
                         <button onclick="openQuestionModal()" class="text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded-lg font-bold">새 문항 추가</button>
                         <button onclick="loadQuestionsList()" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-lg border border-gray-600">새로고침</button>
                    </div>
                </div>
                <div id="questions-list-container" class="space-y-3 max-h-[500px] overflow-y-auto hide-scrollbar">
                    <p class="text-center text-gray-500 text-sm py-4">데이터를 불러오는 중...</p>
                </div>
            </div>
        </div>

        <div id="section-user" class="admin-section hidden">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="search-user-input" class="flex-1 px-4 py-2 rounded-lg bg-gray-800 border border-gray-600 text-white text-sm focus:border-blue-500 outline-none" placeholder="이메일 또는 이름 검색">
                    <button onclick="searchUser()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold">검색</button>
                </div>
                <div id="user-manage-panel" class="hidden border-t border-gray-700 pt-4">
                     <div class="flex justify-between items-center mb-4">
                        <div>
                            <p class="text-xs text-gray-400">사용자 정보</p>
                            <p id="manage-user-name" class="font-bold text-lg text-white"></p>
                            <p id="manage-user-email" class="text-xs text-gray-400"></p>
                        </div>
                        <div id="manage-user-status"></div>
                     </div>
                     <div class="flex gap-2 mb-4">
                        <button onclick="updateUserPaidStatus(true)" class="flex-1 bg-indigo-600 text-white text-xs py-2 rounded hover:bg-indigo-500">유료 전환</button>
                        <button onclick="updateUserPaidStatus(false)" class="flex-1 bg-gray-700 text-white text-xs py-2 rounded hover:bg-gray-600">무료 전환</button>
                     </div>
                     <h3 class="text-xs font-bold text-gray-400 mb-2">구매/성적 기록</h3>
                     <div id="user-exam-list" class="space-y-2 max-h-[300px] overflow-y-auto hide-scrollbar mb-4"></div>
                     <div class="pt-4 border-t border-gray-700">
                        <div class="flex gap-2">
                            <input type="text" id="reset-exam-id" class="flex-1 px-3 py-2 rounded bg-gray-800 border border-gray-600 text-xs text-white" placeholder="삭제할 시험 ID (예: exam_01)">
                            <button onclick="resetUserExamData()" class="bg-red-900/50 border border-red-800 text-red-200 px-3 py-2 rounded text-xs hover:bg-red-900">기록 삭제</button>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <div id="section-v2" class="admin-section hidden">
            <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-6 border border-amber-500/30">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5 text-amber-500"></i> V2 문제 관리
                        </h2>
                        <p class="text-xs text-amber-200/60 mt-1">총 <span id="v2-total-count" class="font-bold text-white">0</span>개의 문제가 등록되어 있습니다.</p>
                    </div>
                    <button onclick="openV2EditModal()" class="bg-amber-600 hover:bg-amber-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 shadow-lg">
                        <i data-lucide="plus" class="w-3 h-3"></i> 문제 추가
                    </button>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-2" id="v2-filters">
                    </div>

                <div id="v2-list-container" class="space-y-3 max-h-[600px] overflow-y-auto hide-scrollbar bg-black/20 p-2 rounded-xl border border-white/5">
                    <p class="text-center text-gray-500 text-xs py-10">데이터를 불러오려면 상단 필터를 선택하세요.</p>
                </div>
            </div>
        </div>

    </div>

    <div id="v2-edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[90] hidden p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl p-6 border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">V2 문제 편집</h3>
            <input type="hidden" id="v2-doc-id">
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">단원</label>
                    <select id="v2-unit-id" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-amber-500 outline-none">
                        <option value="unit_01">1. 과학의 기초</option>
                        <option value="unit_02">2. 원소의 형성</option>
                        <option value="unit_03">3. 물질의 구조</option>
                        <option value="unit_04">4. 지구 시스템</option>
                        <option value="unit_05">5. 역학적 시스템</option>
                        <option value="unit_06">6. 생명 시스템</option>
                        <option value="unit_07">7. 지질과 생물</option>
                        <option value="unit_08">8. 화학 변화</option>
                        <option value="unit_09">9. 생태계와 기후</option>
                        <option value="unit_10">10. 에너지</option>
                        <option value="unit_11">11. 과학과 미래</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">문제 (Q)</label>
                    <textarea id="v2-q" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white h-20 focus:border-amber-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">정답 (A)</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="setV2Answer('O')" id="btn-ans-o" class="flex-1 py-2 rounded border border-gray-600 text-gray-400 text-sm hover:bg-gray-700">O</button>
                        <button type="button" onclick="setV2Answer('X')" id="btn-ans-x" class="flex-1 py-2 rounded border border-gray-600 text-gray-400 text-sm hover:bg-gray-700">X</button>
                    </div>
                    <input type="hidden" id="v2-a">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">해설 (Exp)</label>
                    <textarea id="v2-exp" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white h-20 focus:border-amber-500 outline-none"></textarea>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeV2Modal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded text-sm hover:bg-gray-600">취소</button>
                <button onclick="saveV2Question()" class="flex-1 py-2 bg-amber-600 text-white rounded text-sm font-bold hover:bg-amber-500">저장</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden p-4">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl p-6 border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">시험 정보 수정</h3>
            <input type="hidden" id="edit-doc-id">
            <div class="space-y-3">
                <input id="edit-id-input" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="시험 ID (예: exam_01)">
                <input id="edit-title" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="제목">
                <input id="edit-subtitle" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="부제목">
                <input type="number" id="edit-price" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="가격">
                <input type="date" id="edit-date" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white">
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="closeEditModal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded text-sm">취소</button>
                <button onclick="saveExamData()" class="flex-1 py-2 bg-emerald-600 text-white rounded text-sm font-bold">저장</button>
            </div>
        </div>
    </div>

    <div id="question-edit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[70] hidden p-4">
        <div class="bg-gray-800 w-full max-w-lg rounded-2xl p-6 border border-gray-600 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">문항 정보</h3>
            <input type="hidden" id="q-doc-id">
            <div class="space-y-3">
                <input id="q-id" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="문항 ID">
                <div class="grid grid-cols-2 gap-2">
                    <input id="q-domain" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="대단원">
                    <input id="q-chapter" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="중단원">
                </div>
                <input id="q-topic" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="소단원">
                <div class="grid grid-cols-2 gap-2">
                    <input id="q-difficulty" type="number" step="0.1" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="배점">
                    <input id="q-answer" type="number" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="정답">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="closeQuestionModal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded text-sm">취소</button>
                <button onclick="saveQuestionData()" class="flex-1 py-2 bg-purple-600 text-white rounded text-sm font-bold">저장</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, updateDoc, onSnapshot, collection, query, where, getDocs, orderBy, writeBatch, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Init (admin1.html에서 가져온 정상 작동 코드)
        const firebaseConfig = {
            apiKey: "AIzaSyD5axOHuQQ9Y5VmIqvN1AeuVyAVivQlTXs",
            authDomain: "godtonggwa.firebaseapp.com",
            projectId: "godtonggwa",
            storageBucket: "godtonggwa.firebasestorage.app",
            messagingSenderId: "1087434066468",
            appId: "1:1087434066468:web:00a75c9329543afc76e6b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const V2_APP_ID = "godtonggwa_v1";
        let currentRound = 0;
        let unsubscribe = null;
        let searchedUserUid = null;
        let v2CurrentFilter = 'all';

        // 단원명 매핑 (관리자용)
        const UNIT_NAMES = {
            unit_01: '1. 과학의 기초',
            unit_02: '2. 원소의 형성',
            unit_03: '3. 물질의 구조',
            unit_04: '4. 지구 시스템',
            unit_05: '5. 역학적 시스템',
            unit_06: '6. 생명 시스템',
            unit_07: '7. 지질과 생물',
            unit_08: '8. 화학 변화',
            unit_09: '9. 생태계와 기후',
            unit_10: '10. 에너지',
            unit_11: '11. 과학과 미래'
        };

        const TOPIC_MAP = {
            "과학의 기초": ["기본량과 단위", "측정과 어림", "정보와 신호"],
            "물질과 규칙성": ["원소 형성", "별의 진화", "원소의 주기성", "화학 결합", "지각과 생명체 구성 물질의 규칙성"],
            "시스템과 상호작용": ["지구시스템의 구성과 상호작용", "판구조론과 지각 변동", "중력장 내의 운동", "충격량과 운동량", "생명 시스템의 기본 단위", "물질대사", "유전자와 단백질", "물질의 전기적 성질"],
            "변화와 다양성": ["지질시대의 생물과 화석", "지질시대 환경 변화와 대멸종", "자연선택", "생물다양성", "산화와 환원", "중화 반응", "물질 변화에서 에너지 출입"],
            "환경과 에너지": ["생태계 구성 요소", "생태계 평형", "대기와 해양의 상호작용", "온실기체와 지구온난화", "핵융합", "발전", "에너지 전환과 효율"],
            "과학과 미래 사회": ["감염병과 병원체", "인공지능과 과학 탐구", "로봇", "과학기술과 윤리"]
        };

        // 1. 인증 로직 (수정: DB체크 없이 로그인만 되면 통과)
        onAuthStateChanged(auth, async (user) => {
            const loginEl = document.getElementById('login-container');
            const adminEl = document.getElementById('admin-container');
            
            if (user) {
                // 로그인 성공 시 바로 관리자 패널 표시
                loginEl.classList.add('hidden');
                adminEl.classList.remove('hidden');
                document.getElementById('admin-badge').innerText = user.email;
                
                // 초기화
                initAdminListener();
                window.loadExamList();
                createV2Filters();
                
            } else {
                loginEl.classList.remove('hidden');
                adminEl.classList.add('hidden');
                if(unsubscribe) unsubscribe();
            }
        });

        function initAdminListener() {
            unsubscribe = onSnapshot(doc(db, "settings", "global"), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentRound = docSnapshot.data().latestRound || 0;
                    document.getElementById('current-round-display').innerText = currentRound;
                }
            });
        }

        window.switchAdminTab = (tabName) => {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            
            // 버튼 스타일 업데이트
            ['round', 'exam', 'question', 'user', 'v2'].forEach(t => {
                const btn = document.getElementById(`btn-tab-${t}`);
                if(t === tabName) {
                     if(t === 'v2') btn.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-amber-600 text-white border border-amber-600";
                     else btn.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-gray-700 text-white shadow";
                } else {
                     if(t === 'v2') btn.className = "flex-1 py-2 rounded-lg text-sm font-bold text-amber-500 border border-amber-500/30";
                     else btn.className = "flex-1 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white";
                }
            });
            
            // 탭별 데이터 로드
            if(tabName === 'exam') window.loadExamList();
            if(tabName === 'question') window.loadQuestionsList();
            if(tabName === 'v2') window.loadV2Questions(v2CurrentFilter);
        };

        // --- V2 관리 로직 (CRUD) ---
        function createV2Filters() {
            const container = document.getElementById('v2-filters');
            if(!container) return;
            let html = `<button onclick="loadV2Questions('all')" class="v2-filter-btn px-3 py-1.5 rounded-lg text-xs font-bold bg-amber-600 text-white whitespace-nowrap">전체</button>`;
            for(let i=1; i<=11; i++) {
                const id = `unit_${String(i).padStart(2,'0')}`;
                html += `<button onclick="loadV2Questions('${id}')" class="v2-filter-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 text-gray-400 border border-gray-700 whitespace-nowrap">${i}단원</button>`;
            }
            container.innerHTML = html;
        }

        window.loadV2Questions = async (filter) => {
            v2CurrentFilter = filter;
            const container = document.getElementById('v2-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 text-xs py-10">로딩 중...</p>';
            
            // 버튼 스타일 업데이트
            document.querySelectorAll('.v2-filter-btn').forEach(btn => {
                const isAll = filter === 'all' && btn.innerText === '전체';
                const isUnit = filter !== 'all' && btn.getAttribute('onclick').includes(filter);
                
                if(isAll || isUnit) {
                    btn.classList.remove('bg-gray-800', 'text-gray-400');
                    btn.classList.add('bg-amber-600', 'text-white', 'border-amber-600');
                } else {
                    btn.classList.add('bg-gray-800', 'text-gray-400');
                    btn.classList.remove('bg-amber-600', 'text-white', 'border-amber-600');
                }
            });

            try {
                const colRef = collection(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems');
                let q = filter === 'all' 
                    ? query(colRef, orderBy('createdAt', 'desc'), limit(100))
                    : query(colRef, where('unitId', '==', filter));
                
                const snapshot = await getDocs(q);
                document.getElementById('v2-total-count').innerText = snapshot.size;

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500 text-xs py-10">문제 없음</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const color = d.a === 'O' ? 'text-blue-400' : 'text-red-400';
                    // [수정] 단원명 매핑 사용
                    const unitLabel = UNIT_NAMES[d.unitId] || d.unitId;
                    
                    html += `
                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-amber-500/50 transition-colors group">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded font-mono">${unitLabel}</span>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openV2EditModal('${doc.id}')" class="text-gray-400 hover:text-white"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="deleteV2Question('${doc.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <p class="text-sm font-bold text-white mb-2">${d.q}</p>
                            <div class="flex gap-4 text-xs text-gray-400">
                                <span class="font-bold ${color}">정답: ${d.a}</span>
                                <span class="truncate max-w-[200px]">${d.exp || ''}</span>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
                lucide.createIcons();

            } catch(e) { container.innerHTML = '로드 실패'; console.error(e); }
        };

        window.openV2EditModal = async (docId = null) => {
            const modal = document.getElementById('v2-edit-modal');
            modal.classList.remove('hidden');
            document.getElementById('v2-doc-id').value = docId || '';
            // 초기화
            document.getElementById('v2-q').value = '';
            document.getElementById('v2-exp').value = '';
            window.setV2Answer('O');
            
            // 필터된 단원 자동 선택
            if(v2CurrentFilter !== 'all') document.getElementById('v2-unit-id').value = v2CurrentFilter;

            if(docId) {
                try {
                    const docSnap = await getDoc(doc(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems', docId));
                    if(docSnap.exists()) {
                        const d = docSnap.data();
                        document.getElementById('v2-unit-id').value = d.unitId;
                        document.getElementById('v2-q').value = d.q;
                        document.getElementById('v2-exp').value = d.exp;
                        window.setV2Answer(d.a);
                    }
                } catch(e) { alert("로드 실패"); }
            }
        };

        window.closeV2Modal = () => document.getElementById('v2-edit-modal').classList.add('hidden');

        window.setV2Answer = (ans) => {
            document.getElementById('v2-a').value = ans;
            const oBtn = document.getElementById('btn-ans-o');
            const xBtn = document.getElementById('btn-ans-x');
            if(ans === 'O') {
                oBtn.className = "flex-1 py-2 rounded border border-blue-600 bg-blue-600 text-white font-bold";
                xBtn.className = "flex-1 py-2 rounded border border-gray-600 text-gray-400";
            } else {
                oBtn.className = "flex-1 py-2 rounded border border-gray-600 text-gray-400";
                xBtn.className = "flex-1 py-2 rounded border border-red-600 bg-red-600 text-white font-bold";
            }
        };

        window.saveV2Question = async () => {
            const docId = document.getElementById('v2-doc-id').value;
            const unitId = document.getElementById('v2-unit-id').value;
            const q = document.getElementById('v2-q').value;
            const a = document.getElementById('v2-a').value;
            const exp = document.getElementById('v2-exp').value;
            
            const colRef = collection(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems');
            const data = { unitId, q, a, exp, type: 'OX', createdAt: new Date().toISOString() };

            try {
                if(docId) await updateDoc(doc(colRef, docId), data);
                else await addDoc(colRef, data);
                
                alert("저장됨");
                window.closeV2Modal();
                window.loadV2Questions(v2CurrentFilter);
            } catch(e) { alert("저장 실패"); }
        };

        window.deleteV2Question = async (id) => {
            if(!confirm("삭제?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', V2_APP_ID, 'public', 'data', 'quiz_problems', id));
                window.loadV2Questions(v2CurrentFilter);
            } catch(e) { alert("삭제 실패"); }
        };

        // --- 기존 기능 (Exam, User) ---
        window.loadExamList = async () => {
             const container = document.getElementById('exam-list-container');
             container.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">로딩 중...</p>';
             try {
                 const q = query(collection(db, "public_exams"), orderBy("id", "asc"));
                 const snapshot = await getDocs(q);
                 if (snapshot.empty) { container.innerHTML = '<p class="text-center text-gray-500 text-xs">데이터가 없습니다.</p>'; return; }
                 let html = '';
                 snapshot.forEach(doc => {
                     const data = doc.data();
                     html += `<div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center mb-2"><div><span class="text-xs text-emerald-400 font-bold">#${data.id}</span><span class="text-sm font-bold text-white ml-2">${data.title}</span></div><button onclick="openExamEditModal('${doc.id}')" class="p-2 bg-gray-700 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4 text-gray-300"></i></button></div>`;
                 });
                 container.innerHTML = html;
                 lucide.createIcons();
             } catch (e) { container.innerHTML = '오류'; }
        };

        window.openExamEditModal = async (docId) => {
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-doc-id').value = docId || '';
            if(docId) {
                const snap = await getDoc(doc(db, "public_exams", docId));
                if(snap.exists()) {
                    const d = snap.data();
                    document.getElementById('edit-title').value = d.title;
                    document.getElementById('edit-subtitle').value = d.subTitle || '';
                    document.getElementById('edit-price').value = d.price || 0;
                    document.getElementById('edit-id-input').value = docId;
                }
            } else {
                 document.getElementById('edit-id-input').value = '';
                 document.getElementById('edit-title').value = '';
            }
        };
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
        
        window.saveExamData = async () => {
             const id = document.getElementById('edit-doc-id').value || document.getElementById('edit-id-input').value;
             const title = document.getElementById('edit-title').value;
             const sub = document.getElementById('edit-subtitle').value;
             const price = Number(document.getElementById('edit-price').value);
             const date = document.getElementById('edit-date').value;
             
             await setDoc(doc(db, "public_exams", id), { title, subTitle: sub, price, date: date ? new Date(date).toISOString() : null }, { merge: true });
             alert("저장됨");
             window.closeEditModal();
             window.loadExamList();
        };

        window.loadQuestionsList = async () => {
            const container = document.getElementById('questions-list-container');
            container.innerHTML = '로딩...';
            try {
                const q = query(collection(db, "questions"), limit(20));
                const snap = await getDocs(q);
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="bg-gray-800 p-2 rounded border border-gray-700 text-xs text-white mb-2 flex justify-between"><span>${doc.id}</span><span>정답: ${d.correctAnswer}</span></div>`;
                });
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '오류'; }
        };
        
        window.openQuestionModal = () => document.getElementById('question-edit-modal').classList.remove('hidden');
        window.closeQuestionModal = () => document.getElementById('question-edit-modal').classList.add('hidden');
        window.saveQuestionData = async () => {
             const id = document.getElementById('q-id').value;
             // 간단 저장 로직
             await setDoc(doc(db, "questions", id), { 
                 id, 
                 correctAnswer: Number(document.getElementById('q-answer').value),
                 difficulty: Number(document.getElementById('q-difficulty').value),
                 taxonomy: { domain: document.getElementById('q-domain').value, chapter: document.getElementById('q-chapter').value, topic: document.getElementById('q-topic').value }
             }, { merge: true });
             alert("저장됨"); window.closeQuestionModal(); window.loadQuestionsList();
        };

        window.searchUser = async () => {
            const val = document.getElementById('search-user-input').value;
            if(!val) return alert("입력하세요");
            const q = query(collection(db, "users"), where("email", "==", val));
            const snap = await getDocs(q);
            if(snap.empty) return alert("없음");
            const d = snap.docs[0].data();
            searchedUserUid = snap.docs[0].id;
            
            document.getElementById('user-manage-panel').classList.remove('hidden');
            document.getElementById('manage-user-name').innerText = d.name;
            document.getElementById('manage-user-email').innerText = d.email;
            window.loadUserExamList(searchedUserUid);
        };

        window.loadUserExamList = async (uid) => {
            const c = document.getElementById('user-exam-list');
            const s = await getDocs(collection(db, "users", uid, "my_exams"));
            let h = '';
            s.forEach(d => h+=`<div class="text-xs text-gray-400 bg-gray-800 p-2 rounded mb-1">${d.data().title} - ${d.data().status}</div>`);
            c.innerHTML = h || '기록 없음';
        };

        window.updateUserPaidStatus = async (isPaid) => {
            if(!searchedUserUid) return;
            await updateDoc(doc(db, "users", searchedUserUid), { isPaid });
            alert("변경됨");
        };
        
        window.resetUserExamData = async () => {
             const tid = document.getElementById('reset-exam-id').value;
             if(!tid || !searchedUserUid) return;
             const batch = writeBatch(db);
             batch.delete(doc(db, "users", searchedUserUid, "my_exams", tid));
             batch.delete(doc(db, "users", searchedUserUid, "exam_results", tid));
             await batch.commit();
             alert("삭제됨");
             window.loadUserExamList(searchedUserUid);
        };

        // 로그인
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const pw = document.getElementById('admin-pw').value;
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            
            btnText.innerText = "확인 중..."; 
            btnSpinner.classList.remove('hidden');

            try { 
                await signInWithEmailAndPassword(auth, email, pw); 
            } catch(e) { 
                alert("로그인 실패: 이메일이나 비밀번호를 확인해주세요."); 
                btnText.innerText = "로그인";
                btnSpinner.classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);
        window.forceLogout = () => signOut(auth);
        window.updateRound = async (delta) => {
            if(!currentRound) currentRound = 1;
            const newVal = currentRound + delta;
            await setDoc(doc(db, "settings", "global"), { latestRound: newVal }, { merge: true });
        };

        lucide.createIcons();
    </script>
</body>
</html>